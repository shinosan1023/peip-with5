<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;margin:0;background:#f7faf9;color:#222}
  header{background:#fff;border-bottom:1px solid #eee;padding:14px 16px;display:flex;gap:10px;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:18px;color:#333}
  main{max-width:980px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #eee;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit}
  input{border:1px solid #ddd;border-radius:8px;padding:8px}
  button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#007bff;color:#fff}
  button.secondary{background:#6c757d} button.warn{background:#ff9800} button.danger{background:#dc3545}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0}
  .muted{color:#666;font-size:12px}
  .big{font-size:22px;font-weight:800;text-align:center;margin:10px 0}
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
  .ans{padding:16px;border-radius:12px;color:#fff;font-weight:800;text-align:center;cursor:pointer}
  .disabled{opacity:.5;pointer-events:none}
  .score{font-weight:bold}
  .you{color:#007bff} .host{color:#d35400}
  .timer{font-weight:900;color:#d32f2f}
  .rankLine{font-size:14px;color:#333}
  .c-red{background:#e74c3c;color:#fff}.c-blue{background:#3498db;color:#fff}.c-yellow{background:#ffca28;color:#222}.c-green{background:#2ecc71;color:#fff}.c-orange{background:#ff7f50;color:#222}
  .P{background:#e74c3c}.E{background:#3498db}.I{background:#f1c40f;color:#222}.Ph{background:#2ecc71}
  /* 参加ボタンはピンク */
  #joinBtn{background:#ff69b4}
</style>
</head>
<body>
<header>
  <h1>P.E.I.P. 早押しクイズ</h1>
  <div class="muted">最大5人｜早押しは<b>先着1名のみ有効</b>｜各問題5秒｜40問</div>
</header>
<main>

  <!-- 参加：名前＋一言（15文字）＋ホスト／観客 -->
  <section id="joinCard" class="card">
    <h3 style="margin:0 0 8px">① 参加登録</h3>
    <div class="row">
      <input id="nameInput" placeholder="名前（表示名）" />
      <input id="commentInput" placeholder="一言（15文字まで）" maxlength="15" />
      <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck" />ホストになる</label>
      <label class="row" style="gap:6px"><input type="checkbox" id="spectatorCheck" />観客として入る（閲覧のみ）</label>
      <button id="joinBtn">参加する</button>
    </div>
    <div class="muted" style="margin-top:6px">※ 最初に入る方がホストだと進行がスムーズです</div>
    <div class="muted" style="margin-top:6px">参加上限：<b>5名</b>　
      現在：<b id="currentPlayers">0</b>　
      残り：<b id="remainPlayers">あと5名</b>　
      受付：<b id="entryState">開放中</b>
    </div>
  </section>

  <!-- ルーム情報：参加者/状態/残時間/自分の順位 -->
  <section id="roomCard" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <span>ルーム：</span><span id="roomId" class="pill"></span>
        <span class="muted">状態：</span><span id="statePill" class="pill">-</span>
        <span class="muted">残り：</span><span id="timeLeft" class="timer">--</span>
        <span class="muted">あなたの順位：</span><span id="myRank" class="pill">--位</span>
      </div>
      <div id="hostTools" style="display:none" class="row">
        <button id="startRoundBtn" class="warn">ラウンド開始</button>
        <button id="lockBtnHost" class="secondary" title="受付を即時終了">締め切る</button>
        <button id="nextBtn" class="secondary">次の問題</button>
        <button id="endBtn" class="danger">終了</button>
      </div>
    </div>
    <div style="margin-top:10px">
      <strong>参加者（最大5人）</strong>
      <div id="playersList" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
    </div>
  </section>

  <!-- 問題エリア -->
  <section id="qCard" class="card" style="display:none">
    <div id="qIdx" class="muted"></div>
    <div id="qText" class="big">問題</div>
    <div id="buzzInfo" class="muted">ホストが「ラウンド開始」を押すと早押し受付が始まります。</div>

    <div id="answers" class="answer-grid" style="margin-top:4px">
      <div class="ans P"  data-choice="P">きもち（P）</div>
      <div class="ans E"  data-choice="E">まわり（E）</div>
      <div class="ans I"  data-choice="I">できること（I）</div>
      <div class="ans Ph" data-choice="Ph">からだ＆病気（Ph）</div>
    </div>

    <!-- 参加者側の締め切り（観客以外に表示） -->
    <div class="row" style="margin-top:10px">
      <button id="lockBtnUser" class="secondary" style="display:none" title="受付を即時終了">締め切る</button>
    </div>
  </section>

  <section class="card">
    <strong>遊び方：</strong>
    <ol style="margin:8px 0 0 16px">
      <li>全員が「参加する」で入室（最大5人）。参加者は <b>赤・青・黄・緑・オレンジ</b> の色割当。</li>
      <li>ホストが「ラウンド開始」→問題表示→<b>5秒</b>間の早押し受付（カウントダウン音あり）。</li>
      <li>先着1名のみ有効。<b>正解+2点／不正解-2点</b>。ホストが「次の問題」で進行。</li>
      <li>参加者も任意のタイミングで<b>受付を締め切る</b>ことができます（観客は不可）。</li>
      <li>あなたの順位は随時表示されます。</li>
    </ol>
  </section>

  <section class="card">
    <div class="muted">
      ※P.E.I.P.は聖隷クリストファー大学の篠﨑良勝氏が介護過程教育の質向上のために作成した教材で、著作権は篠﨑良勝氏にあります。P.E.I.P.フレームワークで分類する場合は、必ずP.E.I.P.を学習した上で行ってください。
    </div>
  </section>

</main>

<!-- 効果音（index.html と同じフォルダに置く） -->
<audio id="sndStart"     src="start.mp3"     preload="auto"></audio>
<audio id="sndAlert"     src="keikoku.mp3"   preload="auto"></audio>
<audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
<audio id="sndCorrect"   src="se_correct.mp3" preload="auto"></audio>
<audio id="sndWrong"     src="se_wrong.mp3"   preload="auto"></audio>

<!-- Firebase (module, v12) -->
<script type="module">
  /* ===== Firebase SDK（module方式） ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs,
    query, orderBy, onSnapshot, serverTimestamp, increment, runTransaction
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  /* ===== ご指定の peip-with5 の値 ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
    authDomain: "peip-with5.firebaseapp.com",
    projectId: "peip-with5",
    storageBucket: "peip-with5.firebasestorage.app",
    messagingSenderId: "609048243686",
    appId: "1:609048243686:web:a38452d1872d4ec28cba27",
    measurementId: "G-YCB8S47ENW"
  };

  const app = initializeApp(firebaseConfig);
  getAnalytics(app); // （使わなくてもOK）
  const db = getFirestore(app);

  /* ===== 便利関数 ===== */
  const $ = (id)=>document.getElementById(id);
  const play = (id)=>{ try{ $(id).currentTime=0; $(id).play(); }catch(e){} };
  const esc = (s)=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]));
  const colorOrder = ["c-red","c-blue","c-yellow","c-green","c-orange"];
  const nextColor = (used)=> colorOrder.find(c=>!used.includes(c)) || "c-orange";

  /* ===== 問題プール（ここからランダムに40問） ===== */
  const questionsPool = [
    { text: "子どもに会いたいと思っているか？", answer: "P" },{ text: "洗濯物にしわはないか？", answer: "E" },
    { text: "トイレで立位をとることができるか？", answer: "I" },{ text: "便秘はないか？", answer: "Ph" },
    { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },{ text: "トイレの手すりにぐらつきはないか？", answer: "E" },
    { text: "歯磨きは一人で行えているか？", answer: "I" },{ text: "むせこみはないか？", answer: "Ph" },
    { text: "デイサービスを楽しみにしているか？", answer: "P" },{ text: "冷蔵庫に消費期限が過ぎた食品はないか？", answer: "E" },
    { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },{ text: "足にむくみはないか？", answer: "Ph" },
    { text: "好きな音楽（曲・歌手）は何か？", answer: "P" },{ text: "洗面所の床は濡れていないか？", answer: "E" },
    { text: "トイレのボタンを操作することはできるか？", answer: "I" },{ text: "肌は乾燥していないか？", answer: "Ph" },
    { text: "暮らしで困っていることはないか？", answer: "P" },{ text: "息苦しさや胸の圧迫感はないか？", answer: "Ph" },
    { text: "着替えは介助なしでできるか？", answer: "I" },{ text: "食欲や水分摂取量はどうか？", answer: "Ph" },
    { text: "昔していた仕事は何か？", answer: "P" },{ text: "使用している福祉用具は何か？", answer: "E" },
    { text: "電話をかけることができるか？", answer: "I" },{ text: "視力はどの程度か？", answer: "Ph" },
    { text: "食べたいものはあるか？", answer: "P" },{ text: "自宅で10ミリ以上の段差はないか？", answer: "E" },
    { text: "お茶を入れて飲むことはできるか？", answer: "I" },{ text: "夜間の睡眠状況はどうか？", answer: "Ph" },
    { text: "習慣となっていることは何か？", answer: "P" },{ text: "利用している介護サービスは何か？", answer: "E" },
    { text: "体操で体を動かせているか？", answer: "I" },{ text: "ふらつきはないか？", answer: "Ph" },
    { text: "趣味を再開したい思いはあるか？", answer: "P" },{ text: "居室の温度・室温は？", answer: "E" },
    { text: "食事の準備は一人でできるか？", answer: "I" },{ text: "腰痛など体の痛みはないか？", answer: "Ph" },
    { text: "調味料にこだわりはあるか？", answer: "P" },{ text: "薬の管理で手伝ってほしいことはあるか？", answer: "P" },
    { text: "薬の管理は一人で行えているか？", answer: "I" },{ text: "まぶたに目やにはついていないか？", answer: "Ph" },
    { text: "どのような環境で寝たい思っているか？", answer: "P" },{ text: "コールのボタンは鳴るか？", answer: "E" },
    { text: "座位をとることはできているか？", answer: "I" },{ text: "巻き爪はないか？", answer: "Ph" },
    { text: "何をしている時が幸せを感じる時か？", answer: "P" },{ text: "現在、交流のある人は誰か？", answer: "E" },
    { text: "買い物リストを書くことはできるか？", answer: "I" },{ text: "夜間に不眠はないか？", answer: "Ph" },
    { text: "お気に入りの服はあるか？", answer: "P" },{ text: "居室の換気状況は？", answer: "E" }
  ];

  /* ===== ルーム・参照 ===== */
  const roomId = "default";
  const roomRef = doc(db, "rooms", roomId);
  const playersRef = collection(roomRef, "players");

  /* ===== 要素 ===== */
  const joinCard = $("joinCard");
  const roomCard = $("roomCard");
  const qCard    = $("qCard");
  const statePill= $("statePill");
  const myRankEl = $("myRank");
  const timeLeftEl=$("timeLeft");
  const playersList=$("playersList");
  const qText=$("qText");
  const qIdxEl=$("qIdx");
  const buzzInfo=$("buzzInfo");
  const entryStateEl=$("entryState");
  const currentPlayersEl=$("currentPlayers");
  const remainPlayersEl=$("remainPlayers");
  const spectatorCheck=$("spectatorCheck");

  $("roomId").textContent = roomId;

  /* ===== 自分の情報 ===== */
  function uid(){ const k="peip-uid"; let v=localStorage.getItem(k); if(!v){ v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
  let me = { id: uid(), name:"", comment:"", isHost:false, score:0, color:"", spectator:false };

  /* ===== ルーム初期化 ===== */
  async function ensureRoom(){
    const s = await getDoc(roomRef);
    if(!s.exists()){
      await setDoc(roomRef, {
        state:"lobby", currentIndex:0, deck:[],
        buzzedBy:null, answerChoice:null, openUntilMs:0,
        lastResult:null, resultKey:"",
        entryOpen:true, // 参加受付（表記用）
        createdAt: serverTimestamp()
      });
    }
  }
  await ensureRoom();

  /* ===== 参加ボタン ===== */
  $("joinBtn").onclick = async ()=>{
    const name = ($("nameInput").value||"").trim();
    const comment = ($("commentInput").value||"").trim().slice(0,15);
    const isHost = $("hostCheck").checked;
    const spectator = spectatorCheck.checked;

    if(!name){
      alert("名前を入力してください");
      play("sndAlert");
      return;
    }

    me = { id: uid(), name, comment, isHost, score:0, color:"", spectator };

    if(!spectator){
      // 5人制限 + 色割当
      const snap = await getDocs(playersRef);
      if(snap.size >= 5){ alert("参加可能人数（5人）に達しています"); return; }
      const used=[]; snap.forEach(d=>{ const x=d.data(); if(x.color) used.push(x.color); });
      me.color = nextColor(used);
      await setDoc(doc(playersRef, me.id), {
        name, comment, score:0, isHost, color:me.color,
        joinedAt: serverTimestamp(), lastSeen: serverTimestamp()
      }, { merge:true });
    }

    joinCard.style.display="none";
    roomCard.style.display="block";
    play("sndStart");
  };

  /* ===== 途中退出の自動削除（ハートビート） ===== */
  let hbTimer=null, cleanTimer=null;
  function startHeartbeat(){
    if(me.spectator) return;
    if(hbTimer) clearInterval(hbTimer);
    hbTimer = setInterval(async ()=>{
      try{ await setDoc(doc(playersRef, me.id), { lastSeen: serverTimestamp() }, { merge:true }); }catch(e){}
    }, 20000);
    // ホストは60秒以上応答なしを削除
    if(me.isHost){
      if(cleanTimer) clearInterval(cleanTimer);
      cleanTimer = setInterval(async ()=>{
        const s = await getDocs(playersRef);
        const now = Date.now();
        for(const d of s.docs){
          const x=d.data();
          const ms = x.lastSeen?.toMillis?.() || 0;
          if(now - ms > 60000){
            try{ await updateDoc(doc(playersRef, d.id), {}); }catch(_){}
            try{ await setDoc(doc(playersRef, d.id), {}, { merge:false }); }catch(_){}
          }
        }
      }, 30000);
    }
  }
  window.addEventListener("beforeunload", async ()=>{
    if(!me.spectator){ try{ await setDoc(doc(playersRef, me.id), {}, { merge:false }); }catch(_){ } }
  });

  /* ===== 参加者購読（人数・順位・一覧） ===== */
  let playersCache=[];
  onSnapshot(query(playersRef, orderBy("joinedAt","asc")), snap=>{
    const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() })); playersCache=arr;

    currentPlayersEl.textContent = String(arr.length);
    remainPlayersEl.textContent = `あと${Math.max(0, 5-arr.length)}名`;

    if(arr.find(p=>p.id===me.id) || me.spectator){ joinCard.style.display="none"; roomCard.style.display="block"; }

    // 順位：スコア降順
    const sorted=[...arr].sort((a,b)=> (b.score||0)-(a.score||0) );
    const idx=sorted.findIndex(p=>p.id===me.id);
    myRankEl.textContent = (idx>=0)? `${idx+1}位` : (me.spectator?"観客":"--位");

    // 一覧表示
    playersList.innerHTML = arr.map(p=>{
      const you = p.id===me.id?'<span class="you">[you]</span>':'';
      const host= p.isHost?'<span class="host">[host]</span>':'';
      return `<div class="pill ${esc(p.color||'')}" title="${esc(p.comment||'')}">${esc(p.name)} ${you} ${host} <span class="score">${Number(p.score||0)}pt</span></div>`;
    }).join("");

    startHeartbeat();
  });

  /* ===== ルーム購読（状態/問題/タイマー/音） ===== */
  let countdownTimer=null;
  let lastCountdownKey=""; // currentIndex|openUntilMs
  let lastResultKey="";    // resultKey

  function startCountdownLoop(untilMs){
    if(countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(async ()=>{
      const ms=Math.max(0, untilMs - Date.now());
      timeLeftEl.textContent=(ms/1000).toFixed(1)+"s";
      if(ms<=0){
        clearInterval(countdownTimer);
        timeLeftEl.textContent="0.0s";
        // ホストは自動でlockedへ
        if(me.isHost){
          const s=await getDoc(roomRef);
          if(s.exists() && s.data().state==="open"){
            await updateDoc(roomRef,{ state:"locked" });
          }
        }
      }
    },100);
  }

  onSnapshot(roomRef, async (snap)=>{
    if(!snap.exists()) return;
    const r=snap.data();
    statePill.textContent=r.state;
    entryStateEl.textContent = r.entryOpen ? "開放中" : "締め切り";
    // デッキが無ければホストが作る（40問）
    if(me.isHost && (!r.deck || !Array.isArray(r.deck) || r.deck.length===0)){
      const idxs=[...Array(questionsPool.length).keys()].sort(()=>Math.random()-0.5);
      const deck=idxs.slice(0, Math.min(40, idxs.length));
      await updateDoc(roomRef,{ deck, currentIndex:0 });
      return;
    }
    const deck=r.deck||[];
    const total = deck.length>0 ? deck.length : 40;
    const idx=Math.max(0, Math.min(total-1, r.currentIndex||0));
    const q = deck.length>0 ? questionsPool[ deck[idx] ] : questionsPool[idx];
    qIdxEl.textContent = `問題 ${idx+1} / ${total}`;
    qText.textContent  = "「" + q.text + "」";

    // 受付中フラグで締め切りボタンの表示制御
    $("lockBtnUser").style.display = (!me.spectator && r.state==="open") ? "inline-block" : "none";
    $("lockBtnHost").style.display = (me.isHost && r.state==="open") ? "inline-block" : "none";
    $("hostTools").style.display = me.isHost ? "flex" : "none";
    qCard.style.display = (r.state==="lobby" || r.state==="ended") ? "none" : "block";

    if(r.state==="open"){
      const key=`${r.currentIndex}|${r.openUntilMs}`;
      if(key!==lastCountdownKey){
        lastCountdownKey=key;
        play("sndCountdown");
      }
      buzzInfo.textContent="早押し受付中！（5秒）先に押した1名だけ有効です。";
      setAnswersDisabled(!!me.spectator);
      startCountdownLoop(r.openUntilMs||0);
    }else if(r.state==="locked"){
      setAnswersDisabled(true);
      if(r.resultKey && r.resultKey!==lastResultKey){
        lastResultKey=r.resultKey;
        if(r.lastResult==="correct") play("sndCorrect");
        else if(r.lastResult==="wrong") play("sndWrong");
      }
      if(r.buzzedBy){
        const p=playersCache.find(x=>x.id===r.buzzedBy);
        const who=p?p.name:`ID:${r.buzzedBy}`;
        buzzInfo.textContent=`【${who}】が先に押しました。判定済み／次の問題へ`;
      }else{
        buzzInfo.textContent="時間切れ。次の問題へ。";
      }
    }else{
      setAnswersDisabled(true);
      buzzInfo.textContent="ホストが「ラウンド開始」を押すと早押し受付が始まります。";
    }
  });

  function setAnswersDisabled(flag){
    document.querySelectorAll(".ans").forEach(b=>{
      if(flag) b.classList.add("disabled"); else b.classList.remove("disabled");
    });
  }

  /* ===== 回答（先着1名：正解+2／不正解-2） ===== */
  document.querySelectorAll(".ans").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      if(me.spectator) return;
      const choice=btn.dataset.choice;

      let winner=false;
      await runTransaction(db, async (tx)=>{
        const s = await tx.get(roomRef);
        if(!s.exists()) return;
        const r=s.data();
        if(r.state!=="open") return;
        if((r.openUntilMs||0) < Date.now()) return;
        if(r.buzzedBy) return;
        winner=true;
        tx.update(roomRef,{ state:"locked", buzzedBy: me.id, answerChoice: choice });
      });

      if(me.isHost && winner){
        const s = await getDoc(roomRef);
        const r = s.data();
        const deck=r.deck||[];
        const total=deck.length>0 ? deck.length : 40;
        const idx=Math.max(0, Math.min(total-1, r.currentIndex||0));
        const q = deck.length>0 ? questionsPool[ deck[idx] ] : questionsPool[idx];
        const ok=(r.answerChoice===q.answer);
        const delta= ok ? +2 : -2;
        const nextKey=`${Date.now()}_${ok?'C':'W'}`;
        await Promise.all([
          updateDoc(doc(playersRef, r.buzzedBy), { score: increment(delta) }),
          updateDoc(roomRef,{ lastResult: ok?"correct":"wrong", resultKey: nextKey })
        ]);
      }
    });
  });

  /* ===== ホスト／参加者 操作 ===== */
  $("startRoundBtn").onclick = async ()=>{
    if(!me.isHost) return;
    // deckがなければ作成（念のため）
    const s = await getDoc(roomRef);
    const r = s.data()||{};
    if(!r.deck || !Array.isArray(r.deck) || r.deck.length===0){
      const idxs=[...Array(questionsPool.length).keys()].sort(()=>Math.random()-0.5);
      const deck=idxs.slice(0, Math.min(40, idxs.length));
      await setDoc(roomRef,{ deck, currentIndex:0 }, { merge:true });
    }
    await updateDoc(roomRef,{
      state:"open", buzzedBy:null, answerChoice:null, lastResult:null, resultKey:"",
      openUntilMs: Date.now()+5000
    });
  };

  // 締め切る（ホスト）
  $("lockBtnHost").onclick = async ()=>{
    if(!me.isHost) return;
    await updateDoc(roomRef,{ state:"locked" });
    play("sndStart");
  };
  // 締め切る（参加者）
  $("lockBtnUser").onclick = async ()=>{
    if(me.spectator) return;
    await updateDoc(roomRef,{ state:"locked" });
    play("sndStart");
  };

  $("nextBtn").onclick = async ()=>{
    if(!me.isHost) return;
    const s = await getDoc(roomRef);
    const r = s.data()||{};
    const deck=r.deck||[];
    const total=deck.length>0 ? deck.length : 40;
    const next=((r.currentIndex||0)+1)%total;
    await updateDoc(roomRef,{
      state:"open", buzzedBy:null, answerChoice:null, lastResult:null, resultKey:"",
      currentIndex: next, openUntilMs: Date.now()+5000
    });
  };

  $("endBtn").onclick = async ()=>{
    if(!me.isHost) return;
    await updateDoc(roomRef,{ state:"ended" });
  };

</script>
</body>
</html>
