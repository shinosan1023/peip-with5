<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<style>
  :root{
    --bg:#f7faf9; --card:#fff; --muted:#666; --pill:#f0f3f5; --brand:#ff7f50;
    --red:#e74c3c; --blue:#3498db; --yellow:#ffca28; --green:#2ecc71;
  }
  body{margin:0;background:var(--bg);color:#222;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:3}
  main{max-width:1000px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;padding:14px;box-shadow:0 6px 14px rgba(0,0,0,.04);margin-bottom:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);border-radius:999px;padding:4px 10px;font-size:13px}
  .muted{color:var(--muted);font-size:12px}
  input,select,button,textarea{font:inherit}
  input,select,textarea{border:1px solid #ddd;border-radius:8px;padding:8px}
  button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#007bff;color:#fff}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#e9eef3;color:#333}
  .btn-warn{background:#ff9800}
  .btn-danger{background:#dc3545}
  .btn-green{background:#28a745}
  .right{margin-left:auto}
  .you{font-weight:700;color:#000}
  .host{font-weight:700;color:#000}
  .num{font-weight:800}
  /* 回答ボタン（丸） */
  .ans-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;place-items:center;margin:10px auto}
  .ans{width:170px;height:170px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:20px;box-shadow:0 10px 24px rgba(0,0,0,.12),inset 0 2px 0 rgba(255,255,255,.5)}
  .ans.red{background:var(--red)} .ans.blue{background:var(--blue)} .ans.yellow{background:var(--yellow);color:#222} .ans.green{background:var(--green)}
  .ans.disabled{opacity:.45;pointer-events:none}
  .q{font-size:24px;font-weight:800;text-align:center;margin:10px 0 4px}
  .badge{background:#fff3cd;border:1px solid #ffe69c;border-radius:8px;padding:2px 8px}
  /* カウントダウンオーバーレイ */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;color:#fff;z-index:10}
  #overlay h1{font-size:120px;font-weight:900;margin:0;text-shadow:0 10px 35px rgba(0,0,0,.6)}
  /* 観戦ボックス */
  .cheerbox{display:grid;grid-template-columns:180px 1fr auto auto;gap:8px}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>P.E.I.P. 早押しクイズ</strong>
    <label class="pill"><input id="soundToggle" type="checkbox" checked /> 音声: <span id="soundState">ON</span></label>
  </div>
  <button id="leaveBtn" class="btn-ghost">退出する</button>
</header>

<main>
  <!-- 参加登録 -->
  <section id="joinCard" class="card">
    <h3 style="margin:0 0 8px">① 名前を入力 → ② ルームを選ぶ → <span class="badge">参加 もしくは 観戦</span></h3>
    <div class="row">
      <input id="nameInput" placeholder="名前（表示名）" style="min-width:220px">
      <select id="roomSelect">
        <!-- 15ルーム -->
        <option value="room-01">room-01</option><option value="room-02">room-02</option><option value="room-03">room-03</option>
        <option value="room-04">room-04</option><option value="room-05">room-05</option><option value="room-06">room-06</option>
        <option value="room-07">room-07</option><option value="room-08">room-08</option><option value="room-09">room-09</option>
        <option value="room-10">room-10</option><option value="room-11">room-11</option><option value="room-12">room-12</option>
        <option value="room-13">room-13</option><option value="room-14">room-14</option><option value="room-15">room-15</option>
      </select>
      <label class="pill"><input id="hostCheck" type="checkbox"> ホストになる</label>
      <button id="joinBtn" class="btn-green">参加</button>
      <button id="watchBtn" class="btn-ghost">観戦</button>
      <span class="muted">※「参加」を押した時点で準備OKです</span>
    </div>
  </section>

  <!-- ルーム＆進行 -->
  <section id="roomCard" class="card" style="display:none">
    <div class="row">
      <span class="pill">ルーム：<b id="roomIdText">-</b></span>
      <span class="pill">状態：<b id="stateText">-</b></span>
      <span class="pill">募集終了まで：<b id="recruitLeft">--:--</b></span>
      <span class="pill">残り問題：<b id="remainText">--</b></span>
      <span class="pill">あなたの順位：<b id="myRank">-位</b></span>
      <div class="right row" id="hostTools" style="display:none">
        <button id="recruitBtn" class="btn-warn" title="ホストのみ：押すと60秒の募集を開始">募集開始（60秒）</button>
        <button id="startBtn" class="btn-green" title="ホストのみ：カウントダウンのあと開始">ゲーム開始</button>
        <button id="stopBtn" class="btn-danger" title="ホストのみ：ゲームを終了">中止</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <strong>参加者（最大5人）</strong>
      <div id="playersList" class="row" style="margin-top:6px;flex-wrap:wrap"></div>
      <div class="muted" id="slotInfo" style="margin-top:4px"></div>
    </div>
  </section>

  <!-- 問題エリア -->
  <section id="qCard" class="card" style="display:none">
    <div class="row">
      <span class="pill">問題 <b id="qIdx">-/-</b></span>
      <span class="pill">回答残り：<b id="timeLeft" class="num">0.0s</b></span>
      <span class="pill" id="resultPill" style="display:none"></span>
    </div>
    <div id="qText" class="q">問題がここに表示されます</div>
    <div class="ans-grid">
      <div class="ans red"    id="btnP"  data-choice="P">きもち</div>
      <div class="ans blue"   id="btnE"  data-choice="E">まわり</div>
      <div class="ans yellow" id="btnI"  data-choice="I">できること</div>
      <div class="ans green"  id="btnPh" data-choice="Ph">からだ＆病気</div>
    </div>
  </section>

  <!-- 観戦・応援 -->
  <section id="cheerCard" class="card">
    <div class="row"><span class="pill">観戦・応援</span></div>
    <div class="cheerbox" style="margin-top:8px">
      <input id="cheerName" placeholder="名前（任意）">
      <textarea id="cheerText" rows="2" placeholder="応援コメント（誰でも送信可）"></textarea>
      <button id="cheerSend" class="btn-ghost">送信</button>
      <button id="cheerSound" class="btn-warn" title="何度でも鳴らせます">応援</button>
    </div>
    <div id="cheerLog" class="muted" style="margin-top:6px;white-space:pre-wrap"></div>
  </section>

  <section class="card muted">
    ・URLアクセス → 名前入力 → ルーム選択 → 「参加」または「観戦」 →（ホストがゲーム開始）→ 40問が連続で出題。  
    ・先着1名のみ有効。正解 +2点／不正解 −3点。回答は 8秒、結果は2秒表示して次へ自動進行。  
    ・終了時に順位を集計。音はページと同じフォルダの mp3 を使用します。
  </section>
</main>

<!-- カウントダウン オーバーレイ -->
<div id="overlay"><h1 id="overlayText">3</h1></div>

<!-- 効果音 -->
<audio id="sndCountdown" src="countdown.mp3" preload="auto" playsinline></audio>
<audio id="sndCorrect"   src="se_correct.mp3" preload="auto" playsinline></audio>
<audio id="sndWrong"     src="se_wrong.mp3"   preload="auto" playsinline></audio>
<audio id="sndFinish"    src="gongu.mp3"      preload="auto" playsinline></audio>
<audio id="sndCheer"     src="kansei.mp3"     preload="auto" playsinline></audio>
<audio id="sndJoin"      src="start.mp3"      preload="auto" playsinline></audio>

<!-- Firebase（compat 版） -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
/* ===== Firebase 設定（5人対戦プロジェクト） ===== */
firebase.initializeApp({
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
});
const db = firebase.firestore();

/* ===== ユーティリティ ===== */
const $ = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function esc(s){return String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]))}
const now = ()=>Date.now();

/* ===== 音声 ON/OFF ===== */
let soundEnabled = true;
$("soundToggle").addEventListener("change",()=>{
  soundEnabled = $("soundToggle").checked; $("soundState").textContent = soundEnabled?"ON":"OFF";
  [ "sndCountdown","sndCorrect","sndWrong","sndFinish","sndCheer","sndJoin" ].forEach(id=>{
    const el=$(id); el.muted = !soundEnabled; if(!soundEnabled){ try{el.pause(); el.currentTime=0;}catch(_){}} 
  });
});

/* ===== 質問プール（→40問をランダム抽出） ===== */
const Q = [
  { text: "子どもに会いたいと思っているか？", answer: "P" },{ text: "洗濯物にしわはないか？", answer: "E" },
  { text: "トイレで立位をとることができるか？", answer: "I" },{ text: "便秘はないか？", answer: "Ph" },
  { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },{ text: "トイレの手すりにぐらつきはないか？", answer: "E" },
  { text: "歯磨きは一人で行えているか？", answer: "I" },{ text: "むせこみはないか？", answer: "Ph" },
  { text: "デイサービスを楽しみにしているか？", answer: "P" },{ text: "冷蔵庫に消費期限が過ぎた食品はないか？", answer: "E" },
  { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },{ text: "足にむくみはないか？", answer: "Ph" },
  { text: "好きな音楽（曲・歌手）は何か？", answer: "P" },{ text: "洗面所の床は濡れていないか？", answer: "E" },
  { text: "トイレのボタンを操作することはできるか？", answer: "I" },{ text: "肌は乾燥していないか？", answer: "Ph" },
  { text: "暮らしで困っていることはないか？", answer: "P" },{ text: "息苦しさや胸の圧迫感はないか？", answer: "Ph" },
  { text: "着替えは介助なしでできるか？", answer: "I" },{ text: "食欲や水分摂取量はどうか？", answer: "Ph" },
  { text: "昔していた仕事は何か？", answer: "P" },{ text: "使用している福祉用具は何か？", answer: "E" },
  { text: "電話をかけることができるか？", answer: "I" },{ text: "視力はどの程度か？", answer: "Ph" },
  { text: "食べたいものはあるか？", answer: "P" },{ text: "自宅で10ミリ以上の段差はないか？", answer: "E" },
  { text: "お茶を入れて飲むことはできるか？", answer: "I" },{ text: "夜間の睡眠状況はどうか？", answer: "Ph" },
  { text: "習慣となっていることは何か？", answer: "P" },{ text: "利用している介護サービスは何か？", answer: "E" },
  { text: "体操で体を動かせているか？", answer: "I" },{ text: "ふらつきはないか？", answer: "Ph" },
  { text: "趣味を再開したい思いはあるか？", answer: "P" },{ text: "居室の温度・室温は？", answer: "E" },
  { text: "食事の準備は一人でできるか？", answer: "I" },{ text: "腰痛など体の痛みはないか？", answer: "Ph" },
  { text: "調味料にこだわりはあるか？", answer: "P" },{ text: "薬の管理で手伝ってほしいことはあるか？", answer: "P" },
  { text: "薬の管理は一人で行えているか？", answer: "I" },{ text: "まぶたに目やにはついていないか？", answer: "Ph" },
  { text: "どのような環境で寝たい思っているか？", answer: "P" },{ text: "コールのボタンは鳴るか？", answer: "E" },
  { text: "座位をとることはできているか？", answer: "I" },{ text: "巻き爪はないか？", answer: "Ph" },
  { text: "何をしている時が幸せを感じる時か？", answer: "P" },{ text: "現在、交流のある人は誰か？", answer: "E" },
  { text: "買い物リストを書くことはできるか？", answer: "I" },{ text: "夜間に不眠はないか？", answer: "Ph" },
  { text: "お気に入りの服はあるか？", answer: "P" },{ text: "居室の換気状況は？", answer: "E" }
];
const LABEL = {P:"きもち",E:"まわり",I:"できること",Ph:"からだ＆病気"};

/* ===== 自分 & Firestore 参照 ===== */
const uidKey = "peip-uid";
function getUid(){ let v=localStorage.getItem(uidKey); if(!v){ v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(uidKey,v);} return v; }
let me = { id:getUid(), name:"", isHost:false, spectator:false, roomId:"room-01" };

let roomRef=null, playersRef=null, cheersRef=null;
let unsubRoom=null, unsubPlayers=null, unsubCheers=null;

/* ===== 表示系 ===== */
function showJoin(){ $("joinCard").style.display="block"; $("roomCard").style.display="none"; $("qCard").style.display="none"; $("myRank").textContent="-位"; }
function showRoom(){ $("joinCard").style.display="none"; $("roomCard").style.display="block"; }

/* ===== 参加・観戦 ===== */
$("joinBtn").onclick = async ()=>{
  const name = $("nameInput").value.trim();
  if(!name){ alert("名前を入力してください"); return; }
  me = { id:getUid(), name, isHost:$("hostCheck").checked, spectator:false, roomId:$("roomSelect").value };
  await enterRoom();
  try{ if(soundEnabled){ $("sndJoin").currentTime=0; $("sndJoin").play(); } }catch(_){}
};
$("watchBtn").onclick = async ()=>{
  me = { id:getUid(), name:$("nameInput").value.trim()||"観戦", isHost:false, spectator:true, roomId:$("roomSelect").value };
  await enterRoom();
};
$("leaveBtn").onclick = leaveRoom;

/* ===== ルーム入室/退出 ===== */
async function enterRoom(){
  cleanupSubs();
  roomRef = db.collection("rooms").doc(me.roomId);
  playersRef = roomRef.collection("players");
  cheersRef  = roomRef.collection("cheers");

  // ルームが無ければ初期化
  const snap = await roomRef.get();
  if(!snap.exists){
    await roomRef.set({
      state:"lobby", deck:[], currentIndex:0,
      recruitUntil:0, qOpenAt:0, answerDeadline:0,
      buzzedBy:null, answerChoice:null, lastResult:null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // 参加者として登録（観戦は登録しない）
  if(!me.spectator){
    const cur = await playersRef.get();
    if(cur.size>=5){ alert("このルームは満員（5人）です"); return; }
    await playersRef.doc(me.id).set({
      name: me.name, isHost: !!me.isHost, score:0, correct:0, wrong:0, totalTimeMs:0,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp(), lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }

  $("roomIdText").textContent = me.roomId;
  showRoom();
  subscribeRoom();
}

/* 退出（参加者/観戦者ともOK） */
async function leaveRoom(){
  cleanupSubs();
  if(playersRef && !me.spectator){
    try{ await playersRef.doc(me.id).delete(); }catch(_){}
  }
  me.spectator=false; me.isHost=false;
  showJoin();
}

/* ===== サブスク解除 ===== */
function cleanupSubs(){
  if(unsubRoom){unsubRoom();unsubRoom=null;}
  if(unsubPlayers){unsubPlayers();unsubPlayers=null;}
  if(unsubCheers){unsubCheers();unsubCheers=null;}
}

/* ===== 進行ボタン ===== */
$("recruitBtn").onclick = async ()=>{
  if(!me.isHost){ return; }
  await roomRef.update({ state:"recruit", recruitUntil: now()+60000 });
};
$("startBtn").onclick = async ()=>{
  if(!me.isHost){ return; }
  // デッキ作成（ランダム40）
  const idxs=[...Array(Q.length).keys()].sort(()=>Math.random()-0.5).slice(0,40);
  await roomRef.update({
    deck: idxs, currentIndex:0, state:"countdown",
    buzzedBy:null, answerChoice:null, lastResult:null
  });
  startCountdownOverlay(); // 見た目のカウントダウン
  try{ if(soundEnabled){ $("sndCountdown").currentTime=0; $("sndCountdown").play(); } }catch(_){}
  await sleep(3200);
  await beginQuestion(0);
};
$("stopBtn").onclick = async ()=>{ if(me.isHost){ await roomRef.update({ state:"ended" }); } };

/* ===== 問題開始/次へ ===== */
async function beginQuestion(i){
  const deck = (await roomRef.get()).data().deck||[];
  if(i>=deck.length){ // 終了
    await roomRef.update({ state:"ended" });
    return;
  }
  const openAt = now();
  await roomRef.update({
    state:"question",
    currentIndex: i,
    qOpenAt: openAt,
    answerDeadline: openAt + 8000, // 8秒
    buzzedBy:null, answerChoice:null, lastResult:null
  });
}

/* ===== カウントダウン（3,2,1 表示） ===== */
function startCountdownOverlay(){
  const ov=$("overlay"), txt=$("overlayText");
  ov.style.display="flex";
  const marks=[ "3","2","1" ];
  let i=0; txt.textContent=marks[i];
  const id=setInterval(()=>{
    i++; if(i<marks.length){ txt.textContent=marks[i]; } else { clearInterval(id); ov.style.display="none"; }
  }, 1000);
}

/* ===== ルーム購読 ===== */
let timer=null;
function subscribeRoom(){
  unsubRoom = roomRef.onSnapshot(doc=>{
    if(!doc.exists) return;
    const r = doc.data();

    $("stateText").textContent = r.state;
    $("hostTools").style.display = me.isHost ? "flex" : "none";
    $("qCard").style.display = (r.state==="question"||r.state==="result") ? "block":"none";
    $("remainText").textContent = (r.deck?.length||0) - (r.currentIndex||0);

    // 募集カウントダウン表示
    if(r.state==="recruit"){
      const tick = ()=>{
        const left = Math.max(0, (r.recruitUntil||0) - now());
        $("recruitLeft").textContent = (left/1000).toFixed(1)+"s";
        if(left<=0){ $("recruitLeft").textContent="0.0s"; if(timer){clearInterval(timer);timer=null;} }
      };
      if(timer) clearInterval(timer); timer=setInterval(tick,100); tick();
    }else{
      $("recruitLeft").textContent="--:--"; if(timer){clearInterval(timer);timer=null;}
    }

    // 問題描画
    const deck = r.deck||[];
    const idx = Math.max(0, Math.min(deck.length-1, r.currentIndex||0));
    if(deck.length>0){
      const q = Q[ deck[idx] ];
      $("qIdx").textContent = `${idx+1} / ${deck.length}`;
      $("qText").textContent = `「${q.text}」`;
    }

    // 回答可否と残り時間
    const allowAnswer = r.state==="question" && (r.answerDeadline||0)>now() && !r.buzzedBy;
    setAnswerEnabled(allowAnswer, r);
    const tl = Math.max(0, (r.answerDeadline||0)-now());
    $("timeLeft").textContent = (tl/1000).toFixed(1)+"s";

    // 結果ピル
    const rp=$("resultPill");
    rp.style.display = r.lastResult ? "inline-block":"none";
    if(r.lastResult==="correct"){ rp.textContent="正解！"; rp.style.background="#e8f5e9"; rp.style.border="1px solid #a5d6a7"; }
    else if(r.lastResult==="wrong"){ rp.textContent="不正解"; rp.style.background="#fdecea"; rp.style.border="1px solid #f5c2c7"; }
    else if(r.lastResult==="timeout"){ rp.textContent="時間切れ"; rp.style.background="#fff3cd"; rp.style.border="1px solid #ffe69c"; }

    // ホスト側の自動進行（時間切れ → 次へ／回答後2秒 → 次へ／全問終了）
    if(me.isHost){
      (async()=>{
        // 時間切れ（まだ誰も押してない）
        if(r.state==="question" && !r.buzzedBy && (r.answerDeadline||0)<=now()){
          await roomRef.update({ lastResult:"timeout" });
          await sleep(2000);
          await beginQuestion(idx+1);
          return;
        }
        // 回答済み → 2秒後 次へ
        if(r.state==="question" && r.buzzedBy && r.lastResult){
          await sleep(2000);
          await beginQuestion(idx+1);
          return;
        }
        // すでに ended
        if(r.state==="ended"){
          try{ if(soundEnabled){ $("sndFinish").currentTime=0; $("sndFinish").play(); } }catch(_){}
          return;
        }
      })();
    }

    if(r.state==="ended"){
      renderResult(); // リザルト表示
    }
  });

  // 参加者購読（順位・残り枠）
  unsubPlayers = playersRef.orderBy("joinedAt","asc").onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    // 表示
    $("playersList").innerHTML = arr.map(p=>{
      const tagYou  = p.id===me.id ? '<span class="you">（あなた）</span>' : '';
      const tagHost = p.isHost ? '<span class="host">（ホスト）</span>' : '';
      return `<span class="pill">${esc(p.name)} ${tagYou}${tagHost} <b>${Number(p.score||0)}pt</b></span>`;
    }).join("");

    // 残り枠
    const remain = Math.max(0, 5 - arr.length);
    $("slotInfo").textContent = `残り：${remain} 名`;
    // 順位
    const ranked=[...arr].sort((a,b)=>{
      if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
      if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
      if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
      return (a.totalTimeMs||0)-(b.totalTimeMs||0);
    });
    const myIdx = ranked.findIndex(p=>p.id===me.id);
    $("myRank").textContent = myIdx>=0 ? `${myIdx+1}位` : (me.spectator? "観戦中":"-位");

    // ハートビート
    if(!me.spectator){ playersRef.doc(me.id).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}); }
  });

  // 応援ログ（簡易）
  unsubCheers = cheersRef.orderBy("createdAt","desc").limit(10).onSnapshot(snap=>{
    const lines=[]; snap.forEach(d=>{ const x=d.data(); lines.push(`${x.name||"匿名"}：${x.text||""}`); });
    $("cheerLog").textContent = lines.join("\n");
  });
}

/* ===== 回答可否の切替 ===== */
function setAnswerEnabled(flag, room){
  const ids=["btnP","btnE","btnI","btnPh"];
  ids.forEach(id=>{
    const el=$(id);
    el.classList.toggle("disabled", !flag);
    el.title = flag
      ? "押して回答（先着1名）"
      : room.buzzedBy ? "先着済みのため回答できません"
      : ( (room.answerDeadline||0)<=now() ? "時間切れです" : "ホストが開始すると回答できます" );
  });
}

/* ===== 回答送信（先着1名） ===== */
["btnP","btnE","btnI","btnPh"].forEach(id=>{
  $(id).addEventListener("click", async ()=>{
    const choice = $(id).dataset.choice;
    await db.runTransaction(async tx=>{
      const snap = await tx.get(roomRef);
      const r = snap.data();
      if(r.state!=="question") return;
      if((r.answerDeadline||0)<=now()) return;
      if(r.buzzedBy) return; // 先着済み
      tx.update(roomRef,{ buzzedBy: me.id, answerChoice: choice });
    });

    // ホストが判定＆加点
    if(me.isHost){
      const snap = await roomRef.get(); const r=snap.data();
      const deck=r.deck||[]; const idx=r.currentIndex||0; const q=Q[ deck[idx] ];
      const ok = (r.answerChoice===q.answer);
      const used = Math.max(0, now()-(r.qOpenAt||now()));
      const delta = ok ? +2 : -3;

      await Promise.all([
        playersRef.doc(r.buzzedBy).set({
          score: firebase.firestore.FieldValue.increment(delta),
          correct: firebase.firestore.FieldValue.increment(ok?1:0),
          wrong:   firebase.firestore.FieldValue.increment(ok?0:1),
          totalTimeMs: firebase.firestore.FieldValue.increment(used)
        }, {merge:true}),
        roomRef.update({ lastResult: ok?"correct":"wrong" })
      ]);

      try{
        if(soundEnabled){
          (ok?$("sndCorrect"):$("sndWrong")).currentTime=0;
          (ok?$("sndCorrect"):$("sndWrong")).play();
        }
      }catch(_){}
    }
  });
});

/* ===== 観戦：応援 ===== */
$("cheerSend").onclick = async ()=>{
  if(!cheersRef) return;
  await cheersRef.add({
    name:$("cheerName").value||"匿名", text:$("cheerText").value||"",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  $("cheerText").value="";
};
$("cheerSound").onclick = ()=>{ try{ if(soundEnabled){ $("sndCheer").currentTime=0; $("sndCheer").play(); } }catch(_){} };

/* ===== リザルト ===== */
async function renderResult(){
  // 集計（上位を表示）
  const snap = await playersRef.get();
  const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  const ranked=[...arr].sort((a,b)=>{
    if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
    if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
    if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
    return (a.totalTimeMs||0)-(b.totalTimeMs||0);
  });
  const myIdx = ranked.findIndex(p=>p.id===me.id);
  const you = myIdx>=0 ? `${myIdx+1}位` : (me.spectator? "観戦":"-位");
  $("qText").textContent = `全問終了！あなたの順位は ${arr.length}人中 ${you} でした。お疲れさまでした。`;
  $("qCard").style.display="block";
}

/* ===== 初期表示 ===== */
showJoin();

/* ===== 退出時に自分を消す ===== */
window.addEventListener("beforeunload", ()=>{ if(playersRef && !me.spectator){ try{ playersRef.doc(me.id).delete(); }catch(_){} }});
</script>
</body>
</html>
