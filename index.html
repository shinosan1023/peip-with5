<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;margin:0;background:#f7faf9;color:#222;}
  header{background:#fff;border-bottom:1px solid #eee;padding:14px 16px;display:flex;gap:10px;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:18px;color:#333}
  main{max-width:980px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #eee;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit}
  input{border:1px solid #ddd;border-radius:8px;padding:8px}
  button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#007bff;color:#fff}
  button.secondary{background:#6c757d}
  button.warn{background:#ff9800}
  button.danger{background:#dc3545}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0}
  .muted{color:#666;font-size:12px}
  .big{font-size:22px;font-weight:800;text-align:center;margin:10px 0}
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
  .ans{padding:16px;border-radius:12px;color:#fff;font-weight:800;text-align:center;cursor:pointer}
  .disabled{opacity:.5;pointer-events:none}
  .score{font-weight:bold}
  .you{color:#007bff}
  .host{color:#d35400}
  .timer{font-weight:900;color:#d32f2f}
  .rankLine{font-size:14px;color:#333}
  /* 参加者色（赤・青・黄・緑・オレンジ） */
  .c-red{background:#e74c3c;color:#fff}.c-blue{background:#3498db;color:#fff}.c-yellow{background:#ffca28;color:#222}.c-green{background:#2ecc71;color:#fff}.c-orange{background:#ff7f50;color:#222}
  /* P/E/I/Ph ボタン色 */
  .P{background:#e74c3c}.E{background:#3498db}.I{background:#f1c40f;color:#222}.Ph{background:#2ecc71}
</style>
</head>
<body>
<header>
  <h1>P.E.I.P. 早押しクイズ</h1>
  <div class="muted">最大5人｜先着1名｜正解+2 / 不正解-2｜各問題5秒｜40問｜離れた場所から同時参加</div>
</header>
<main>

  <!-- 参加：名前＋一言（15文字）＋ホスト -->
  <section id="joinCard" class="card">
    <h3 style="margin:0 0 8px">① 参加登録</h3>
    <div class="row">
      <input id="nameInput" placeholder="名前（表示名）" />
      <input id="commentInput" placeholder="一言（15文字まで）" maxlength="15" />
      <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck" />ホストになる</label>
      <button id="joinBtn">参加する</button>
    </div>
    <div class="muted" style="margin-top:6px">※ 最初に入る方がホストだと進行がスムーズです</div>
  </section>

  <!-- ルーム情報：参加者/状態/残時間/自分の順位 -->
  <section id="roomCard" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <span>ルーム：</span><span id="roomId" class="pill"></span>
        <span class="muted">状態：</span><span id="statePill" class="pill">-</span>
        <span class="muted">残り：</span><span id="timeLeft" class="timer">--</span>
        <span class="muted">あなたの順位：</span><span id="myRank" class="pill">--位</span>
      </div>
      <div id="hostTools" style="display:none" class="row">
        <button id="startRoundBtn" class="warn">ラウンド開始</button>
        <button id="nextBtn" class="secondary">次の問題</button>
        <button id="endBtn" class="danger">終了</button>
      </div>
    </div>
    <div style="margin-top:10px">
      <strong>参加者（最大5人）</strong>
      <div id="playersList" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
    </div>
  </section>

  <!-- 問題エリア -->
  <section id="qCard" class="card" style="display:none">
    <div id="qIdx" class="muted"></div>
    <div id="qText" class="big">問題</div>
    <div id="buzzInfo" class="muted">ホストが「ラウンド開始」を押すと早押し受付が始まります。</div>
    <div id="answers" class="answer-grid" style="margin-top:4px">
      <div class="ans P"  data-choice="P">きもち（P）</div>
      <div class="ans E"  data-choice="E">まわり（E）</div>
      <div class="ans I"  data-choice="I">できること（I）</div>
      <div class="ans Ph" data-choice="Ph">からだ＆病気（Ph）</div>
    </div>
  </section>

  <!-- ルール説明 -->
  <section class="card">
    <strong>遊び方：</strong>
    <ol style="margin:8px 0 0 16px">
      <li>全員が「参加する」で入室（最大5人）。参加者は <b>赤・青・黄・緑・オレンジ</b> の色割当。</li>
      <li>ホストが「ラウンド開始」→問題表示→<b>5秒</b>間の早押し受付（カウントダウン音あり）。</li>
      <li>先着1名のみ有効。<b>正解+2点／不正解-2点</b>。ホストが「次の問題」で進行。</li>
      <li>あなたの順位は随時表示されます。</li>
    </ol>
  </section>

</main>

<!-- 効果音（index.html と同じフォルダに配置） -->
<audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
<audio id="sndCorrect"   src="se_correct.mp3" preload="auto"></audio>
<audio id="sndWrong"     src="se_wrong.mp3"   preload="auto"></audio>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ===== Firebase 設定 ===== */
const firebaseConfig = {
  apiKey: "AIzaSyARGroRdf4DmJN5nOHdiVy-a9UCA1ruDPw",
  authDomain: "peip-quiz.firebaseapp.com",
  projectId: "peip-quiz",
  storageBucket: "peip-quiz.appspot.com",
  messagingSenderId: "523666051548",
  appId: "1:523666051548:web:2a84fc0f2163872b2eff19",
  measurementId: "G-6049XMQEBK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== 40問 ===== */
const labelMap = { P:"きもち", E:"まわり", I:"できること", Ph:"からだ＆病気" };
const questions = [
  {text:"孫に会いたいと思っているか？",answer:"P"},
  {text:"洗面所の床は濡れていないか？",answer:"E"},
  {text:"トイレで立位をとることはできるか？",answer:"I"},
  {text:"肌は乾燥していないか？",answer:"Ph"},
  {text:"昔していた仕事は何か？",answer:"P"},
  {text:"居室の手すりにぐらつきはないか？",answer:"E"},
  {text:"歯磨きは一人で行えるか？",answer:"I"},
  {text:"むせこみはないか？",answer:"Ph"},
  {text:"デイサービスを楽しみにしているか？",answer:"P"},
  {text:"冷蔵庫に消費期限切れはないか？",answer:"E"},
  {text:"歩行器を使えば自立歩行はできるか？",answer:"I"},
  {text:"足にむくみはないか？",answer:"Ph"},
  {text:"好きな音楽（曲・歌手）は何か？",answer:"P"},
  {text:"居室の段差はないか？",answer:"E"},
  {text:"トイレのボタンを操作できるか？",answer:"I"},
  {text:"夜間の頻尿はないか？",answer:"Ph"},
  {text:"調味料にこだわりはあるか？",answer:"P"},
  {text:"テレビの音量はいくつか？",answer:"E"},
  {text:"薬は自分で管理できているか？",answer:"I"},
  {text:"目やにはついていないか？",answer:"Ph"},
  {text:"どのような環境で寝たいか？",answer:"P"},
  {text:"コールボタンは届く位置にあるか？",answer:"E"},
  {text:"座位保持はできているか？",answer:"I"},
  {text:"腰痛など体の痛みはないか？",answer:"Ph"},
  {text:"食べたいものはあるか？",answer:"P"},
  {text:"居室の換気はできているか？",answer:"E"},
  {text:"お茶を入れて飲めるか？",answer:"I"},
  {text:"息苦しさはないか？",answer:"Ph"},
  {text:"習慣となっていることは何か？",answer:"P"},
  {text:"使用している介護サービスは何か？",answer:"E"},
  {text:"体操で体を動かせているか？",answer:"I"},
  {text:"ふらつきはないか？",answer:"Ph"},
  {text:"家族に伝えたい思いはあるか？",answer:"P"},
  {text:"部屋の明るさは適切か？",answer:"E"},
  {text:"着替えは自力でできるか？",answer:"I"},
  {text:"食欲はどうか？",answer:"Ph"},
  {text:"好きな趣味は何か？",answer:"P"},
  {text:"家のカギの保管場所は？",answer:"E"},
  {text:"買い物メモを書けるか？",answer:"I"},
  {text:"夜間に不眠はないか？",answer:"Ph"},
];

/* ===== ルーム・プレイヤー ===== */
const roomId = "default";  // 必要になればURLクエリ等で切替可能
document.getElementById("roomId").textContent = roomId;

function uid(){
  const k = "peip-uid";
  let v = localStorage.getItem(k);
  if(!v){ v = "u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k, v); }
  return v;
}
let me = { id: uid(), name:"", comment:"", isHost:false, score:0, color:"" };

/* 参加色（赤・青・黄・緑・オレンジ） */
const colorOrder = ["c-red","c-blue","c-yellow","c-green","c-orange"];
function nextColor(used){ for(const c of colorOrder){ if(!used.includes(c)) return c; } return null; }

/* ===== Firestore 参照 ===== */
const roomRef    = db.collection("rooms").doc(roomId);
const playersRef = roomRef.collection("players");

/* ===== 要素 ===== */
const joinCard = document.getElementById("joinCard");
const roomCard = document.getElementById("roomCard");
const qCard    = document.getElementById("qCard");
const playersList = document.getElementById("playersList");
const statePill = document.getElementById("statePill");
const hostTools = document.getElementById("hostTools");
const qText     = document.getElementById("qText");
const qIdxEl    = document.getElementById("qIdx");
const buzzInfo  = document.getElementById("buzzInfo");
const ansButtons= Array.from(document.querySelectorAll(".ans"));
const timeLeftEl= document.getElementById("timeLeft");
const myRankEl  = document.getElementById("myRank");

/* ===== 効果音 ===== */
const sndCountdown = document.getElementById('sndCountdown');
const sndCorrect   = document.getElementById('sndCorrect');
const sndWrong     = document.getElementById('sndWrong');

/* ===== ルーム初期化 ===== */
async function ensureRoom(){
  const snap = await roomRef.get();
  if(!snap.exists){
    await roomRef.set({
      state: "lobby",           // lobby | open | locked | ended
      currentIndex: 0,
      buzzedBy: null,
      answerChoice: null,
      openUntilMs: 0,           // 受付終了時刻（ms, クライアント基準）
      lastResult: null,         // "correct" | "wrong" | null
      resultKey: "",            // 変化検知用
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}
ensureRoom();

/* ===== 参加処理 ===== */
document.getElementById("joinBtn").onclick = async()=>{
  const name = (document.getElementById("nameInput").value || "").trim();
  const comment = (document.getElementById("commentInput").value || "").trim().slice(0,15);
  const isHost = document.getElementById("hostCheck").checked;
  if(!name){ alert("名前を入力してください"); return; }

  // 5人制限・色の割当
  const cur = await playersRef.get();
  if(cur.size >= 5){ alert("参加可能人数（5人）に達しています"); return; }
  const usedColors = []; cur.forEach(d=>{ if(d.data().color) usedColors.push(d.data().color); });
  const color = nextColor(usedColors) || "c-orange";

  me = { id: uid(), name, comment, isHost, score:0, color };
  await playersRef.doc(me.id).set({
    name, comment, score:0, isHost, color, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  joinCard.style.display = "none";
  roomCard.style.display = "block";
};

/* ===== 参加者購読（スコア→順位の随時表示） ===== */
let playersCache = [];
playersRef.orderBy("joinedAt","asc").onSnapshot(snap=>{
  const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
  playersCache = arr;

  if(arr.find(p=>p.id===me.id)){ joinCard.style.display="none"; roomCard.style.display="block"; }

  // 順位：スコア降順
  const sorted = [...arr].sort((a,b)=>{
    if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
    return 0;
  });
  const myIndex = sorted.findIndex(p=>p.id===me.id);
  myRankEl.textContent = (myIndex>=0) ? `${myIndex+1}位` : "--位";

  // 一覧（色分け）
  playersList.innerHTML = arr.map(p=>{
    const you = p.id===me.id?'<span class="you">[you]</span>':'';
    const host= p.isHost?'<span class="host">[host]</span>':'';
    return `<div class="pill ${esc(p.color||'')}" title="${esc(p.comment||'')}">${esc(p.name)} ${you} ${host} <span class="score">${Number(p.score||0)}pt</span></div>`;
  }).join("");
});

/* ===== カウントダウン音・判定音の“重複再生防止”キー ===== */
let lastCountdownKey = ""; // currentIndex+openUntilMs
let lastResultKey    = ""; // resultKey

/* ===== ルーム購読（状態/問題/5秒タイマー・効果音） ===== */
let countdownTimer = null;
function startCountdownLoop(untilMs){
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = setInterval(async ()=>{
    const ms = Math.max(0, untilMs - Date.now());
    timeLeftEl.textContent = (ms/1000).toFixed(1)+"s";
    if(ms<=0){
      clearInterval(countdownTimer);
      timeLeftEl.textContent = "0.0s";
      if(me.isHost){
        const doc = await roomRef.get();
        const r = doc.data();
        if(r.state==="open"){ await roomRef.update({ state:"locked" }); }
      }
    }
  }, 100);
}

roomRef.onSnapshot(snap=>{
  if(!snap.exists) return;
  const r = snap.data();
  statePill.textContent = r.state;
  hostTools.style.display = me.isHost ? "flex" : "none";

  const idx = Math.max(0, Math.min(questions.length-1, r.currentIndex||0));
  qIdxEl.textContent = `問題 ${idx+1} / ${questions.length}`;
  qText.textContent = "「" + questions[idx].text + "」";

  if(r.state==="lobby" || r.state==="ended"){ qCard.style.display = "none"; }
  else{ qCard.style.display = "block"; }

  if(r.state==="open"){
    const key = `${r.currentIndex}|${r.openUntilMs}`;
    if(key !== lastCountdownKey){
      lastCountdownKey = key;
      try{ sndCountdown.currentTime = 0; sndCountdown.play(); }catch(_){}
    }
    buzzInfo.textContent = "早押し受付中！（5秒）先に押した1名だけ有効です。";
    setAnswersDisabled(false);
    startCountdownLoop(r.openUntilMs||0);
  }else if(r.state==="locked"){
    setAnswersDisabled(true);
    // 判定音（正解/不正解） … resultKey が変わったタイミングで一度再生
    if(r.resultKey && r.resultKey !== lastResultKey){
      lastResultKey = r.resultKey;
      if(r.lastResult === "correct"){
        try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch(_){}
      }else if(r.lastResult === "wrong"){
        try{ sndWrong.currentTime=0; sndWrong.play(); }catch(_){}
      }
    }
    if(r.buzzedBy){
      const p = playersCache.find(x=>x.id===r.buzzedBy);
      const who = p ? p.name : `ID:${r.buzzedBy}`;
      buzzInfo.textContent = `【${who}】が先に押しました。判定済み／次の問題へ`;
    }else{
      buzzInfo.textContent = "時間切れ。次の問題へ。";
    }
  }else{
    buzzInfo.textContent = "ホストが「ラウンド開始」を押すと早押し受付が始まります。";
    setAnswersDisabled(true);
  }
});

function setAnswersDisabled(flag){
  ansButtons.forEach(b=>{ if(flag) b.classList.add("disabled"); else b.classList.remove("disabled"); });
}

/* ===== 回答（先着1名：正解 +2／不正解 -2） ===== */
ansButtons.forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const choice = btn.dataset.choice;

    // 先着確定（state=open & 期限内 & buzzedBy未設定）
    let winner = false;
    await db.runTransaction(async (tx)=>{
      const doc = await tx.get(roomRef);
      if(!doc.exists) return;
      const r = doc.data();
      if(r.state!=="open") return;
      if((r.openUntilMs||0) < Date.now()) return;
      if(r.buzzedBy) return;
      winner = true;
      tx.update(roomRef, { state:"locked", buzzedBy: me.id, answerChoice: choice });
    });

    // 勝者ならホストが判定・加点・判定音のトリガ
    if(me.isHost && winner){
      const doc = await roomRef.get(); const r = doc.data();
      const idx = Math.max(0, Math.min(questions.length-1, r.currentIndex||0));
      const ok  = (r.answerChoice === questions[idx].answer);
      const delta = ok ? +2 : -2;
      const nextKey = `${Date.now()}_${ok?'C':'W'}`;
      await Promise.all([
        playersRef.doc(r.buzzedBy).set({ score: firebase.firestore.FieldValue.increment(delta) }, { merge:true }),
        roomRef.update({ lastResult: ok ? "correct":"wrong", resultKey: nextKey })
      ]);
    }
  });
});

/* ===== ホスト操作 ===== */
document.getElementById("startRoundBtn").onclick = async ()=>{
  if(!me.isHost) return;
  await roomRef.update({
    state:"open", buzzedBy:null, answerChoice:null,
    lastResult:null, resultKey:"",
    openUntilMs: Date.now()+5000
  });
};
document.getElementById("nextBtn").onclick = async ()=>{
  if(!me.isHost) return;
  const doc = await roomRef.get(); const r = doc.data();
  const next = ((r.currentIndex||0)+1) % questions.length;
  await roomRef.update({
    state:"open", buzzedBy:null, answerChoice:null,
    lastResult:null, resultKey:"",
    currentIndex: next, openUntilMs: Date.now()+5000
  });
};
document.getElementById("endBtn").onclick = async ()=>{
  if(!me.isHost) return;
  await roomRef.update({ state:"ended" });
};

/* ===== エスケープ ===== */
function esc(s){return String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]))}
</script>
</body>
</html>
