<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>

<style>
  :root{
    --fg:#1f2a37;--muted:#6b7280;--line:#e5e7eb;--card:#fff;
    --primary:#2563eb;--warn:#f59e0b;--danger:#ef4444;--ok:#16a34a;
  }
  body{margin:0;background:#f8fafc;color:var(--fg);
       font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line);
         display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px}
  .brand{font-weight:900}
  main{max-width:1100px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.04);padding:14px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
  input,select,button,textarea{font:inherit}
  input,select,textarea{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn{background:#e5e7eb}
  .primary{background:var(--primary);color:#fff}
  .warn{background:var(--warn);color:#fff}
  .danger{background:var(--danger);color:#fff}
  .ok{background:var(--ok);color:#fff}
  .ghost{background:transparent;border:1px solid var(--line)}
  .right{margin-left:auto}
  .hidden{display:none !important}

  /* ルームタイル */
  .rooms{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .room{padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
  .room.selected{outline:3px solid var(--primary)}
  .state-idle{color:#111}
  .state-recruit{color:#b45309}
  .state-playing{color:#2563eb}

  /* 円形ボタン（解答） */
  .answers{display:grid;grid-template-columns:repeat(2,1fr);gap:18px;margin-top:10px}
  .ans{
    height:160px;border-radius:999px;display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:20px;color:#fff;border:6px solid #fff;
    box-shadow:0 10px 22px rgba(0,0,0,.15), inset 0 2px 0 rgba(255,255,255,.4), inset 0 -2px 0 rgba(0,0,0,.07);
  }
  .ans.P{background:#ef4444}.ans.E{background:#3b82f6}.ans.I{background:#facc15;color:#111}.ans.Ph{background:#22c55e}
  .ans.disabled{opacity:.5;pointer-events:none}

  /* 参加者チップ */
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line)}
  .c-red{background:#fee2e2}.c-blue{background:#dbeafe}.c-yellow{background:#fef9c3}.c-green{background:#dcfce7}.c-orange{background:#ffedd5}

  /* 3,2,1 オーバーレイ */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);color:#fff;display:none;align-items:center;justify-content:center;z-index:50}
  #overlay .num{font-size:120px;font-weight:900;text-shadow:0 10px 30px rgba(0,0,0,.6)}
  @keyframes pop{0%{transform:scale(.7)}60%{transform:scale(1.15)}100%{transform:scale(1)}}
  .pop{animation:pop .35s ease-out}

  .result-big{font-size:22px;font-weight:900;text-align:center;margin:10px 0}
  .correct{color:#16a34a}.wrong{color:#ef4444}
  .rank{font-weight:900}
  .kbd{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <div class="brand">P.E.I.P. 早押しクイズ</div>
  <div class="row right">
    <label class="row" title="効果音 ON/OFF">
      <input id="soundChk" type="checkbox" checked/>
      <span>音声: <span id="soundState">ON</span></span>
    </label>
    <button id="leaveBtn" class="ghost">退出する</button>
  </div>
</header>

<main>

  <!-- スタート画面 -->
  <section id="home" class="card">
    <h3 style="margin:0 0 6px">① 名前を入力</h3>
    <div class="row">
      <input id="nameInput" placeholder="名前（必須）" />
      <label class="row"><input id="hostChk" type="checkbox"/> ホストになる</label>
    </div>

    <h3 style="margin:14px 0 6px">② ルームを選ぶ（全15室）</h3>
    <div id="roomsGrid" class="rooms"></div>

    <div class="row" style="margin-top:10px">
      <button id="joinBtn" class="primary">参加</button>
      <button id="watchBtn" class="btn">観戦</button>
      <span class="muted">※ ルームを選んでから「参加」または「観戦」を押してください</span>
    </div>
  </section>

  <!-- ルーム画面 -->
  <section id="room" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <span>ルーム：</span><span id="roomIdEl" class="pill">-</span>
          <span class="muted">状態：</span><span id="stateEl" class="pill">-</span>
          <span class="muted">募集終了まで：</span><span id="recruitLeft" class="pill">--:--</span>
          <span class="muted">残り問題：</span><span id="remainEl" class="pill">--</span>
          <span class="muted">あなたの順位：</span><span id="myRank" class="pill">-位</span>
        </div>
        <div class="row" id="hostBtns">
          <button id="recruitBtn" class="warn">募集開始</button>
          <button id="startBtn" class="primary">ゲーム開始</button>
          <button id="stopBtn" class="danger">中止</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <strong>参加者（最大5人）</strong>
        <div id="playersEl" class="row" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="card" id="qArea">
      <div class="row muted" style="justify-content:space-between">
        <div>問題 <span id="qIdx">-</span> / 40</div>
        <div>回答残り：<span id="openLeft">0.0s</span></div>
      </div>
      <div id="qText" class="result-big">ホストが「ゲーム開始」を押すと表示されます。</div>
      <div id="judgeMsg" class="result-big"></div>
      <div class="answers">
        <div class="ans P"  data-choice="P">きもち</div>
        <div class="ans E"  data-choice="E">まわり</div>
        <div class="ans I"  data-choice="I">できること</div>
        <div class="ans Ph" data-choice="Ph">からだ＆病気</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:8px;align-items:flex-start">
        <div><strong>観戦・応援</strong></div>
        <input id="cheerName" placeholder="名前（任意）" style="min-width:140px">
        <textarea id="cheerText" placeholder="応援コメント（誰でも送信可）" style="flex:1;min-height:44px"></textarea>
        <button id="cheerSend" class="btn">送信</button>
        <button id="cheerBtn" class="ok">応援</button>
      </div>
      <div id="cheerLog" class="muted" style="margin-top:6px;white-space:pre-wrap"></div>
    </div>
  </section>

  <section class="card muted">
    ・URLアクセス → 名前入力 → ルーム選択 → 「参加」または「観戦」 →（ホストが「募集開始」「ゲーム開始」）→ 40問が連続で出題。  
    ・先着1名のみ有効。正解 +2点／不正解 -3点。回答は <span class="kbd">8s</span>。結果は2秒表示して次へ自動進行。  
    ・終了時に順位を集計。音は同じフォルダの mp3 を使用します。  
    ・P.E.I.P.は聖隷クリストファー大学の篠﨑良勝氏が介護過程教育の質向上のために作成した教材です。フレームワークで分類する場合は必ず学習のうえ実施してください。
  </section>

</main>

<!-- オーバーレイ（3,2,1）-->
<div id="overlay"><div id="ovText" class="num">3</div></div>

<!-- 効果音（index.html と同じフォルダに置いてください） -->
<audio id="sndRecruit"   src="bosyu.mp3"      preload="auto"></audio>
<audio id="sndCountdown" src="countdown.mp3"  preload="auto"></audio>
<audio id="sndCorrect"   src="se_correct.mp3" preload="auto"></audio>
<audio id="sndWrong"     src="se_wrong.mp3"   preload="auto"></audio>
<audio id="sndGong"      src="gongu.mp3"      preload="auto"></audio>
<audio id="sndCheer"     src="kansei.mp3"     preload="auto"></audio>

<!-- Firebase compat（GitHub Pagesでそのまま使えます） -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
/* ===== Firebase 設定（peip-with5）===== */
const firebaseConfig = {
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== 定数/ユーティリティ ===== */
const MAX_PLAYERS = 5;
const RECRUIT_MS  = 60000;
const ANSWER_MS   = 8000;
const DECK_LEN    = 40;
const COLOR_ORDER = ["c-red","c-blue","c-yellow","c-green","c-orange"];
const roomsAll    = Array.from({length:15}, (_,i)=>`room-${String(i+1).padStart(2,'0')}`);

function uid(){ const k="peip-uid"; let v=localStorage.getItem(k); if(!v){ v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
const me = { id: uid(), name:"", color:"", isHost:false, spectator:false, roomId:null };
const el = id=>document.getElementById(id);
const now = ()=>Date.now();
const play = (audioEl)=>{ if(!soundEnabled) return; try{ audioEl.currentTime=0; audioEl.play(); }catch(_){ } };
const esc = s=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]));
function pickColor(used){ for(const c of COLOR_ORDER){ if(!used.includes(c)) return c; } return COLOR_ORDER[COLOR_ORDER.length-1]; }
function crownRank(a,b){ // tie-break: score desc, correct desc, wrong asc, time asc
  if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
  if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
  if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
  return (a.timeMs||0)-(b.timeMs||0);
}

/* ===== 質問プール ===== */
const questionsPool = [
  { text: "子どもに会いたいと思っているか？", answer: "P" },{ text: "洗濯物にしわはないか？", answer: "E" },
  { text: "トイレで立位をとることができるか？", answer: "I" },{ text: "便秘はないか？", answer: "Ph" },
  { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },{ text: "トイレの手すりにぐらつきはないか？", answer: "E" },
  { text: "歯磨きは一人で行えているか？", answer: "I" },{ text: "むせこみはないか？", answer: "Ph" },
  { text: "デイサービスを楽しみにしているか？", answer: "P" },{ text: "冷蔵庫に消費期限が過ぎた食品はないか？", answer: "E" },
  { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },{ text: "足にむくみはないか？", answer: "Ph" },
  { text: "好きな音楽（曲・歌手）は何か？", answer: "P" },{ text: "洗面所の床は濡れていないか？", answer: "E" },
  { text: "トイレのボタンを操作することはできるか？", answer: "I" },{ text: "肌は乾燥していないか？", answer: "Ph" },
  { text: "暮らしで困っていることはないか？", answer: "P" },{ text: "息苦しさや胸の圧迫感はないか？", answer: "Ph" },
  { text: "着替えは介助なしでできるか？", answer: "I" },{ text: "食欲や水分摂取量はどうか？", answer: "Ph" },
  { text: "昔していた仕事は何か？", answer: "P" },{ text: "使用している福祉用具は何か？", answer: "E" },
  { text: "電話をかけることができるか？", answer: "I" },{ text: "視力はどの程度か？", answer: "Ph" },
  { text: "食べたいものはあるか？", answer: "P" },{ text: "自宅で10ミリ以上の段差はないか？", answer: "E" },
  { text: "お茶を入れて飲むことはできるか？", answer: "I" },{ text: "夜間の睡眠状況はどうか？", answer: "Ph" },
  { text: "習慣となっていることは何か？", answer: "P" },{ text: "利用している介護サービスは何か？", answer: "E" },
  { text: "体操で体を動かせているか？", answer: "I" },{ text: "ふらつきはないか？", answer: "Ph" },
  { text: "趣味を再開したい思いはあるか？", answer: "P" },{ text: "居室の温度・室温は？", answer: "E" },
  { text: "食事の準備は一人でできるか？", answer: "I" },{ text: "腰痛など体の痛みはないか？", answer: "Ph" },
  { text: "調味料にこだわりはあるか？", answer: "P" },{ text: "薬の管理で手伝ってほしいことはあるか？", answer: "P" },
  { text: "薬の管理は一人で行えているか？", answer: "I" },{ text: "まぶたに目やにはついていないか？", answer: "Ph" },
  { text: "どのような環境で寝たい思っているか？", answer: "P" },{ text: "コールのボタンは鳴るか？", answer: "E" },
  { text: "座位をとることはできているか？", answer: "I" },{ text: "巻き爪はないか？", answer: "Ph" },
  { text: "何をしている時が幸せを感じる時か？", answer: "P" },{ text: "現在、交流のある人は誰か？", answer: "E" },
  { text: "買い物リストを書くことはできるか？", answer: "I" },{ text: "夜間に不眠はないか？", answer: "Ph" },
  { text: "お気に入りの服はあるか？", answer: "P" },{ text: "居室の換気状況は？", answer: "E" }
];

/* ===== グローバル状態 ===== */
let soundEnabled = true;
el('soundChk').addEventListener('change',()=>{
  soundEnabled = el('soundChk').checked;
  el('soundState').textContent = soundEnabled?'ON':'OFF';
});

/* ===== 画面切替 ===== */
function showHome(){
  el('home').classList.remove('hidden');
  el('room').classList.add('hidden');
  el('leaveBtn').classList.remove('primary');
}
function showRoom(){
  el('home').classList.add('hidden');
  el('room').classList.remove('hidden');
  el('leaveBtn').classList.add('primary');
}

/* ===== ルーム一覧 ===== */
const roomSubs = new Map();
const roomStatusCache = {};
function ensureRoomsDocs(){ roomsAll.forEach(id=>db.collection('rooms').doc(id).set({createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})); }
function statusLabel(r, playersCount){
  const st = r?.state||'idle';
  if(st==='question' || st==='starting') return '試合中（観戦のみ可）';
  if(st==='recruiting' && (r.recruitEnd||0)>now()) return '参加者募集中';
  return (playersCount>0)?'待機中':'空室';
}
function renderRooms(){
  const grid = el('roomsGrid'); grid.innerHTML='';
  roomsAll.forEach(id=>{
    const box = document.createElement('div');
    box.className='room'; box.dataset.room=id;
    box.innerHTML = `<div class="row" style="justify-content:space-between">
        <strong>${id}</strong>
        <span id="s-${id}" class="muted"></span>
      </div>`;
    box.onclick=()=>{
      document.querySelectorAll('.room').forEach(x=>x.classList.remove('selected'));
      box.classList.add('selected');
    };
    grid.appendChild(box);

    // subscribe room + players (小規模なのでクライアントでOK)
    if(roomSubs.has(id)) return;
    const roomRef = db.collection('rooms').doc(id);
    const unsub = roomRef.onSnapshot(async snap=>{
      const r = snap.data()||{};
      const playersSnap = await roomRef.collection('players').get();
      const cnt = playersSnap.size;
      const txt = statusLabel(r,cnt);
      const elState = el(`s-${id}`); if(elState){ elState.textContent = `（${txt} / ${cnt}人）`; }
      roomStatusCache[id] = {state:r.state||'idle', players:cnt};
    });
    roomSubs.set(id,unsub);
  });
}

/* ===== 参加/観戦（スタート画面） ===== */
function selectedRoomId(){
  const sel = document.querySelector('.room.selected');
  return sel?sel.dataset.room:null;
}
async function joinRoom(spectator){
  const rid = selectedRoomId();
  const name = el('nameInput').value.trim();
  const wantHost = el('hostChk').checked;
  if(!rid){ alert('まずルームを選んでください。'); return; }
  if(!name){ alert('名前を入力してください。'); return; }

  // 試合中は観戦のみ
  const rdoc = await db.collection('rooms').doc(rid).get();
  const r = rdoc.data()||{};
  if(!spectator && (r.state==='question'||r.state==='starting')){
    alert('このルームは試合中です。観戦のみ可能です。');
    return;
  }

  me.name = name; me.isHost = !!wantHost; me.roomId = rid; me.spectator = !!spectator;

  showRoom();
  setupRoom();
}
el('joinBtn').onclick = ()=> joinRoom(false);
el('watchBtn').onclick= ()=> joinRoom(true);

/* ===== ルーム内部 ===== */
let roomRef=null, playersRef=null;
let roomUnsub=null, playersUnsub=null, cheersUnsub=null;
let qTimer=null, recruitTimer=null, resultTimer=null;
let playersCache=[];
let lastResultKey="", lastEndKey="";

function stopTimers(){ if(qTimer) clearInterval(qTimer); if(recruitTimer) clearInterval(recruitTimer); if(resultTimer) clearTimeout(resultTimer); }

async function setupRoom(){
  const rid = me.roomId;
  el('roomIdEl').textContent = rid;
  roomRef    = db.collection('rooms').doc(rid);
  playersRef = roomRef.collection('players');

  // 参加者として席確保
  if(!me.spectator){
    const cur = await playersRef.get();
    if(cur.size >= MAX_PLAYERS){ alert('満席です。他のルームをお選びください。'); showHome(); return; }
    // 色割当
    const used=[]; cur.forEach(d=>{ if(d.data().color) used.push(d.data().color); });
    me.color = pickColor(used);
    await playersRef.doc(me.id).set({
      name:me.name, isHost:me.isHost, color:me.color, score:0, correct:0, wrong:0, timeMs:0,
      joinedAt:firebase.firestore.FieldValue.serverTimestamp(),
      lastSeen:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }

  // UI
  el('hostBtns').style.display = me.isHost ? 'flex' : 'none';

  // 監視：参加者
  if(playersUnsub) playersUnsub();
  playersUnsub = playersRef.onSnapshot(snap=>{
    const list=[]; snap.forEach(d=>list.push({id:d.id,...d.data()})); playersCache=list;
    // 自分の順位（ゲーム開始前は -位）
    const sorted=[...list].sort(crownRank);
    const rankIndex = sorted.findIndex(x=>x.id===me.id);
    el('myRank').textContent = (roomState==='question' || roomState==='locked' || roomState==='ended') ?
      ((rankIndex>=0)? `${rankIndex+1}位` : (me.spectator? '観戦' : '-位')) : '-位';

    // 一覧
    const pBox = el('playersEl'); pBox.innerHTML='';
    list.forEach(p=>{
      const chip = document.createElement('div');
      const you  = (p.id===me.id)?'（あなた）':'';
      const host = p.isHost?'（ホスト）':'';
      chip.className=`chip ${p.color||''}`; chip.innerHTML = `<span>${esc(p.name)}</span><span class="muted">${you}${host}</span><span class="rank">${Number(p.score||0)}pt</span>`;
      pBox.appendChild(chip);
    });
  });

  // 監視：応援ログ
  if(cheersUnsub) cheersUnsub();
  cheersUnsub = roomRef.collection('cheers').orderBy('createdAt','desc').limit(20).onSnapshot(snap=>{
    const lines=[]; snap.forEach(d=>{ const x=d.data(); lines.push(`${esc(x.name||'匿名')}: ${esc(x.text||'')}`); });
    el('cheerLog').textContent = lines.join('\n');
  });

  // 監視：ルーム（状態/問題）
  if(roomUnsub) roomUnsub();
  roomUnsub = roomRef.onSnapshot(snap=>onRoomUpdate(snap.data()||{}));

  // ハートビート
  if(!me.spectator){
    setInterval(()=>{ playersRef.doc(me.id).set({ lastSeen:firebase.firestore.FieldValue.serverTimestamp() },{merge:true}); }, 20000);
  }
}

let roomState='idle';
let qStartAt=0, openUntil=0, deck=[], idx=0;

function setAnswersDisabled(flag){ document.querySelectorAll('.ans').forEach(b=>b.classList.toggle('disabled', !!flag)); }

function onRoomUpdate(r){
  roomState = r.state || 'idle';
  deck = r.deck || deck; idx = r.idx||0;
  qStartAt = r.qStartAt||0; openUntil = r.openUntil||0;

  // ヘッダ
  el('stateEl').textContent = roomState;
  if(r.recruitEnd){ const tick=()=>{ const ms=Math.max(0,(r.recruitEnd||0)-now()); el('recruitLeft').textContent = (ms>0)? `${String(Math.floor(ms/1000)).padStart(2,'0')}s`:'--:--'; }; if(recruitTimer) clearInterval(recruitTimer); tick(); recruitTimer=setInterval(tick,200); } else { el('recruitLeft').textContent='--:--'; }
  el('remainEl').textContent = (roomState==='question'||roomState==='locked') ? `${Math.max(0, DECK_LEN-idx)}` : '--';

  // コントロール表示
  el('recruitBtn').disabled = !me.isHost || (roomState!=='idle' && roomState!=='recruiting');
  el('startBtn').disabled   = !me.isHost || (roomState!=='idle' && roomState!=='recruiting');
  el('stopBtn').disabled    = !me.isHost || (roomState==='idle');

  // 問題UI
  if(roomState==='idle' || roomState==='recruiting' || roomState==='starting'){
    setAnswersDisabled(true);
    el('qText').textContent = (roomState==='starting')?'開始準備中...':'ホストが「ゲーム開始」を押すと表示されます。';
    el('judgeMsg').textContent='';
    el('qIdx').textContent='-';
    el('openLeft').textContent='0.0s';
  }
  if(roomState==='starting'){
    // 全員で3,2,1
    const until = r.startAt|| (now()+3500);
    showCountdown(until);
  }
  if(roomState==='question'){
    el('qIdx').textContent = String(Math.min(DECK_LEN, idx+1));
    const q = questionsPool[ deck[idx] ];
    el('qText').textContent = '「'+q.text+'」';
    el('judgeMsg').textContent='';
    setAnswersDisabled(me.spectator);

    // 残り時間表示
    if(qTimer) clearInterval(qTimer);
    qTimer = setInterval(()=>{
      const ms = Math.max(0,(openUntil||0) - now());
      el('openLeft').textContent = (ms/1000).toFixed(1)+'s';
      if(ms<=0){ clearInterval(qTimer); setAnswersDisabled(true); if(me.isHost){ // 時間切れ → 次へ
        setTimeout(async ()=>{
          if((await roomRef.get()).data().state==='question'){ await nextQuestion(false,0); }
        }, 800);
      }}
    },100);
  }
  if(roomState==='locked'){
    // 判定音（重複再生防止）
    if(r.resultKey && r.resultKey!==lastResultKey){
      lastResultKey=r.resultKey;
      if(r.lastResult==='correct') { el('judgeMsg').innerHTML='<span class="correct">⭕ 正解！</span>'; play(el('sndCorrect')); }
      else if(r.lastResult==='wrong'){ el('judgeMsg').innerHTML='<span class="wrong">❌ 不正解！</span>'; play(el('sndWrong')); }
    }
    setAnswersDisabled(true);
    // 2秒後に自動で次へ（ホスト）
    if(me.isHost){
      if(resultTimer) clearTimeout(resultTimer);
      resultTimer = setTimeout(async ()=>{
        const cur = (await roomRef.get()).data()||{};
        if(cur.state==='locked'){ await nextQuestion(true, cur.lastAnswerTimeMs||0); }
      }, 2000);
    }
  }
  if(roomState==='ended'){
    el('qIdx').textContent = String(DECK_LEN);
    el('openLeft').textContent='0.0s';
    // 集計して表示
    const sorted=[...playersCache].sort(crownRank);
    const myIndex = sorted.findIndex(x=>x.id===me.id);
    const rankText = (myIndex>=0)? `${myIndex+1}位` : (me.spectator? '観戦':'-位');
    el('qText').innerHTML = `全問終了！ あなたの順位は <b>${playersCache.length}</b>人中 <b>${rankText}</b> でした。お疲れさまでした。`;
    el('judgeMsg').textContent='';

    if(r.endKey !== lastEndKey){ lastEndKey=r.endKey; play(el('sndGong')); }
    setAnswersDisabled(true);
  }
}

/* ===== カウントダウン（開始時のみ） ===== */
function showCountdown(untilMs){
  const ov = el('overlay'), t = el('ovText'); ov.style.display='flex';
  const marks = [
    {at:-3000,txt:'3'},{at:-2000,txt:'2'},{at:-1000,txt:'1'},{at:-50,txt:'スタート！'}
  ];
  let i=0; play(el('sndCountdown'));
  const raf = ()=>{
    const rest = untilMs - now();
    while(i<marks.length && rest<= -marks[i].at){ t.textContent=marks[i].txt; t.classList.remove('pop'); void t.offsetWidth; t.classList.add('pop'); i++; }
    if(rest>0){ requestAnimationFrame(raf); }
    else{ ov.style.display='none'; }
  };
  requestAnimationFrame(raf);
}

/* ===== ホスト操作 ===== */
el('recruitBtn').onclick = async()=>{
  if(!me.isHost) return;
  await roomRef.set({ state:'recruiting', recruitEnd: now()+RECRUIT_MS },{merge:true});
  play(el('sndRecruit'));
};
el('startBtn').onclick = async()=>{
  if(!me.isHost) return;
  // デッキが無ければ作成（40問ランダム）
  const idxs=[...Array(questionsPool.length).keys()];
  idxs.sort(()=>Math.random()-0.5);
  const deck = idxs.slice(0,Math.min(DECK_LEN, idxs.length));
  const startAt = now()+3500;
  await roomRef.set({ deck, idx:0, state:'starting', startAt, recruitEnd: null },{merge:true});
  // ホストが startAt を過ぎたら 1問目 open
  setTimeout(async ()=>{
    const qStart = now();
    await roomRef.set({ state:'question', qStartAt:qStart, openUntil:qStart+ANSWER_MS },{merge:true});
  }, Math.max(0,startAt-now())+50);
};
el('stopBtn').onclick = async()=>{
  if(!me.isHost) return;
  await roomRef.set({ state:'idle', recruitEnd:null, qStartAt:null, openUntil:null, deck:[], idx:0 },{merge:true});
};

/* ===== 回答（先着1名・正解+2/不正解-3） ===== */
document.querySelectorAll('.ans').forEach(btn=>{
  btn.addEventListener('click', async()=>{
    if(me.spectator) return;
    const choice = btn.dataset.choice;
    await db.runTransaction(async tx=>{
      const doc = await tx.get(roomRef);
      const r = doc.data()||{};
      if(r.state!=='question') return;
      if((r.openUntil||0) < now()) return;
      if(r.buzzedBy) return;
      tx.set(roomRef,{ state:'locked', buzzedBy:me.id, answerChoice:choice, lastAnswerTimeMs: (now() - (r.qStartAt||now())) },{merge:true});
    });

    // ホストが判定＆加点
    if(me.isHost){
      const cur = (await roomRef.get()).data()||{};
      if(cur.state==='locked' && cur.buzzedBy){
        const q = questionsPool[ cur.deck[cur.idx] ];
        const ok = (cur.answerChoice===q.answer);
        const delta = ok ? +2 : -3;
        const updates = [
          playersRef.doc(cur.buzzedBy).set({
            score: firebase.firestore.FieldValue.increment(delta),
            correct: firebase.firestore.FieldValue.increment(ok?1:0),
            wrong: firebase.firestore.FieldValue.increment(ok?0:1),
            timeMs: firebase.firestore.FieldValue.increment(cur.lastAnswerTimeMs||0)
          },{merge:true}),
          roomRef.set({ lastResult: ok?'correct':'wrong', resultKey: String(now()) },{merge:true})
        ];
        await Promise.all(updates);
      }
    }
  });
});

/* ===== 次の問題（自動） ===== */
async function nextQuestion(wasAnswered, lastAnsMs){
  const cur = (await roomRef.get()).data()||{};
  const next = (cur.idx||0)+1;
  if(next >= Math.min(DECK_LEN, (cur.deck||[]).length)){
    await roomRef.set({ state:'ended', endKey:String(now()), buzzedBy:null, answerChoice:null, idx: Math.min(DECK_LEN-1,(cur.idx||0)) },{merge:true});
    return;
  }
  const t = now();
  await roomRef.set({
    state:'question', idx:next, qStartAt:t, openUntil:t+ANSWER_MS,
    buzzedBy:null, answerChoice:null, lastResult:null, resultKey:null
  },{merge:true});
}

/* ===== 応援 ===== */
el('cheerSend').onclick = async()=>{
  const name = el('cheerName').value||'匿名';
  const text = el('cheerText').value||'';
  if(!text.trim()) return;
  await roomRef.collection('cheers').add({name,text, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  el('cheerText').value='';
};
el('cheerBtn').onclick = ()=> play(el('sndCheer'));

/* ===== 退出 ===== */
async function leaveRoom(){
  stopTimers();
  if(roomUnsub) roomUnsub(); if(playersUnsub) playersUnsub(); if(cheersUnsub) cheersUnsub();
  if(roomRef && !me.spectator){
    try{ await playersRef.doc(me.id).delete(); }catch(_){ }
  }
  me.roomId=null; me.spectator=false; me.isHost=false;
  showHome();
}
el('leaveBtn').onclick = leaveRoom;

/* ===== 起動 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  ensureRoomsDocs();
  renderRooms();
  showHome();
});
</script>
</body>
</html>
