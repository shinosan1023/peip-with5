<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P. æ—©æŠ¼ã—ã‚¯ã‚¤ã‚ºï¼ˆæœ€å¤§5äººãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</title>
<style>
  :root{
    --card:#ffffff;
    --muted:#666;
    --text:#222;
    --ring:#00b89455;
    --chip:#f2f4f6;
  }
  body{margin:0;background:#f6f9f8;color:var(--text);
       font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;padding:10px 12px;
         display:flex;gap:10px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:18px}
  main{max-width:980px;margin:14px auto;padding:0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--chip);font-weight:700}
  .btn{border:none;border-radius:10px;padding:10px 12px;background:#007bff;color:#fff;cursor:pointer}
  .btn.gray{background:#6c757d}.btn.orange{background:#ff9800}.btn.red{background:#dc3545}.btn.green{background:#28a745}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:12px;margin-bottom:12px}

  /* ãƒ«ãƒ¼ãƒ ä¸€è¦§ï¼ˆé¸æŠãƒœã‚¿ãƒ³ï¼‰ */
  .room-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
  .room-btn{display:flex;flex-direction:column;gap:4px;align-items:flex-start;border:1px solid #e8e8e8;border-radius:10px;
            background:#fff;padding:10px;cursor:pointer}
  .room-btn.selected{outline:3px solid #8ecae6}
  .status-free{color:#2e7d32}.status-recruit{color:#ef6c00}.status-live{color:#2962ff}

  /* å›ç­”ãƒœã‚¿ãƒ³ï¼ˆä¸¸ï¼‰ */
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;margin-top:10px}
  .ans{
    height:150px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:900;font-size:20px;border:4px solid #fff;
    box-shadow:0 10px 24px rgba(0,0,0,.15),inset 0 2px 0 rgba(255,255,255,.45),inset 0 -2px 0 rgba(0,0,0,.08);
    cursor:pointer;user-select:none
  }
  .ans.P{background:#e53935}.ans.E{background:#1e88e5}.ans.I{background:#ffca28;color:#222}.ans.Ph{background:#43a047}
  .ans.disabled{opacity:.45;pointer-events:none}
  .big{font-size:28px;font-weight:900;text-align:center;margin:12px 0}
  .result{min-height:1.8em;text-align:center;font-size:22px;font-weight:800}
  .ok{color:#2e7d32}.ng{color:#c62828}

  /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #countOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;color:#fff;z-index:9999}
  #countText{font-size:120px;font-weight:900;text-shadow:0 12px 40px rgba(0,0,0,.7)}
  @keyframes pop{0%{transform:scale(.7)}60%{transform:scale(1.15)}100%{transform:scale(1)}}
  .pop{animation:pop .35s ease}

  input[type="text"],input[type="search"],select,textarea{font:inherit;border:1px solid #ddd;border-radius:10px;padding:8px}
  button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{outline:3px solid var(--ring);outline-offset:1px}

  .name-you{color:#000;font-weight:800}
  .name-host{color:#000;font-weight:800}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2f5;margin-left:6px;font-weight:700}

  .sr{position:absolute !important;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}
</style>
</head>
<body>
  <header>
    <h1>P.E.I.P. æ—©æŠ¼ã—ã‚¯ã‚¤ã‚º</h1>
    <div class="row">
      <label class="row" style="gap:6px"><input type="checkbox" id="soundToggle" checked /> éŸ³å£°: <b id="soundLabel">ON</b></label>
      <button id="leaveBtn" class="btn gray">é€€å‡ºã™ã‚‹</button>
    </div>
  </header>

  <main>
    <!-- å‚åŠ ã‚¨ãƒªã‚¢ -->
    <section id="joinArea" class="card">
      <h3 style="margin:0 0 8px;">â‘  åå‰ã‚’å…¥åŠ›</h3>
      <div class="row">
        <input id="nameInput" placeholder="åå‰ï¼ˆè¡¨ç¤ºåï¼‰" />
        <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck" /> ãƒ›ã‚¹ãƒˆã«ãªã‚‹</label>
      </div>

      <h3 style="margin:12px 0 8px;">â‘¡ ãƒ«ãƒ¼ãƒ ã‚’é¸ã¶</h3>
      <div id="roomsGrid" class="room-grid" aria-live="polite"></div>

      <div class="row" style="margin-top:8px">
        <button id="joinBtn" class="btn" disabled>å‚åŠ </button>
        <button id="watchBtn" class="btn green" disabled>è¦³æˆ¦</button>
        <div class="muted" id="roomInfo"></div>
      </div>
    </section>

    <!-- ãƒ«ãƒ¼ãƒ å†…ã‚¨ãƒªã‚¢ -->
    <section id="roomArea" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span>ãƒ«ãƒ¼ãƒ ï¼š</span><span id="roomIdLabel" class="pill"></span>
          <span class="muted">çŠ¶æ…‹ï¼š</span><span id="statePill" class="pill">-</span>
          <span class="muted">å‹Ÿé›†çµ‚äº†ã¾ã§ï¼š</span><span id="recruitRemain" class="pill">--:--</span>
          <span class="muted">æ®‹ã‚Šå•æ•°ï¼š</span><span id="remainQ" class="pill">--</span>
          <span class="muted">ã‚ãªãŸã®é †ä½ï¼š</span><span id="myRank" class="pill">-ä½</span>
        </div>
        <div id="hostTools" class="row" style="display:none">
          <button id="recruitBtn"  class="btn orange">å‹Ÿé›†é–‹å§‹</button>
          <button id="closeBtn"    class="btn gray">ç· åˆ‡</button>
          <button id="startBtn"    class="btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
          <button id="stopBtn"     class="btn red">ä¸­æ­¢</button>
        </div>
      </div>

      <div style="margin-top:8px">
        <strong>å‚åŠ è€…ï¼ˆæœ€å¤§5äººï¼‰</strong>
        <div id="playersList" class="row" style="margin-top:6px;flex-wrap:wrap"></div>
        <div class="muted" id="slotsLine" style="margin-top:4px"></div>
      </div>
    </section>

    <!-- å‡ºé¡Œã‚¨ãƒªã‚¢ -->
    <section id="qArea" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="muted"><span id="qIdx">å•é¡Œ 0/40</span> ï¼ <span>å›ç­”æ®‹ã‚Šï¼š</span><span id="leftTime">--s</span></div>
      </div>
      <div id="qText" class="big">å•é¡Œ</div>
      <div id="judge" class="result"></div>
      <div class="answer-grid">
        <div class="ans P"  data-choice="P">ãã‚‚ã¡</div>
        <div class="ans E"  data-choice="E">ã¾ã‚ã‚Š</div>
        <div class="ans I"  data-choice="I">ã§ãã‚‹ã“ã¨</div>
        <div class="ans Ph" data-choice="Ph">ã‹ã‚‰ã ï¼†ç—…æ°—</div>
      </div>
    </section>

    <!-- è¦³æˆ¦ãƒ»å¿œæ´ -->
    <section id="watchArea" class="card" style="display:none">
      <h3 style="margin:0 0 8px">è¦³æˆ¦ãƒ»å¿œæ´</h3>
      <div class="row">
        <input id="cheerName" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" style="min-width:160px">
        <textarea id="cheerText" placeholder="å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆèª°ã§ã‚‚é€ä¿¡å¯ï¼‰" rows="2" style="flex:1"></textarea>
        <button id="cheerSend" class="btn gray">é€ä¿¡</button>
        <button id="cheerBtn" class="btn orange">å¿œæ´</button>
      </div>
      <div id="shouts" style="margin-top:8px" class="muted"></div>
    </section>

    <section class="card muted">
      ãƒ»URLã‚¢ã‚¯ã‚»ã‚¹ â†’ åå‰å…¥åŠ› â†’ ãƒ«ãƒ¼ãƒ é¸æŠ â†’ ã€Œå‚åŠ ã€ã¾ãŸã¯ã€Œè¦³æˆ¦ã€ â†’ï¼ˆãƒ›ã‚¹ãƒˆãŒã€Œå‹Ÿé›†é–‹å§‹ã€ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ï¼‰â†’ 40å•ãŒé€£ç¶šã§å‡ºé¡Œã€‚  
      ãƒ»å…ˆç€1åã®ã¿æœ‰åŠ¹ã€æ­£è§£ +2ç‚¹ï¼ä¸æ­£è§£ -3ç‚¹ã€å›ç­”ã¯8ç§’ã€åˆ¤å®šã¯2ç§’è¡¨ç¤ºã—ã¦æ¬¡ã¸è‡ªå‹•é€²è¡Œã€‚<br>
      ãƒ»çµ‚äº†æ™‚ã«æˆç¸¾ã‚’é›†è¨ˆã€‚éŸ³å£°ã¯å³ä¸Šãƒˆã‚°ãƒ«ã® mp3 ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    </section>
  </main>

  <!-- éŸ³å£°ï¼ˆåŒãƒ•ã‚©ãƒ«ãƒ€ï¼‰ -->
  <audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
  <audio id="sndCorrect"   src="se_correct.mp3" preload="auto"></audio>
  <audio id="sndWrong"     src="se_wrong.mp3"   preload="auto"></audio>
  <audio id="sndRecruit"   src="bosyu.mp3"      preload="auto"></audio>
  <audio id="sndGong"      src="gongu.mp3"      preload="auto"></audio>
  <audio id="sndCheer"     src="kansei.mp3"     preload="auto"></audio>

  <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
  <div id="countOverlay"><div id="countText">3</div></div>

  <!-- Firebase v12ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆï¼‰ -->
  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics }    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc,
      collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp,
      runTransaction, increment
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ===== Firebase è¨­å®šï¼ˆpeip-with5ï¼‰ ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
      authDomain: "peip-with5.firebaseapp.com",
      projectId: "peip-with5",
      storageBucket: "peip-with5.firebasestorage.app",
      messagingSenderId: "609048243686",
      appId: "1:609048243686:web:a38452d1872d4ec28cba27",
      measurementId: "G-YCB8S47ENW"
    };
    const app = initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch(e){ /* Analyticsã¯å¿…é ˆã§ã¯ãªã„ */ }
    const db = getFirestore(app);

    /* ===== å•é¡Œãƒ—ãƒ¼ãƒ« â†’ ãƒ©ãƒ³ãƒ€ãƒ 40å• ===== */
    const POOL = [
      { text: "å­ã©ã‚‚ã«ä¼šã„ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "æ´—æ¿¯ç‰©ã«ã—ã‚ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "ãƒˆã‚¤ãƒ¬ã§ç«‹ä½ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ä¾¿ç§˜ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "æœé£Ÿã®é£²ã¿ç‰©ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "ãƒˆã‚¤ãƒ¬ã®æ‰‹ã™ã‚Šã«ãã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "æ­¯ç£¨ãã¯ä¸€äººã§è¡Œãˆã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ã‚€ã›ã“ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å†·è”µåº«ã«æ¶ˆè²»æœŸé™ãŒéããŸé£Ÿå“ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "æ­©è¡Œå™¨ã‚’ä½¿ãˆã°è‡ªç«‹æ­©è¡Œã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è¶³ã«ã‚€ãã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "å¥½ããªéŸ³æ¥½ï¼ˆæ›²ãƒ»æ­Œæ‰‹ï¼‰ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "æ´—é¢æ‰€ã®åºŠã¯æ¿¡ã‚Œã¦ã„ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "ãƒˆã‚¤ãƒ¬ã®ãƒœã‚¿ãƒ³ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è‚Œã¯ä¹¾ç‡¥ã—ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "æš®ã‚‰ã—ã§å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ãªã„ã‹ï¼Ÿ", answer: "P" },{ text: "æ¯è‹¦ã—ã•ã‚„èƒ¸ã®åœ§è¿«æ„Ÿã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ç€æ›¿ãˆã¯ä»‹åŠ©ãªã—ã§ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "é£Ÿæ¬²ã‚„æ°´åˆ†æ‘‚å–é‡ã¯ã©ã†ã‹ï¼Ÿ", answer: "Ph" },
      { text: "æ˜”ã—ã¦ã„ãŸä»•äº‹ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "ä½¿ç”¨ã—ã¦ã„ã‚‹ç¦ç¥‰ç”¨å…·ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
      { text: "é›»è©±ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è¦–åŠ›ã¯ã©ã®ç¨‹åº¦ã‹ï¼Ÿ", answer: "Ph" },
      { text: "é£Ÿã¹ãŸã„ã‚‚ã®ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "è‡ªå®…ã§10ãƒŸãƒªä»¥ä¸Šã®æ®µå·®ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
      { text: "ãŠèŒ¶ã‚’å…¥ã‚Œã¦é£²ã‚€ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å¤œé–“ã®ç¡çœ çŠ¶æ³ã¯ã©ã†ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ç¿’æ…£ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "åˆ©ç”¨ã—ã¦ã„ã‚‹ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
      { text: "ä½“æ“ã§ä½“ã‚’å‹•ã‹ã›ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ãµã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "è¶£å‘³ã‚’å†é–‹ã—ãŸã„æ€ã„ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å±…å®¤ã®æ¸©åº¦ãƒ»å®¤æ¸©ã¯ï¼Ÿ", answer: "E" },
      { text: "é£Ÿäº‹ã®æº–å‚™ã¯ä¸€äººã§ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è…°ç—›ãªã©ä½“ã®ç—›ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "èª¿å‘³æ–™ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "è–¬ã®ç®¡ç†ã§æ‰‹ä¼ã£ã¦ã»ã—ã„ã“ã¨ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
      { text: "è–¬ã®ç®¡ç†ã¯ä¸€äººã§è¡Œãˆã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ã¾ã¶ãŸã«ç›®ã‚„ã«ã¯ã¤ã„ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ã©ã®ã‚ˆã†ãªç’°å¢ƒã§å¯ãŸã„æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "ã‚³ãƒ¼ãƒ«ã®ãƒœã‚¿ãƒ³ã¯é³´ã‚‹ã‹ï¼Ÿ", answer: "E" },
      { text: "åº§ä½ã‚’ã¨ã‚‹ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å·»ãçˆªã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ä½•ã‚’ã—ã¦ã„ã‚‹æ™‚ãŒå¹¸ã›ã‚’æ„Ÿã˜ã‚‹æ™‚ã‹ï¼Ÿ", answer: "P" },{ text: "ç¾åœ¨ã€äº¤æµã®ã‚ã‚‹äººã¯èª°ã‹ï¼Ÿ", answer: "E" },
      { text: "è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å¤œé–“ã«ä¸çœ ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
      { text: "ãŠæ°—ã«å…¥ã‚Šã®æœã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å±…å®¤ã®æ›æ°—çŠ¶æ³ã¯ï¼Ÿ", answer: "E" }
    ];
    const pickDeck = ()=> {
      const idx = [...Array(POOL.length).keys()];
      for(let i=idx.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [idx[i],idx[j]]=[idx[j],idx[i]]; }
      return idx.slice(0,40);
    };

    /* ===== DOM ===== */
    const el = (id)=>document.getElementById(id);
    const roomsGrid = el('roomsGrid'), roomInfo = el('roomInfo');
    const joinArea = el('joinArea'), roomArea = el('roomArea'), qArea = el('qArea'), watchArea = el('watchArea');
    const playersList = el('playersList'), slotsLine = el('slotsLine'), statePill = el('statePill'), roomIdLabel = el('roomIdLabel');
    const qText = el('qText'), qIdx = el('qIdx'), leftTime = el('leftTime'), judge = el('judge'), remainQ = el('remainQ');
    const countOverlay = el('countOverlay'), countText = el('countText');
    const recruitRemain = el('recruitRemain'), myRankEl = el('myRank');

    /* ===== éŸ³ ===== */
    let soundEnabled = true;
    const snd = {
      cd: el('sndCountdown'), ok: el('sndCorrect'), ng: el('sndWrong'),
      recruit: el('sndRecruit'), gong: el('sndGong'), cheer: el('sndCheer')
    };
    const safePlay = (a)=>{ if(!soundEnabled) return; try{ a.currentTime=0; a.play(); }catch(_){} };
    el('soundToggle').addEventListener('change', e=>{
      soundEnabled = e.target.checked; el('soundLabel').textContent = soundEnabled ? 'ON':'OFF';
      // ãƒŸãƒ¥ãƒ¼ãƒˆã‚‚åŒæœŸ
      Object.values(snd).forEach(a=>a.muted = !soundEnabled);
    });

    /* ===== çŠ¶æ…‹ ===== */
    const MAX_PLAYERS = 5, ANSWER_MS = 8000, REVIEW_MS = 2000, CD_MS = 3000, RECRUIT_MS = 60000;
    const ROOMS = Array.from({length:15},(_,i)=>`room-${String(i+1).padStart(2,'0')}`);

    let me = { id: uid(), name:'', isHost:false, spectator:false };
    let roomId = null, roomRef = null, playersRef = null, shoutsRef = null;
    let playersCache = [], roomSnap = null, tickTimer = null, leftTimer = null, recruitTimer = null;

    function uid(){ const k='peip-uid'; let v=localStorage.getItem(k); if(!v){ v='u_'+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v); } return v; }
    function esc(s){return String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]))}

    /* ===== ãƒ«ãƒ¼ãƒ ä¸€è¦§ ===== */
    function renderRooms(list){
      roomsGrid.innerHTML = '';
      list.forEach(r=>{
        const btn = document.createElement('button'); btn.type='button'; btn.className='room-btn'; btn.dataset.id=r.id;
        const st = r.data?.state||'idle';
        const stLabel = st==='recruit' ? 'å‹Ÿé›†ä¸­' : (st==='question'||st==='countdown'||st==='review' ? 'è©¦åˆä¸­ï¼ˆè¦³æˆ¦ã®ã¿å¯ï¼‰' : 'ç©ºå®¤');
        const stClass  = st==='recruit' ? 'status-recruit' : (st==='question'||st==='countdown'||st==='review' ? 'status-live' : 'status-free');
        btn.innerHTML = `<div><b>${r.id}</b></div>
                         <div class="${stClass}">${stLabel}</div>
                         <div class="muted">å‚åŠ è€…: ${r.data?.players||0} / ${MAX_PLAYERS}</div>`;
        btn.onclick = ()=>{
          document.querySelectorAll('.room-btn').forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          roomId = r.id;
          el('joinBtn').disabled = false;
          el('watchBtn').disabled = false;
          roomInfo.textContent = `é¸æŠä¸­ï¼š${r.id}ï¼ˆ${stLabel}ï¼‰`;
        };
        roomsGrid.appendChild(btn);
      });
    }
    async function watchRooms(){
      onSnapshot(collection(db,'rooms'), (snap)=>{
        const list = ROOMS.map(id=>{
          const d = snap.docs.find(x=>x.id===id)?.data()||{};
          return { id, data: { state:d.state||'idle', players:d.players||0 } };
        });
        renderRooms(list);
      });
    }

    /* ===== å‚åŠ ï¼è¦³æˆ¦ ===== */
    el('joinBtn').onclick = async ()=>{
      const name = el('nameInput').value.trim(); if(!name){ alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if(!roomId){ alert('ãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      me = { id: uid(), name, isHost: !!el('hostCheck').checked, spectator:false };
      await enterRoom(false);
    };
    el('watchBtn').onclick = async ()=>{
      const name = el('nameInput').value.trim() || 'è¦³æˆ¦ã•ã‚“';
      if(!roomId){ alert('ãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      me = { id: uid(), name, isHost:false, spectator:true };
      await enterRoom(true);
    };

    async function enterRoom(asWatch){
      roomRef = doc(db, 'rooms', roomId);
      playersRef = collection(roomRef, 'players');
      shoutsRef  = collection(roomRef, 'shouts');

      const rs = await getDoc(roomRef);
      if(!rs.exists()){
        await setDoc(roomRef,{ state:'idle', currentIndex:0, deck:[], players:0, hostId:'', createdAt:serverTimestamp() });
      }

      if(!asWatch){
        const data = (await getDoc(roomRef)).data()||{};
        // è©¦åˆä¸­ã¯å‚åŠ ä¸å¯ï¼ˆè¦³æˆ¦ã¯å¯ï¼‰
        if(['question','countdown','review'].includes(data.state||'')){
          alert('ç¾åœ¨ã“ã®ãƒ«ãƒ¼ãƒ ã¯è©¦åˆä¸­ã®ãŸã‚ã€å‚åŠ ã¯ã§ãã¾ã›ã‚“ï¼ˆè¦³æˆ¦ã¯å¯èƒ½ã§ã™ï¼‰');
          return;
        }
        // å®šå“¡ãƒã‚§ãƒƒã‚¯
        const members = await getDocs(playersRef);
        if(members.size >= MAX_PLAYERS){ alert('å®šå“¡ã«é”ã—ã¦ã„ã¾ã™'); return; }
        await setDoc(doc(playersRef, me.id), {
          name: me.name, score:0, correct:0, wrong:0, time:0, isHost:me.isHost,
          joinedAt: serverTimestamp(), lastSeen: serverTimestamp()
        });
        await updateDoc(roomRef,{ players: increment(1) });
      }

      // è¡¨ç¤ºã®åˆ‡æ›¿
      joinArea.style.display='none';
      roomArea.style.display='block';
      watchArea.style.display='block';
      roomIdLabel.textContent = roomId;

      listenRoom();
      listenPlayers();
      listenShouts();

      // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼ˆé€”ä¸­é€€å‡ºã®è‡ªå‹•å‰Šé™¤ç”¨ï¼‰
      setInterval(async ()=>{
        if(!me.spectator){
          try{ await updateDoc(doc(playersRef, me.id),{ lastSeen: serverTimestamp() }); }catch(_){}
        }
      }, 20000);
    }

    /* ===== é€€å‡º ===== */
    el('leaveBtn').onclick = async ()=>{
      await leaveRoom();
    };
    async function leaveRoom(){
      if(!roomRef){ location.reload(); return; }
      try{
        if(!me.spectator){ await deleteDoc(doc(playersRef, me.id)); await updateDoc(roomRef,{ players: increment(-1) }); }
      }catch(_){}
      location.reload();
    }

    /* ===== å‚åŠ è€…è¡¨ç¤ºãƒ»é †ä½è¨ˆç®— ===== */
    function listenPlayers(){
      onSnapshot(query(playersRef, orderBy('joinedAt','asc')), snap=>{
        const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() })); playersCache = arr;
        // ä¸€è¦§
        playersList.innerHTML = arr.map(p=>{
          const you = p.id===me.id ? '<span class="chip name-you">ã‚ãªãŸ</span>' : '';
          const host= p.isHost     ? '<span class="chip name-host">ãƒ›ã‚¹ãƒˆ</span>' : '';
          return `<div class="pill">${esc(p.name)} ${you} ${host} <span class="chip">${Number(p.score||0)}pt</span></div>`;
        }).join('');
        // æ®‹ã‚Šæ 
        const remain = Math.max(0, MAX_PLAYERS - arr.length);
        slotsLine.textContent = `æ®‹ã‚Šï¼šã‚ã¨ ${remain} å`;
        // é †ä½
        const sorted = [...arr].sort((a,b)=>{
          if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
          if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
          if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
          return (a.time||0)-(b.time||0);
        });
        const idx = sorted.findIndex(p=>p.id===me.id);
        myRankEl.textContent = (idx>=0) ? `${idx+1}ä½` : 'â€ä½';
      });
    }

    /* ===== è¦³æˆ¦ã‚³ãƒ¡ãƒ³ãƒˆ ===== */
    function listenShouts(){
      onSnapshot(query(shoutsRef, orderBy('createdAt','desc'), limit(20)), snap=>{
        const html = snap.docs.map(d=>{
          const x=d.data(); return `<div>ğŸ“£ <b>${esc(x.name||'åŒ¿å')}</b>ï¼š${esc(x.text||'')}</div>`;
        }).join('');
        el('shouts').innerHTML = html || '<span class="muted">ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</span>';
      });
    }
    el('cheerSend').onclick = async ()=>{
      try{
        await addDoc(shoutsRef, { name: el('cheerName').value||'åŒ¿å', text: el('cheerText').value||'', createdAt: serverTimestamp() });
        el('cheerText').value = '';
      }catch(_){}
    };
    el('cheerBtn').onclick = ()=> safePlay(snd.cheer);

    /* ===== ãƒ«ãƒ¼ãƒ è³¼èª­ï¼ˆçŠ¶æ…‹ç®¡ç†ï¼‰ ===== */
    function listenRoom(){
      if(roomSnap) roomSnap(); // è§£é™¤
      roomSnap = onSnapshot(roomRef, snap=>{
        const r = snap.data()||{};
        updateRoomUI(r);
      });
    }

    function updateRoomUI(r){
      // ãƒ›ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡
      el('hostTools').style.display = (me.isHost && !me.spectator) ? 'flex' : 'none';

      // çŠ¶æ…‹è¡¨ç¤º
      const st = r.state||'idle';
      const stLabel = st==='recruit' ? 'å‹Ÿé›†ä¸­' : st==='countdown' ? 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³' :
                      st==='question' ? 'å‡ºé¡Œä¸­' : st==='review' ? 'åˆ¤å®šä¸­' :
                      st==='ended' ? 'çµ‚äº†' : 'å¾…æ©Ÿä¸­';
      statePill.textContent = stLabel;

      // æ®‹å•æ•°
      const deck = r.deck||[];
      remainQ.textContent = deck.length ? (deck.length - (r.currentIndex||0)) : '--';

      // å‹Ÿé›†æ®‹ã‚Š
      if(recruitTimer) clearInterval(recruitTimer);
      recruitRemain.textContent = '--:--';
      if(st==='recruit'){
        const until = r.recruitUntil||0;
        recruitTimer = setInterval(()=>{
          const left = Math.max(0, until - Date.now());
          recruitRemain.textContent = `${String(Math.floor(left/1000)).padStart(2,'0')}s`;
          if(left<=0) clearInterval(recruitTimer);
        }, 200);
      }

      // å‡ºé¡Œã‚¨ãƒªã‚¢
      if(['question','review','ended'].includes(st)){ qArea.style.display='block'; } else { qArea.style.display='none'; judge.textContent=''; }

      // é€²è¡Œã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ®‹ã‚Š8ç§’è¡¨ç¤ºï¼‰
      if(leftTimer){ clearInterval(leftTimer); leftTimer=null; }
      if(st==='question'){
        leftTimer = setInterval(()=>{
          const left = Math.max(0, (r.questionUntil||0) - Date.now());
          leftTime.textContent = (left/1000).toFixed(1)+'s';
          if(left<=0) clearInterval(leftTimer);
        }, 100);
      }else{
        leftTime.textContent = '--s';
      }

      // å•é¡Œæ–‡
      const deckIdx = (r.deck||[])[r.currentIndex||0];
      const q = (typeof deckIdx === 'number') ? POOL[deckIdx] : null;
      qIdx.textContent = `å•é¡Œ ${Math.min((r.currentIndex||0)+1, (r.deck||[]).length||40)} / ${(r.deck||[]).length||40}`;
      qText.textContent = q ? `ã€Œ${q.text}ã€` : 'æº–å‚™ä¸­â€¦';

      // åˆ¤å®šè¡¨ç¤º
      if(st==='review'){
        judge.innerHTML = r.lastResult==='correct' ? '<span class="ok">â­• æ­£è§£ï¼</span>' :
                           r.lastResult==='wrong'   ? '<span class="ng">âŒ ä¸æ­£è§£</span>' : '';
      }else if(st==='ended'){
        // é›†è¨ˆè¡¨ç¤º
        finishDisplay();
      }else{
        judge.textContent='';
      }

      // å›ç­”ãƒœã‚¿ãƒ³å¯å¦
      const can = (st==='question' && !me.spectator && !r.buzzedBy && (r.questionUntil||0) > Date.now());
      setAnswersDisabled(!can);

      // ãƒ›ã‚¹ãƒˆã®è‡ªå‹•é€²è¡Œï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†â†’å•é¡Œé–‹å§‹ï¼åˆ¤å®šçµ‚äº†â†’æ¬¡ã¸ï¼å‹Ÿé›†çµ‚äº†â†’è‡ªå‹•ç· åˆ‡ï¼‰
      if(me.isHost && !me.spectator){
        if(st==='recruit' && (r.recruitUntil||0) <= Date.now()){
          // å‹Ÿé›†ãŒåˆ‡ã‚ŒãŸã‚‰ç· åˆ‡
          closeRecruit();
        }
        if(st==='countdown' && (r.countdownUntil||0) <= Date.now()){
          beginQuestion( r.currentIndex||0, r.deck||pickDeck() );
        }
        if(st==='review' && (r.nextOpen||0) <= Date.now()){
          const next = (r.currentIndex||0) + 1;
          if(next >= (r.deck||[]).length){
            // çµ‚äº†
            updateDoc(roomRef,{ state:'ended' });
            safePlay(snd.gong);
          }else{
            // æ¬¡ã®å•é¡Œ
            beginQuestion(next, r.deck||pickDeck());
          }
        }
      }
    }

    function setAnswersDisabled(flag){
      document.querySelectorAll('.ans').forEach(b=>{
        if(flag) b.classList.add('disabled'); else b.classList.remove('disabled');
      });
    }

    function finishDisplay(){
      // æœ€çµ‚é †ä½ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§è¨ˆç®—ã—ã¦è¡¨ç¤º
      const arr = [...playersCache].sort((a,b)=>{
        if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
        if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
        if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
        return (a.time||0)-(b.time||0);
      });
      const idx = arr.findIndex(p=>p.id===me.id);
      const rank = (idx>=0)? idx+1 : '-';
      qText.textContent = `å…¨å•çµ‚äº†ï¼ ã‚ãªãŸã®é †ä½ã¯ ${arr.length}äººä¸­ ${rank}ä½ ã§ã—ãŸã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚`;
      leftTime.textContent = '0.0s';
      setAnswersDisabled(true);
    }

    /* ===== ãƒ›ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ ===== */
    const hostOnly = (fn)=> async ()=>{ if(!(me.isHost && !me.spectator)){ alert('ãƒ›ã‚¹ãƒˆã®ã¿æ“ä½œã§ãã¾ã™'); return; } await fn(); };
    const recruitBtn = el('recruitBtn'), startBtn = el('startBtn'), stopBtn = el('stopBtn'), closeBtn = el('closeBtn');

    recruitBtn.onclick = hostOnly(async ()=>{
      // å‹Ÿé›†é–‹å§‹
      await updateDoc(roomRef,{ state:'recruit', recruitUntil: Date.now()+RECRUIT_MS });
      safePlay(snd.recruit);
    });
    closeBtn.onclick   = hostOnly(closeRecruit);
    async function closeRecruit(){ try{ await updateDoc(roomRef,{ recruitUntil: Date.now() }); }catch(_){ } }

    startBtn.onclick   = hostOnly(async ()=>{
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹ï¼ˆ3,2,1 ã®è¡¨ç¤ºï¼†éŸ³ï¼‰
      const d = (await getDoc(roomRef)).data()||{};
      const deck = (d.deck && d.deck.length) ? d.deck : pickDeck();
      await updateDoc(roomRef,{ state:'countdown', countdownUntil: Date.now()+CD_MS, deck, currentIndex:0, hostId: me.id, lastResult:null, buzzedBy:null });
      showCountdown();
    });
    stopBtn.onclick    = hostOnly(async ()=>{
      await updateDoc(roomRef,{ state:'idle', deck:[], currentIndex:0, lastResult:null, buzzedBy:null });
    });

    function showCountdown(){
      // è¦–è¦šã‚«ã‚¦ãƒ³ãƒˆï¼ˆéŸ³ã¯è³¼èª­å´ã§ã‚‚å†ç”Ÿã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
      safePlay(snd.cd);
      const marks = ['3','2','1','ã‚¹ã‚¿ãƒ¼ãƒˆï¼']; let i=0;
      countOverlay.style.display='flex'; countText.textContent=marks[i];
      const id = setInterval(()=>{ i++; if(i<marks.length){ countText.textContent=marks[i]; countText.classList.remove('pop'); void countText.offsetWidth; countText.classList.add('pop'); } else { clearInterval(id); countOverlay.style.display='none'; }}, 700);
    }

    /* ===== å‡ºé¡Œé–‹å§‹ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ ===== */
    async function beginQuestion(index, deck){
      const qIdx = deck[index];
      await updateDoc(roomRef,{
        state:'question', currentIndex:index, deck,
        buzzedBy:null, answerChoice:null, lastResult:null,
        questionStart: Date.now(), questionUntil: Date.now()+ANSWER_MS
      });
    }

    /* ===== å›ç­”ï¼ˆå…ˆç€1åã ã‘ï¼‰ ===== */
    document.querySelectorAll('.ans').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const choice = btn.dataset.choice;
        // å…ˆç€ç¢ºå®šã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§
        await runTransaction(db, async (tx)=>{
          const docRoom = await tx.get(roomRef); if(!docRoom.exists()) return;
          const r = docRoom.data();
          if(r.state!=='question') return;
          if((r.questionUntil||0) < Date.now()) return;
          if(r.buzzedBy) return; // å…ˆç€æ¸ˆã¿
          // å‹è€…ç¢ºå®š
          tx.update(roomRef,{ state:'review', buzzedBy: me.id, answerChoice: choice });
          // åˆ¤å®š
          const deck = r.deck||[]; const q = POOL[ deck[r.currentIndex||0] ];
          const ok = (choice === (q?.answer));
          const delta = ok ? +2 : -3;
          tx.update(roomRef,{ lastResult: ok?'correct':'wrong', nextOpen: Date.now()+REVIEW_MS });
          // ã‚¹ã‚³ã‚¢åæ˜ 
          const ms = Math.max(0, Date.now() - (r.questionStart||Date.now()));
          const pRef = doc(playersRef, me.id);
          tx.set(pRef, { name:me.name }, { merge:true });
          tx.update(pRef, {
            score: increment(delta),
            correct: increment(ok?1:0),
            wrong: increment(ok?0:1),
            time: increment(ms)
          });
        }).catch(()=>{});
        // éŸ³
        const rs = (await getDoc(roomRef)).data()||{};
        if(rs.lastResult==='correct') safePlay(snd.ok); else if(rs.lastResult==='wrong') safePlay(snd.ng);
      });
    });

    /* ===== ãƒ«ãƒ¼ãƒ  UI åˆæœŸåŒ– ===== */
    watchRooms();

  </script>
</body>
</html>
