<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<style>
  :root{
    --card:#ffffff;
    --muted:#666;
    --brand:#ff7f50;
    --ok:#2e7d32;
    --ng:#d32f2f;
  }
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;background:#f6f7f8;color:#222;}
  header{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;justify-content:space-between;background:#fff;border-bottom:1px solid #eee;padding:10px 12px}
  h1{margin:0;font-size:18px}
  main{max-width:1000px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin:10px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  input[type="text"]{padding:10px;border:1px solid #ddd;border-radius:10px;min-width:220px}
  button{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;background:#007bff;color:#fff;font:inherit}
  button.secondary{background:#6c757d}
  button.warn{background:#ff9800}
  button.danger{background:#dc3545}
  button.green{background:#2e7d32}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0}
  .status-ok{color:#2e7d32}
  .status-ng{color:#d32f2f}
  .grid-rooms{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px}
  .room{border:1px solid #eee;border-radius:10px;padding:10px}
  .room .name{font-weight:700}
  .room .state{font-size:12px;color:#444;margin:4px 0}
  .room button{width:100%}

  /* === 問題＆回答 === */
  .q-header{display:flex;justify-content:space-between;align-items:center}
  .q-text{font-size:24px;font-weight:800;text-align:center;margin:12px 0 2px}
  .result-line{text-align:center;min-height:1.8em;font-size:18px}
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;justify-items:center;margin:12px 0}
  /* 完全な円（端末に依らず真円） */
  .ans{
    width:clamp(120px, 28vw, 280px);
    aspect-ratio:1/1;           /* ← 高さ＝幅（決め手）*/
    border-radius:50%;          /* ← 真円 */
    display:grid;place-items:center;
    color:#fff;font-weight:900;font-size:18px;
    border:4px solid #fff;
    box-shadow:0 10px 26px rgba(0,0,0,.18), inset 0 2px 0 rgba(255,255,255,.5);
    user-select:none;
  }
  .ans.P{background:#e74c3c}
  .ans.E{background:#3498db}
  .ans.I{background:#ffca28;color:#222}
  .ans.Ph{background:#2ecc71}
  .ans.disabled{opacity:.45;pointer-events:none}

  /* カウントダウンオーバーレイ */
  #countOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);color:#fff;display:none;align-items:center;justify-content:center;font-size:110px;font-weight:900;z-index:999}
  #countText{filter:drop-shadow(0 10px 25px rgba(0,0,0,.7))}
  .pop{animation:pop .35s ease-out}
  @keyframes pop{0%{transform:scale(.7)}60%{transform:scale(1.15)}100%{transform:scale(1)}}

  .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .tag{padding:2px 8px;border-radius:999px;font-weight:700;background:#f2f2f2}
  .you{color:#000} .host{color:#000}
</style>
</head>
<body>

<header>
  <h1>P.E.I.P. 早押しクイズ</h1>
  <div class="right">
    <label class="row" style="gap:6px"><input type="checkbox" id="soundToggle" checked> 音声: <b id="soundState">ON</b></label>
    <button id="exitBtn" class="secondary">退出する</button>
  </div>
</header>

<main>
  <!-- ========== スタート画面 ========== -->
  <section id="homeView" class="card">
    <h3 style="margin:0 0 8px">① 名前を入力</h3>
    <div class="row" style="margin-bottom:10px">
      <input id="nameInput" type="text" placeholder="表示名を入力" />
      <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck"> ホストになる</label>
    </div>

    <h3 style="margin:8px 0 8px">② ルームを選ぶ（15室 / 状態つき）</h3>
    <div id="roomsGrid" class="grid-rooms"></div>

    <div class="row" style="margin-top:10px">
      <button id="joinBtn" class="green" disabled>参加</button>
      <button id="watchBtn" class="secondary" disabled>観戦</button>
      <span class="muted">※ 先に上の一覧でルームを選んでから押してください</span>
    </div>
  </section>

  <!-- ========== ルーム画面 ========== -->
  <section id="roomView" class="card" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:8px">
        <span>ルーム：<b id="roomId" class="pill"></b></span>
        <span class="muted">状態：</span><span id="statePill" class="pill">-</span>
        <span class="muted">募集終了まで：</span><span id="recruitClock" class="pill">--:--</span>
        <span class="muted">残り問題：</span><span id="remainQ" class="pill">--</span>
        <span class="muted">あなたの順位：</span><span id="myRank" class="pill">-位</span>
      </div>
      <div id="hostTools" class="row" style="display:none">
        <button id="recruitBtn" class="warn">募集開始</button>
        <button id="startBtn" class="green">ゲーム開始</button>
        <button id="stopBtn" class="danger">中止</button>
      </div>
    </div>

    <!-- 参加者表示 -->
    <div class="row" style="margin-top:10px;align-items:center;flex-wrap:wrap">
      <strong>参加者（最大5人）</strong>
      <div id="playersLine" class="row" style="gap:8px;flex-wrap:wrap"></div>
    </div>

    <!-- 問題 -->
    <div class="card" style="margin-top:12px">
      <div class="q-header">
        <div id="qIndex" class="muted">問題 - / 40</div>
        <div id="leftTime" class="pill">0.0s</div>
      </div>
      <div id="qText" class="q-text">ホストが「ゲーム開始」を押すと表示されます。</div>
      <div id="judgeLine" class="result-line"></div>

      <div class="answer-grid">
        <div class="ans P"  data-choice="P">きもち</div>
        <div class="ans E"  data-choice="E">まわり</div>
        <div class="ans I"  data-choice="I">できること</div>
        <div class="ans Ph" data-choice="Ph">からだ＆病気</div>
      </div>
    </div>

    <!-- 観戦・応援（コメントなし / 応援のみ） -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>観戦・応援</strong> <span class="muted">（コメント機能なし／「応援」すると全員に歓声が鳴ります）</span></div>
        <button id="cheerBtn" class="warn">応援</button>
      </div>
    </div>
  </section>
</main>

<!-- ====== 効果音（index.html と同じフォルダに配置） ====== -->
<audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
<audio id="sndOK"        src="se_correct.mp3" preload="auto"></audio>
<audio id="sndNG"        src="se_wrong.mp3"   preload="auto"></audio>
<audio id="sndGong"      src="gongu.mp3"      preload="auto"></audio>
<audio id="sndCheer"     src="kansei.mp3"     preload="auto"></audio>
<audio id="sndBosyu"     src="bosyu.mp3"      preload="auto"></audio>

<div id="countOverlay"><span id="countText">3</span></div>

<!-- ====== Firebase（compat） ====== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ===== Firebase 設定（peip-with5） ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== パラメータ ===== */
const MAX_PLAYERS = 5;
const ANSWER_MS   = 8000;          // 1問の解答時間 8秒
const RECRUIT_MS  = 60000;         // 募集 60秒
const DECK_SIZE   = 40;            // 40問
const SCORE_OK =  +2;
const SCORE_NG =  -3;

/* ===== 共有ユーティリティ ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const esc = s => String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]));
function uid(){ const k="peip-uid"; let v=localStorage.getItem(k); if(!v){ v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
function play(id){ if(!soundOn) return; const el=$(id); try{ el.currentTime=0; el.play(); }catch(_){} }
function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

/* ===== 音声 ON/OFF ===== */
let soundOn = true;
$('#soundToggle').addEventListener('change',()=>{
  soundOn = $('#soundToggle').checked;
  $('#soundState').textContent = soundOn ? 'ON' : 'OFF';
});

/* ===== 問題プール（指定の文を使う） ===== */
const pool = [
 {text:"子どもに会いたいと思っているか？",answer:"P"},{text:"洗濯物にしわはないか？",answer:"E"},
 {text:"トイレで立位をとることができるか？",answer:"I"},{text:"便秘はないか？",answer:"Ph"},
 {text:"朝食の飲み物にこだわりはあるか？",answer:"P"},{text:"トイレの手すりにぐらつきはないか？",answer:"E"},
 {text:"歯磨きは一人で行えているか？",answer:"I"},{text:"むせこみはないか？",answer:"Ph"},
 {text:"デイサービスを楽しみにしているか？",answer:"P"},{text:"冷蔵庫に消費期限が過ぎた食品はないか？",answer:"E"},
 {text:"歩行器を使えば自立歩行はできるか？",answer:"I"},{text:"足にむくみはないか？",answer:"Ph"},
 {text:"好きな音楽（曲・歌手）は何か？",answer:"P"},{text:"洗面所の床は濡れていないか？",answer:"E"},
 {text:"トイレのボタンを操作することはできるか？",answer:"I"},{text:"肌は乾燥していないか？",answer:"Ph"},
 {text:"暮らしで困っていることはないか？",answer:"P"},{text:"息苦しさや胸の圧迫感はないか？",answer:"Ph"},
 {text:"着替えは介助なしでできるか？",answer:"I"},{text:"食欲や水分摂取量はどうか？",answer:"Ph"},
 {text:"昔していた仕事は何か？",answer:"P"},{text:"使用している福祉用具は何か？",answer:"E"},
 {text:"電話をかけることができるか？",answer:"I"},{text:"視力はどの程度か？",answer:"Ph"},
 {text:"食べたいものはあるか？",answer:"P"},{text:"自宅で10ミリ以上の段差はないか？",answer:"E"},
 {text:"お茶を入れて飲むことはできるか？",answer:"I"},{text:"夜間の睡眠状況はどうか？",answer:"Ph"},
 {text:"習慣となっていることは何か？",answer:"P"},{text:"利用している介護サービスは何か？",answer:"E"},
 {text:"体操で体を動かせているか？",answer:"I"},{text:"ふらつきはないか？",answer:"Ph"},
 {text:"趣味を再開したい思いはあるか？",answer:"P"},{text:"居室の温度・室温は？",answer:"E"},
 {text:"食事の準備は一人でできるか？",answer:"I"},{text:"腰痛など体の痛みはないか？",answer:"Ph"},
 {text:"調味料にこだわりはあるか？",answer:"P"},{text:"薬の管理で手伝ってほしいことはあるか？",answer:"P"},
 {text:"薬の管理は一人で行えているか？",answer:"I"},{text:"まぶたに目やにはついていないか？",answer:"Ph"},
 {text:"どのような環境で寝たい思っているか？",answer:"P"},{text:"コールのボタンは鳴るか？",answer:"E"},
 {text:"座位をとることはできているか？",answer:"I"},{text:"巻き爪はないか？",answer:"Ph"},
 {text:"何をしている時が幸せを感じる時か？",answer:"P"},{text:"現在、交流のある人は誰か？",answer:"E"},
 {text:"買い物リストを書くことはできるか？",answer:"I"},{text:"夜間に不眠はないか？",answer:"Ph"},
 {text:"お気に入りの服はあるか？",answer:"P"},{text:"居室の換気状況は？",answer:"E"}
];

/* ===== 画面状態 ===== */
let me = { id:uid(), name:"", isHost:false, spectator:false, roomId:null };
let selectedRoom = null;
let unsubRoom = null, unsubPlayers = null, timer=null, recruitTimer=null;

/* ===== ルーム一覧 ===== */
const roomsGrid = $('#roomsGrid');
const roomIds = Array.from({length:15},(_,i)=>`room-${String(i+1).padStart(2,'0')}`);

async function ensureRooms(){
  const batch = db.batch();
  for(const id of roomIds){
    const ref = db.collection('rooms').doc(id);
    const snap = await ref.get();
    if(!snap.exists){
      batch.set(ref,{ state:'idle', recruitingUntilMs:0, deck:[], curIdx:0, openUntilMs:0, answeredBy:null, answerChoice:null, lastResult:null, lastKey:"", createdAt:firebase.firestore.FieldValue.serverTimestamp() });
    }
  }
  await batch.commit().catch(()=>{});
}
function stateLabel(s){
  if(s==='idle') return '空室';
  if(s==='recruit') return '募集中';
  if(s==='question' || s==='result') return '試合中（観戦のみ可）';
  if(s==='ended') return '試合中（観戦のみ可）';
  return s;
}
async function renderRooms(){
  roomsGrid.innerHTML = '';
  for(const id of roomIds){
    const ref = db.collection('rooms').doc(id);
    const snap = await ref.get().catch(()=>null);
    const s = snap && snap.exists ? (snap.data().state||'idle') : 'idle';
    const card = document.createElement('div');
    card.className='room';
    card.innerHTML = `
      <div class="name">${id}</div>
      <div class="state muted">${stateLabel(s)}</div>
      <button class="secondary pickBtn" data-id="${id}">この部屋を選ぶ</button>
    `;
    roomsGrid.appendChild(card);
  }
  // クリック
  $$('.pickBtn').forEach(b=>{
    b.onclick = ()=>{
      selectedRoom = b.dataset.id;
      $('#joinBtn').disabled = false;
      $('#watchBtn').disabled = false;
      play('#sndBosyu');
      // 選択の見た目
      $$('.room').forEach(x=>x.style.outline='none');
      b.closest('.room').style.outline='3px solid #00bcd4';
    };
  });
}

/* ===== ホームのボタン ===== */
$('#joinBtn').onclick = async ()=>{
  const name = $('#nameInput').value.trim();
  if(!name){ alert('名前を入力してください'); return; }
  if(!selectedRoom){ alert('ルームを選んでください'); return; }
  play('#sndBosyu');
  me = { id:uid(), name, isHost: $('#hostCheck').checked, spectator:false, roomId:selectedRoom };

  const roomRef = db.collection('rooms').doc(me.roomId);
  const playersRef = roomRef.collection('players');
  // 枠チェック
  const cur = await playersRef.get();
  if(cur.size >= MAX_PLAYERS){ alert('参加可能人数（最大5人）に達しています'); return; }
  await playersRef.doc(me.id).set({
    name: me.name, isHost: !!me.isHost, score:0, correct:0, wrong:0,
    totalMs:0, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), lastSeen: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge:true});
  goRoom();
};
$('#watchBtn').onclick = async ()=>{
  const name = $('#nameInput').value.trim();
  if(!name){ alert('名前を入力してください'); return; }
  if(!selectedRoom){ alert('ルームを選んでください'); return; }
  play('#sndBosyu');
  me = { id:uid(), name, isHost:false, spectator:true, roomId:selectedRoom };
  goRoom();
};

/* ===== 退出 ===== */
$('#exitBtn').onclick = async ()=>{
  await leaveRoom();
  showHome();
};
async function leaveRoom(){
  try{
    if(me.roomId && !me.spectator){
      await db.collection('rooms').doc(me.roomId).collection('players').doc(me.id).delete();
    }
  }catch(e){}
  me.roomId = null;
  if(unsubRoom){ unsubRoom(); unsubRoom=null; }
  if(unsubPlayers){ unsubPlayers(); unsubPlayers=null; }
}

/* ===== 画面切替 ===== */
function showHome(){
  $('#homeView').style.display = 'block';
  $('#roomView').style.display = 'none';
  $('#nameInput').focus();
  renderRooms();
}

/* ===== ルームに入る ===== */
function goRoom(){
  $('#homeView').style.display = 'none';
  $('#roomView').style.display = 'block';
  $('#roomId').textContent = me.roomId;
  $('#remainQ').textContent = '--';
  $('#myRank').textContent = '-位';
  $('#judgeLine').textContent = '';
  $('#qText').textContent = 'ホストが「ゲーム開始」を押すと表示されます。';
  $('#qIndex').textContent = '問題 - / 40';
  setAnswersDisabled(true);

  // ホスト用ツール
  $('#hostTools').style.display = me.isHost ? 'flex' : 'none';

  // 監視：プレイヤー
  const playersRef = db.collection('rooms').doc(me.roomId).collection('players').orderBy('joinedAt','asc');
  if(unsubPlayers) unsubPlayers();
  unsubPlayers = playersRef.onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
    // 自動順位
    const ranking = [...arr].sort((a,b)=>{
      if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
      if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
      if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
      return (a.totalMs||0)-(b.totalMs||0);
    });
    const myIndex = ranking.findIndex(p=>p.id===me.id);
    $('#myRank').textContent = me.spectator ? '観戦' : (myIndex>=0? `${myIndex+1}位`:'-位');

    // 表示
    $('#playersLine').innerHTML = arr.map(p=>{
      const you  = p.id===me.id ? '<span class="you tag">あなた</span>' : '';
      const host = p.isHost ? '<span class="host tag">ホスト</span>' : '';
      return `<span class="pill">${esc(p.name)} ${you} ${host} <b>${p.score||0}pt</b></span>`;
    }).join('');
  });

  // 監視：ルーム
  const roomRef = db.collection('rooms').doc(me.roomId);
  if(unsubRoom) unsubRoom();
  unsubRoom = roomRef.onSnapshot(async snap=>{
    if(!snap.exists) return;
    const r = snap.data();
    $('#statePill').textContent = r.state || '-';

    // 残り問題
    const deck = Array.isArray(r.deck)? r.deck:[];
    const remain = deck.length>0 ? deck.length - (r.curIdx||0) : '--';
    $('#remainQ').textContent = remain;

    // リクルート時計
    if(recruitTimer) clearInterval(recruitTimer);
    if(r.state==='recruit' && r.recruitingUntilMs){
      recruitTimer = setInterval(()=>{
        const rest = Math.max(0, r.recruitingUntilMs - Date.now());
        const s = (rest/1000)|0;
        $('#recruitClock').textContent = `${String((s/60|0)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
      }, 200);
    }else{
      $('#recruitClock').textContent = '--:--';
    }

    // 出題 or 結果 or idle
    if(r.state==='question'){
      // 出題中
      const idx = clamp(r.curIdx||0,0, (deck.length||1)-1);
      const q = (deck.length>0) ? pool[ deck[idx] ] : pool[idx%pool.length];
      $('#qIndex').textContent = `問題 ${idx+1} / ${deck.length||DECK_SIZE}`;
      $('#qText').textContent = `「${q.text}」`;

      // カウントダウン
      if(timer) clearInterval(timer);
      timer = setInterval(()=>{
        const rest = Math.max(0, (r.openUntilMs||0) - Date.now());
        $('#leftTime').textContent = (rest/1000).toFixed(1)+'s';
        if(rest<=0){ clearInterval(timer); }
      }, 100);

      // 押せる条件
      const can = !me.spectator && !r.answeredBy && (r.openUntilMs||0) > Date.now();
      setAnswersDisabled(!can);
      $('#judgeLine').textContent = r.lastKey ? '' : ''; // 出題直後は消す
    }
    else if(r.state==='result'){
      setAnswersDisabled(true);
      // 判定音は lastKey が変わったら一度だけ
      if(r.lastKey && r.lastKey !== lastKeySeen){
        lastKeySeen = r.lastKey;
        $('#judgeLine').innerHTML = r.lastResult==='ok'
          ? `<span class="status-ok">⭕ 正解！</span>`
          : r.lastResult==='ng'
            ? `<span class="status-ng">❌ 不正解</span>` : '';
        if(r.lastResult==='ok') play('#sndOK');
        if(r.lastResult==='ng') play('#sndNG');
      }
    }
    else if(r.state==='ended'){
      setAnswersDisabled(true);
      $('#qIndex').textContent = '結果';
      $('#qText').innerHTML = `全問終了！ あなたの順位は <b id="finalRank">--</b> でした。お疲れさまでした。`;
      $('#judgeLine').textContent = '';
      play('#sndGong');
      // 最終順位（プレイヤー購読側ですでに算出済みだが、ここでも再描画）
    }
  });
}

/* ===== 回答ボタン ===== */
function setAnswersDisabled(flag){
  $$('.ans').forEach(b=>{ b.classList.toggle('disabled', !!flag); });
}
let lastKeySeen = '';
$$('.ans').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const choice = btn.dataset.choice;
    // 先着1名（room.answeredBy が未設定 & 時間内）だけ確定させる
    const roomRef = db.collection('rooms').doc(me.roomId);
    let win=false;
    await db.runTransaction(async tx=>{
      const doc = await tx.get(roomRef);
      if(!doc.exists) return;
      const r = doc.data();
      if(r.state!=='question') return;
      if((r.openUntilMs||0) < Date.now()) return;
      if(r.answeredBy) return;
      win = true;
      tx.update(roomRef,{ answeredBy: me.id, answerChoice: choice });
    });

    // ホストが判定＆スコア更新＆次問題へ
    if(win && me.isHost){
      const roomRef = db.collection('rooms').doc(me.roomId);
      const doc = await roomRef.get(); const r = doc.data();
      const deck = r.deck||[];
      const idx  = clamp(r.curIdx||0,0,(deck.length||1)-1);
      const q    = (deck.length>0)? pool[ deck[idx] ] : pool[idx%pool.length];
      const ok   = (r.answerChoice === q.answer);
      const delta= ok ? SCORE_OK : SCORE_NG;
      const nowKey = `${Date.now()}_${ok?'ok':'ng'}`;

      // 経過時間（早押し→「押した時点」まで）
      const used = ANSWER_MS - Math.max(0,(r.openUntilMs||0) - Date.now());
      const inc  = Math.max(0, used);

      const playersRef = roomRef.collection('players').doc(r.answeredBy);
      await Promise.all([
        playersRef.set({
          score: firebase.firestore.FieldValue.increment(delta),
          correct: firebase.firestore.FieldValue.increment(ok?1:0),
          wrong: firebase.firestore.FieldValue.increment(ok?0:1),
          totalMs: firebase.firestore.FieldValue.increment(inc)
        }, {merge:true}),
        roomRef.update({ state:'result', lastResult: ok?'ok':'ng', lastKey: nowKey })
      ]);

      // 2秒後に次へ
      setTimeout(async ()=>{
        const next = (r.curIdx||0)+1;
        if(next >= (deck.length||DECK_SIZE)){
          await roomRef.update({ state:'ended' });
        }else{
          await roomRef.update({
            state:'question', curIdx: next, answeredBy:null, answerChoice:null,
            lastResult:null, lastKey:'', openUntilMs: Date.now()+ANSWER_MS
          });
        }
      }, 2000);
    }
  });
});

/* ===== ホスト操作 ===== */
$('#recruitBtn').onclick = async ()=>{
  if(!me.isHost) return;
  play('#sndBosyu');
  await db.collection('rooms').doc(me.roomId).update({
    state:'recruit', recruitingUntilMs: Date.now()+RECRUIT_MS
  });
};
$('#startBtn').onclick = async ()=>{
  if(!me.isHost) return;
  // デッキ作成（プールからランダム40）
  const ids = [...Array(pool.length).keys()];
  ids.sort(()=>Math.random()-0.5);
  const deck = ids.slice(0, Math.min(DECK_SIZE, ids.length));

  // カウントダウン演出
  showCountdown(async ()=>{
    await db.collection('rooms').doc(me.roomId).update({
      state:'question', deck, curIdx:0, answeredBy:null, answerChoice:null,
      lastResult:null, lastKey:'', openUntilMs: Date.now()+ANSWER_MS
    });
  });
};
$('#stopBtn').onclick = async ()=>{
  if(!me.isHost) return;
  await db.collection('rooms').doc(me.roomId).update({
    state:'idle', recruitingUntilMs:0, deck:[], curIdx:0, openUntilMs:0,
    answeredBy:null, answerChoice:null, lastResult:null, lastKey:''
  });
};

/* ===== 応援 ===== */
$('#cheerBtn').onclick = async ()=>{
  play('#sndCheer'); // 自分は即鳴らす
  if(!me.roomId) return;
  const ref = db.collection('rooms').doc(me.roomId);
  await ref.update({ cheerKey: `${Date.now()}_${Math.random()}` }).catch(()=>{});
};
// 他クライアントへも鳴らす
db.collection('rooms').onSnapshot(snap=>{
  snap.docChanges().forEach(ch=>{
    const d = ch.doc.data();
    if(me.roomId && ch.doc.id===me.roomId && d.cheerKey && d.cheerKey !== lastCheerKey){
      lastCheerKey = d.cheerKey; play('#sndCheer');
    }
  });
});
let lastCheerKey = '';

/* ===== カウントダウン演出 ===== */
function showCountdown(onDone){
  const ov = $('#countOverlay'), txt=$('#countText');
  ov.style.display='flex';
  play('#sndCountdown');
  let seq = ['3','2','1','スタート！'];
  let i=0;
  const step=()=>{
    txt.textContent = seq[i];
    txt.classList.remove('pop'); void txt.offsetWidth; txt.classList.add('pop');
    i++;
    if(i<seq.length) setTimeout(step, 750);
    else setTimeout(()=>{ ov.style.display='none'; onDone && onDone(); }, 750);
  };
  step();
}

/* ===== 退室時のクリーンアップ ===== */
window.addEventListener('beforeunload', async ()=>{
  try{ if(me.roomId && !me.spectator){ await db.collection('rooms').doc(me.roomId).collection('players').doc(me.id).delete(); } }catch(e){}
});

/* ===== 起動 ===== */
(async function init(){
  await ensureRooms();
  await renderRooms();

  // 3つの入口ボタンで bosyu 音（ガイド通り）
  roomsGrid.addEventListener('click', e=>{
    if(e.target && e.target.classList.contains('pickBtn')) play('#sndBosyu');
  });
})();
</script>
</body>
</html>
