<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<style>
  :root{
    --brand:#007bff; --accent:#ff7f50; --bg:#f6f9fb; --card:#fff; --text:#222;
    --pill:#f0f3f6; --muted:#666; --danger:#dc3545; --warn:#ff9800; --ok:#28a745;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",Roboto,Arial,sans-serif;}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:18px}
  main{max-width:1100px;margin:14px auto;padding:0 12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);border-radius:999px;padding:4px 10px}
  button{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;font:inherit;background:var(--brand);color:#fff}
  button.secondary{background:#6c757d}
  button.warn{background:var(--warn)}
  button.danger{background:var(--danger)}
  button.ok{background:var(--ok)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:14px;margin:0 0 14px}
  input[type=text]{border:1px solid #ddd;border-radius:8px;padding:10px;font:inherit}

  /* スタート画面：ルームグリッド */
  .rooms{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px}
  .room{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
  .room .name{font-weight:800}
  .room .state{font-size:12px;color:#444}
  .room.sel{outline:2px solid var(--brand)}
  .state-empty{color:#777}
  .state-recruit{color:#d35400}
  .state-playing{color:#0b6d85}

  /* ルーム画面：問題と回答（円形） */
  .qwrap{text-align:center}
  .qtitle{font-size:24px;font-weight:900;margin:10px 0 6px}
  .qresult{min-height:1.8em;font-size:20px;font-weight:900;margin:6px 0 10px}
  .grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:18px;justify-items:center;align-items:center;margin:10px auto;max-width:900px}
  .ans{width:170px;height:170px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;box-shadow:0 10px 24px rgba(0,0,0,.12);user-select:none}
  .ans.P{background:#e74c3c}.ans.E{background:#3498db}.ans.I{background:#ffca28;color:#222}.ans.Ph{background:#2ecc71}
  .ans.disabled{filter:grayscale(.25) opacity(.6);pointer-events:none}

  /* カウントダウンオーバーレイ */
  #countOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;color:#fff;z-index:9999}
  #countText{font-size:120px;font-weight:900;text-shadow:0 10px 30px rgba(0,0,0,.6)}
  @keyframes pop{0%{transform:scale(.6)}60%{transform:scale(1.18)}100%{transform:scale(1)}}
  .pop{animation:pop .32s ease-out}

  .right{display:flex;align-items:center;gap:8px}
  .hide{display:none!important}
  .nameTag{font-weight:700}
  .hostTag,.youTag{color:#000;font-weight:900}
  .center{text-align:center}
  .footnote{font-size:12px;color:#666}

  /* 応援だけボタン */
  .cheerBox{display:flex;gap:10px;align-items:center;justify-content:center;margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>P.E.I.P. 早押しクイズ</h1>
  <div class="right">
    <label class="pill"><input type="checkbox" id="soundToggle" checked> 音声: ON</label>
    <button id="leaveBtn" class="secondary hide">退出する</button>
  </div>
</header>

<main>

  <!-- スタート画面 -->
  <section id="screenStart" class="card">
    <h3 style="margin:0 0 8px">① 名前を入力 → ② ルームを選ぶ → ③ 「参加」または「観戦」</h3>
    <div class="row" style="margin:4px 0 12px">
      <input id="nameInput" type="text" placeholder="名前（表示名）" />
      <button id="joinBtn" class="ok" disabled>参加</button>
      <button id="watchBtn" class="secondary" disabled>観戦</button>
    </div>

    <div class="rooms" id="roomsGrid">読み込み中…</div>

    <div class="footnote" style="margin-top:10px">
      ・ルームの状態：<span class="state-empty">空室</span>／<span class="state-recruit">募集中</span>／
      <span class="state-playing">試合中（観戦のみ可）</span>  
      ・最大5人。正解+2点／不正解-3点。募集開始は60秒。<br>
      ・スタート時は「3→2→1（countdown.mp3）」後に問題表示。40問をランダムに連続出題。各問の回答時間8秒。<br>
      ・終了時に順位を表示し、gongu.mp3 が鳴ります。
    </div>
  </section>

  <!-- ルーム画面 -->
  <section id="screenRoom" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span>ルーム：<span id="roomLabel" class="pill"></span></span>
          <span class="muted">状態：</span><span id="statePill" class="pill">-</span>
          <span class="muted">募集終了まで：</span><span id="recruitLeft" class="pill">--:--</span>
          <span class="muted">残り問題：</span><span id="remainPill" class="pill">--</span>
          <span class="muted">あなたの順位：</span><span id="myRank" class="pill">-位</span>
        </div>
        <div id="hostCtrl" class="row hide">
          <button id="recruitBtn" class="warn">募集開始</button>
          <button id="startBtn" class="ok">ゲーム開始</button>
          <button id="stopBtn" class="danger">中止</button>
        </div>
      </div>

      <div style="margin-top:8px">
        <strong>参加者（最大5人）</strong>
        <div id="playersList" class="row" style="margin-top:6px;flex-wrap:wrap"></div>
        <div class="muted" style="margin-top:4px">残り：<span id="seatsLeft">5</span> 名</div>
      </div>
    </div>

    <div id="qCard" class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <div class="muted">問題：<span id="qIndex">-</span> / 40</div>
        <div class="muted">回答残り：<span id="timeLeft">--</span></div>
      </div>
      <div class="qwrap">
        <div id="qTitle" class="qtitle">ホストが「ゲーム開始」を押すと表示されます。</div>
        <div id="qResult" class="qresult"></div>
        <div class="grid4">
          <div class="ans P disabled"  data-choice="P">きもち</div>
          <div class="ans E disabled"  data-choice="E">まわり</div>
          <div class="ans I disabled"  data-choice="I">できること</div>
          <div class="ans Ph disabled" data-choice="Ph">からだ＆病気</div>
        </div>
      </div>
    </div>

    <div class="card center">
      <div class="cheerBox">
        <button id="cheerBtn" class="ok">応援</button>
      </div>
      <div class="footnote">※「応援」は観戦者・参加者どちらでも押せます（kansei.mp3 が鳴ります）。</div>
    </div>
  </section>
</main>

<!-- カウントダウン -->
<div id="countOverlay"><div id="countText">3</div></div>

<!-- audio -->
<audio id="a_countdown" src="countdown.mp3" preload="auto"></audio>
<audio id="a_correct"   src="se_correct.mp3" preload="auto"></audio>
<audio id="a_wrong"     src="se_wrong.mp3"   preload="auto"></audio>
<audio id="a_start"     src="start.mp3"      preload="auto"></audio>
<audio id="a_warn"      src="keikoku.mp3"    preload="auto"></audio>
<audio id="a_gong"      src="gongu.mp3"      preload="auto"></audio>
<audio id="a_bosyu"     src="bosyu.mp3"      preload="auto"></audio>
<audio id="a_kansei"    src="kansei.mp3"     preload="auto"></audio>

<!-- Firebase compat（Firestoreのみ使用） -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ===== Firebase 設定（peip-with5） ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ====== 共通ユーティリティ ====== */
const $ = sel => document.querySelector(sel);
const $all = sel => Array.from(document.querySelectorAll(sel));
const esc = s=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const uid = (()=>{ const k='peip-uid'; let v=localStorage.getItem(k); if(!v){ v='u_'+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; })();

/* ====== 状態 ====== */
let me = { id: uid, name: "", role: "", isHost:false, roomId:null };
let roomRef=null, playersRef=null, specsRef=null;
let roomUnsub = null, playersUnsub = null;
let soundOn = true;
let answerEnabled = false;
let openTimer = null, recruitTimer = null;
let lastResultKeyPlayed = "";

/* ====== 問題プール（ここからランダムで40問） ====== */
const questionsPool = [
  { text: "子どもに会いたいと思っているか？", answer: "P" },{ text: "洗濯物にしわはないか？", answer: "E" },
  { text: "トイレで立位をとることができるか？", answer: "I" },{ text: "便秘はないか？", answer: "Ph" },
  { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },{ text: "トイレの手すりにぐらつきはないか？", answer: "E" },
  { text: "歯磨きは一人で行えているか？", answer: "I" },{ text: "むせこみはないか？", answer: "Ph" },
  { text: "デイサービスを楽しみにしているか？", answer: "P" },{ text: "冷蔵庫に消費期限が過ぎた食品はないか？", answer: "E" },
  { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },{ text: "足にむくみはないか？", answer: "Ph" },
  { text: "好きな音楽（曲・歌手）は何か？", answer: "P" },{ text: "洗面所の床は濡れていないか？", answer: "E" },
  { text: "トイレのボタンを操作することはできるか？", answer: "I" },{ text: "肌は乾燥していないか？", answer: "Ph" },
  { text: "暮らしで困っていることはないか？", answer: "P" },{ text: "息苦しさや胸の圧迫感はないか？", answer: "Ph" },
  { text: "着替えは介助なしでできるか？", answer: "I" },{ text: "食欲や水分摂取量はどうか？", answer: "Ph" },
  { text: "昔していた仕事は何か？", answer: "P" },{ text: "使用している福祉用具は何か？", answer: "E" },
  { text: "電話をかけることができるか？", answer: "I" },{ text: "視力はどの程度か？", answer: "Ph" },
  { text: "食べたいものはあるか？", answer: "P" },{ text: "自宅で10ミリ以上の段差はないか？", answer: "E" },
  { text: "お茶を入れて飲むことはできるか？", answer: "I" },{ text: "夜間の睡眠状況はどうか？", answer: "Ph" },
  { text: "習慣となっていることは何か？", answer: "P" },{ text: "利用している介護サービスは何か？", answer: "E" },
  { text: "体操で体を動かせているか？", answer: "I" },{ text: "ふらつきはないか？", answer: "Ph" },
  { text: "趣味を再開したい思いはあるか？", answer: "P" },{ text: "居室の温度・室温は？", answer: "E" },
  { text: "食事の準備は一人でできるか？", answer: "I" },{ text: "腰痛など体の痛みはないか？", answer: "Ph" },
  { text: "調味料にこだわりはあるか？", answer: "P" },{ text: "薬の管理で手伝ってほしいことはあるか？", answer: "P" },
  { text: "薬の管理は一人で行えているか？", answer: "I" },{ text: "まぶたに目やにはついていないか？", answer: "Ph" },
  { text: "どのような環境で寝たい思っているか？", answer: "P" },{ text: "コールのボタンは鳴るか？", answer: "E" },
  { text: "座位をとることはできているか？", answer: "I" },{ text: "巻き爪はないか？", answer: "Ph" },
  { text: "何をしている時が幸せを感じる時か？", answer: "P" },{ text: "現在、交流のある人は誰か？", answer: "E" },
  { text: "買い物リストを書くことはできるか？", answer: "I" },{ text: "夜間に不眠はないか？", answer: "Ph" },
  { text: "お気に入りの服はあるか？", answer: "P" },{ text: "居室の換気状況は？", answer: "E" }
];

/* ====== ルームの初期生成（1～15） ====== */
async function ensureRooms(){
  const base = db.collection('rooms');
  for(let i=1;i<=15;i++){
    const id = 'room-' + String(i).padStart(2,'0');
    const ref = base.doc(id);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({
        state:'empty', // empty | recruit | countdown | open | judging | finished
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        recruitingUntil: 0,
        currentIndex: 0,
        deck: [],
        openUntil: 0,
        openStarted: 0,
        buzzedBy:null,
        answerChoice:null,
        lastResult:null,
        resultKey:"",
      });
    }
  }
}

/* ====== 音声 ====== */
const a = {
  countdown: $('#a_countdown'),
  correct:   $('#a_correct'),
  wrong:     $('#a_wrong'),
  start:     $('#a_start'),
  warn:      $('#a_warn'),
  gong:      $('#a_gong'),
  bosyu:     $('#a_bosyu'),
  kansei:    $('#a_kansei'),
};
function play(id){
  if(!soundOn) return;
  const el = a[id]; if(!el) return;
  try{ el.currentTime = 0; el.play(); }catch(_){}
}

/* ====== 画面遷移 ====== */
function showStart(){
  $('#screenStart').classList.remove('hide');
  $('#screenRoom').classList.add('hide');
  $('#leaveBtn').classList.add('hide');
  $('#myRank').textContent = '-位';
}
function showRoom(){
  $('#screenStart').classList.add('hide');
  $('#screenRoom').classList.remove('hide');
  $('#leaveBtn').classList.remove('hide');
}

/* ====== ルーム一覧 ====== */
let selectedRoomId = null;
function renderRoomsGrid(rooms){
  const grid = $('#roomsGrid');
  grid.innerHTML = '';
  rooms.sort((a,b)=>a.id.localeCompare(b.id));
  rooms.forEach(r=>{
    const st = r.data().state || 'empty';
    const jp = st==='recruit' ? '参加者募集中' : (st==='empty' ? '空室' : '試合中（観戦のみ可）');
    const cls = st==='recruit' ? 'state-recruit' : (st==='empty' ? 'state-empty' : 'state-playing');
    const div = document.createElement('div');
    div.className = 'room';
    div.dataset.id = r.id;
    div.innerHTML = `<div class="name">${r.id}</div>
      <div class="state ${cls}">${jp}</div>`;
    div.onclick = ()=>{
      selectedRoomId = r.id;
      $all('.room').forEach(x=>x.classList.remove('sel'));
      div.classList.add('sel');
      // 参加可能判定：試合中は参加不可（観戦のみ）
      const joinable = (st==='empty' || st==='recruit');
      $('#joinBtn').disabled = !joinable;
      $('#watchBtn').disabled = false;
    };
    grid.appendChild(div);
  });
}

/* ====== 参加・観戦 ====== */
async function enterRoom(role){
  if(!selectedRoomId){ alert('ルームを選んでください'); return; }
  const name = ($('#nameInput').value||'').trim();
  if(!name){ play('warn'); alert('名前を入力してください'); return; }
  play('start');

  me.name = name; me.role = role; me.roomId = selectedRoomId;

  roomRef = db.collection('rooms').doc(me.roomId);
  playersRef = roomRef.collection('players');
  specsRef   = roomRef.collection('spectators');

  // 参加者 or 観戦者登録
  if(role==='player'){
    const cur = await playersRef.get();
    if(cur.size >= 5){ alert('満員のため参加できません（観戦は可能）'); return; }
    // 最初に入った人をホストに
    me.isHost = (cur.size===0);
    await playersRef.doc(me.id).set({
      name: me.name, score:0, correct:0, wrong:0, totalMs:0,
      isHost: me.isHost, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }else{
    me.isHost = false;
    await specsRef.doc(me.id).set({
      name: me.name, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }

  showRoom();
  $('#roomLabel').textContent = me.roomId;
  $('#hostCtrl').classList.toggle('hide', !me.isHost);
  $('#remainPill').textContent = '--';
  $('#qTitle').textContent = 'ホストが「ゲーム開始」を押すと表示されます。';
  $('#qResult').textContent = '';
  $('#qIndex').textContent = '-';
  setAnswersEnabled(false);

  // 購読開始
  subscribeRoom();
  subscribePlayers();
}

/* ====== 退出 ====== */
async function leaveRoom(){
  if(!roomRef) { showStart(); return; }
  try{
    if(me.role==='player'){ await playersRef.doc(me.id).delete(); }
    else if(me.role==='spectator'){ await specsRef.doc(me.id).delete(); }
  }catch(e){}
  // 参照解除
  if(roomUnsub) roomUnsub(); roomUnsub=null;
  if(playersUnsub) playersUnsub(); playersUnsub=null;

  me = { id: uid, name:"", role:"", isHost:false, roomId:null };
  selectedRoomId = null;
  $all('.room').forEach(x=>x.classList.remove('sel'));
  $('#joinBtn').disabled = true; $('#watchBtn').disabled = true;
  showStart();
}

/* ====== 参加者購読（順位・残席・表示） ====== */
function subscribePlayers(){
  if(playersUnsub) playersUnsub();
  playersUnsub = playersRef.orderBy('joinedAt','asc').onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
    // 表示
    const list = $('#playersList'); list.innerHTML='';
    arr.forEach(p=>{
      const div = document.createElement('div');
      div.className='pill';
      const you = (p.id===me.id) ? '<span class="youTag">あなた</span>' : '';
      const host= p.isHost? '<span class="hostTag">ホスト</span>' : '';
      div.innerHTML = `<span class="nameTag">${esc(p.name)}</span>${you? ' '+you:''}${host? ' '+host:''} <span class="muted">${Number(p.score||0)}点</span>`;
      list.appendChild(div);
    });
    $('#seatsLeft').textContent = Math.max(0, 5-arr.length);

    // 順位
    const ranked = [...arr].sort((a,b)=>{
      if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
      if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
      if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
      return (a.totalMs||0)-(b.totalMs||0);
    });
    const idx = ranked.findIndex(x=>x.id===me.id);
    $('#myRank').textContent = (idx>=0) ? `${idx+1}位` : '-位';
  });
}

/* ====== ルーム購読（状態遷移・問題進行） ====== */
function setAnswersEnabled(flag){
  answerEnabled = flag;
  $all('.ans').forEach(b=>b.classList.toggle('disabled', !flag));
}
function subscribeRoom(){
  if(roomUnsub) roomUnsub();
  roomUnsub = roomRef.onSnapshot(async s=>{
    if(!s.exists) return;
    const r = s.data();
    $('#statePill').textContent = r.state;
    $('#remainPill').textContent = (r.deck&&r.deck.length) ? (Math.max(0, r.deck.length - (r.currentIndex||0)))+'問' : '--';

    // 募集カウントダウン表示
    if(recruitTimer) clearInterval(recruitTimer);
    if(r.state==='recruit' && r.recruitingUntil){
      recruitTimer = setInterval(()=>{
        const ms = Math.max(0, (r.recruitingUntil||0) - Date.now());
        const mm = String(Math.floor(ms/60000)).padStart(2,'0');
        const ss = String(Math.floor((ms%60000)/1000)).padStart(2,'0');
        $('#recruitLeft').textContent = `${mm}:${ss}`;
      }, 200);
    }else{
      $('#recruitLeft').textContent = '--:--';
    }

    // カウントダウン → open
    if(r.state==='countdown'){
      doCountdown().then(async ()=>{
        // ホストが open を開く
        if(me.isHost){
          const idx = r.currentIndex||0;
          const deck = r.deck || [];
          const qIdx = (deck.length>0)? deck[idx] : idx;
          await roomRef.update({
            state:'open',
            openStarted: Date.now(),
            openUntil: Date.now()+8000,
            buzzedBy:null, answerChoice:null,
            lastResult:null, resultKey:""
          });
        }
      });
      return;
    }

    // open：問題表示
    if(r.state==='open'){
      const deck = r.deck || [];
      const idx = r.currentIndex||0;
      const qIdx = (deck.length>0)? deck[idx] : idx;
      const q = questionsPool[qIdx];
      $('#qTitle').textContent = `「${q.text}」`;
      $('#qIndex').textContent = (idx+1);
      $('#qResult').textContent = '';
      setAnswersEnabled(true);

      if(openTimer) clearInterval(openTimer);
      openTimer = setInterval(async ()=>{
        const ms = Math.max(0, (r.openUntil||0) - Date.now());
        $('#timeLeft').textContent = (ms/1000).toFixed(1)+'s';
        if(ms<=0){
          clearInterval(openTimer);
          $('#timeLeft').textContent = '0.0s';
          setAnswersEnabled(false);
          // 時間切れ → ホストが次へ
          if(me.isHost && (s.data().state==='open')){
            await roomRef.update({ state:'judging', lastResult:null, resultKey: 'timeout_'+Date.now() });
          }
        }
      }, 100);
      return;
    }else{
      setAnswersEnabled(false);
      $('#timeLeft').textContent = '--';
    }

    // 判定（正誤表示→2秒後に次） / 判定音は一度だけ
    if(r.state==='judging'){
      if(r.resultKey && r.resultKey!==lastResultKeyPlayed){
        lastResultKeyPlayed = r.resultKey;
        if(r.lastResult==='correct') play('correct');
        else if(r.lastResult==='wrong') play('wrong');
      }

      if(r.buzzedBy){
        const p = (await playersRef.doc(r.buzzedBy).get()).data();
        const who = p ? p.name : '誰か';
        $('#qResult').textContent = (r.lastResult==='correct') ? `⭕ 正解（${esc(who)}）` : `❌ 不正解（${esc(who)}）`;
      }else{
        $('#qResult').textContent = '時間切れ';
      }

      // ホストが2秒後に次の問題へ
      if(me.isHost){
        setTimeout(async ()=>{
          const next = (r.currentIndex||0) + 1;
          const total = (r.deck && r.deck.length) ? r.deck.length : 40;
          if(next>=total){
            await roomRef.update({ state:'finished' });
          }else{
            await roomRef.update({ state:'countdown', currentIndex: next });
          }
        }, 2000);
      }
      return;
    }

    // 終了
    if(r.state==='finished'){
      $('#qTitle').textContent = `全問終了！ あなたの順位は <span style="font-weight:900">${$('#myRank').textContent}</span> でした。お疲れさまでした。`;
      $('#qResult').textContent = '';
      setAnswersEnabled(false);
      play('gong');
      return;
    }
  });
}

/* ====== カウントダウン（3→2→1） ====== */
async function doCountdown(){
  const ov = $('#countOverlay'), tx = $('#countText');
  ov.style.display='flex';
  const steps = ['3','2','1'];
  play('countdown');
  for(const s of steps){ tx.textContent = s; tx.classList.remove('pop'); void tx.offsetWidth; tx.classList.add('pop'); await sleep(820); }
  ov.style.display='none';
}

/* ====== 回答 ====== */
$all('.ans').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    if(!answerEnabled) return;
    const choice = btn.dataset.choice;
    answerEnabled = false;

    await db.runTransaction(async (tx)=>{
      const doc = await tx.get(roomRef);
      const r = doc.data();
      if(r.state!=='open') return;
      if((r.openUntil||0) < Date.now()) return;
      if(r.buzzedBy) return;
      tx.update(roomRef, { state:'judging', buzzedBy: me.id, answerChoice: choice });
    });

    // ホストが判定とスコア更新
    const doc = await roomRef.get(); const r = doc.data();
    if(me.isHost && r.buzzedBy){
      const deck = r.deck || [];
      const idx  = r.currentIndex||0;
      const qIdx = (deck.length>0)? deck[idx] : idx;
      const q    = questionsPool[qIdx];
      const ok   = (r.answerChoice===q.answer);
      const delta= ok? +2 : -3;
      const addCorrect = ok? 1:0; const addWrong = ok? 0:1;
      const usedMs = Math.max(0, Date.now()-(r.openStarted||Date.now()));
      const key = (ok? 'C':'W') + '_' + Date.now();

      await Promise.all([
        playersRef.doc(r.buzzedBy).set({
          score: firebase.firestore.FieldValue.increment(delta),
          correct: firebase.firestore.FieldValue.increment(addCorrect),
          wrong: firebase.firestore.FieldValue.increment(addWrong),
          totalMs: firebase.firestore.FieldValue.increment(usedMs)
        }, { merge:true }),
        roomRef.update({ lastResult: ok?'correct':'wrong', resultKey:key })
      ]);
    }
  });
});

/* ====== ホスト操作 ====== */
$('#recruitBtn').onclick = async ()=>{
  if(!me.isHost) return;
  play('bosyu');
  await roomRef.update({
    state:'recruit',
    recruitingUntil: Date.now()+60000,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
};
$('#startBtn').onclick = async ()=>{
  if(!me.isHost) return;
  // デッキ作成（ランダム40）
  const idxs = [...Array(questionsPool.length).keys()];
  idxs.sort(()=>Math.random()-0.5);
  const deck = idxs.slice(0, Math.min(40, idxs.length));
  await roomRef.update({
    state:'countdown',
    deck, currentIndex:0,
    recruitingUntil: 0
  });
};
$('#stopBtn').onclick = async ()=>{
  if(!me.isHost) return;
  await roomRef.update({ state:'finished' });
};

/* ====== 応援 ====== */
$('#cheerBtn').onclick = ()=> play('kansei');

/* ====== イベント系 ====== */
$('#joinBtn').onclick = ()=> enterRoom('player');
$('#watchBtn').onclick = ()=> enterRoom('spectator');
$('#leaveBtn').onclick = ()=> leaveRoom();
$('#soundToggle').addEventListener('change', e=>{
  soundOn = e.target.checked;
});

/* ====== 初期化（ルーム一覧購読） ====== */
async function init(){
  await ensureRooms();
  // ルーム一覧購読
  db.collection('rooms').onSnapshot(s=>{
    const arr=[]; s.forEach(d=>arr.push(d));
    renderRoomsGrid(arr);
  });
  showStart();
}
init();
</script>
</body>
</html>
