<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#222; --muted:#667;
    --red:#e74c3c; --blue:#3498db; --yellow:#f1c40f; --green:#2ecc71;
    --brand:#ff7f50;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;
         display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px}
  h1{margin:0;font-size:18px}
  .wrap{max-width:980px;margin:16px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;color:#333}
  .muted{color:var(--muted);font-size:12px}
  input,button,select{font:inherit}
  input,select{border:1px solid #ddd;border-radius:8px;padding:8px;background:#fff}
  button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;background:#007bff;color:#fff}
  button.sec{background:#6c757d} button.warn{background:#ff9800} button.danger{background:#dc3545}
  button.pink{background:#ff5ca8}
  .hidden{display:none!important}
  .grid15{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .room{border:1px solid #eee;border-radius:12px;padding:10px}
  .room h4{margin:0 0 6px;font-size:16px}
  .room small{display:block;margin-bottom:6px}
  .room .choose{width:100%}
  .status-empty{color:#777}
  .status-entry{color:#0b6d85}
  .status-play{color:#d35400}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .board{display:flex;gap:8px;flex-wrap:wrap}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid #eee;background:#fafafa}
  .you{color:#000;font-weight:700}
  .host{color:#000;font-weight:700}
  .qbox{min-height:280px;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .qtitle{font-size:22px;font-weight:800;text-align:center;margin:6px 0 10px}
  .qmeta{font-size:14px;color:#666}
  .ansGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:18px;margin-top:10px;align-items:center;justify-items:center}
  /* === 丸ボタン（完全な円） === */
  .circle{
    width:200px;height:200px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:900;font-size:18px;cursor:pointer;user-select:none;
    border:6px solid #fff; box-shadow:0 10px 26px rgba(0,0,0,.18),
    inset 0 3px 0 rgba(255,255,255,.5), inset 0 -3px 0 rgba(0,0,0,.08);
    transition:transform .06s ease, filter .2s ease, box-shadow .2s ease;
    text-align:center;
  }
  .circle:hover{filter:brightness(1.05)}
  .circle:active{transform:translateY(1px) scale(.985)}
  .c-red{background:var(--red)} .c-blue{background:var(--blue)}
  .c-yellow{background:var(--yellow); color:#222} .c-green{background:var(--green)}
  .timer{font-weight:900;color:#d32f2f}
  .right{margin-left:auto}
  .center{text-align:center}
  .big{font-size:20px;font-weight:800}
  .footerNote{font-size:12px;color:#555}
  .soundToggle{display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
<header>
  <h1>P.E.I.P. 早押しクイズ</h1>
  <div class="right row">
    <label class="soundToggle"><input type="checkbox" id="sndOn" checked>音声: ON</label>
    <button id="leaveBtn" class="sec">退出する</button>
  </div>
</header>

<div class="wrap">

  <!-- ===== ホーム（名前→部屋選択→参加/観戦） ===== -->
  <section id="home" class="card">
    <h3 style="margin:0 0 8px">① 名前を入力</h3>
    <div class="row"><input id="nameInput" placeholder="表示名" style="min-width:220px">
      <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck">ホストになる</label>
    </div>
    <h3 style="margin:10px 0 6px">② ルームを選ぶ（15室 / 状態つき）</h3>
    <div id="roomList" class="grid15"></div>
    <div class="row" style="margin-top:10px">
      <button id="joinBtn" class="pink">参加</button>
      <button id="watchBtn" class="sec">観戦</button>
      <span class="muted">※ 先に上の一覧でルームを選んでから</span>
    </div>
  </section>

  <!-- ===== ルーム画面 ===== -->
  <section id="room" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <span>ルーム：<b id="roomId" class="pill"></b></span>
        <span class="muted">状態：</span><span id="statePill" class="pill">-</span>
        <span class="muted">募集終了まで：</span><span id="entryLeft" class="pill">--</span>
        <span class="muted">残り問題：</span><span id="remainQ" class="pill">--</span>
        <span class="muted">あなたの順位：</span><span id="myRank" class="pill">-位</span>
      </div>
      <div id="hostTools" class="controls hidden">
        <button id="entryBtn"  class="warn">募集開始</button>
        <button id="startBtn"  class="pink">ゲーム開始</button>
        <button id="stopBtn"   class="danger">中止</button>
      </div>
    </div>

    <div style="margin:10px 0">
      <strong>参加者（最大5人）</strong>
      <div id="players" class="board" style="margin-top:6px"></div>
    </div>

    <div id="qArea" class="qbox">
      <div id="qCaption" class="muted">ホストが「ゲーム開始」を押すと表示されます。</div>
      <div id="qTitle" class="qtitle hidden"></div>
      <div class="row qmeta hidden" id="qMeta"><span id="qIndex"></span><span class="muted">／40</span>・
        <span>回答残り：<span id="leftSec" class="timer">--</span></span>
      </div>
      <div id="ansGrid" class="ansGrid hidden">
        <div class="circle c-red"    data-choice="P">きもち</div>
        <div class="circle c-blue"   data-choice="E">まわり</div>
        <div class="circle c-yellow" data-choice="I">できること</div>
        <div class="circle c-green"  data-choice="Ph">からだ＆病気</div>
      </div>
      <div id="judge" class="big hidden center" style="margin-top:6px"></div>
    </div>

    <div class="card" style="margin:12px -14px -14px; border:none; box-shadow:none;background:transparent">
      <div class="row" style="align-items:center;gap:8px">
        <strong>観戦・応援</strong>
        <button id="cheerBtn" class="sec">応援</button>
        <span class="muted">（観戦は何人でも可／コメントなし・応援音のみ）</span>
      </div>
    </div>
  </section>

  <section class="card footerNote">
    ・URLアクセス → 名前入力 → ルーム選択 →「参加」または「観戦」→（ホストが募集/開始）→ 40問が連続で出題。  
    ・正解 +2点／不正解 −3点。回答は 8秒。募集は 60秒。結果は自動進行。  
    ・同点順位は「得点 → 正解数多い → 不正解少ない → 回答合計時間が短い」で決定。  
    ・終了時に鐘（gongu.mp3）が鳴ります。  
    ※教材クレジット省略
  </section>
</div>

<!-- ===== 効果音（同フォルダに配置） ===== -->
<audio id="seBosyu"     src="bosyu.mp3" preload="auto"></audio>
<audio id="seCount"     src="countdown.mp3" preload="auto"></audio>
<audio id="seCorrect"   src="se_correct.mp3" preload="auto"></audio>
<audio id="seWrong"     src="se_wrong.mp3"   preload="auto"></audio>
<audio id="seGong"      src="gongu.mp3"      preload="auto"></audio>
<audio id="seKansei"    src="kansei.mp3"     preload="auto"></audio>
<audio id="seAlert"     src="keikoku.mp3"    preload="auto"></audio>

<!-- ===== Firebase（モジュラー SDK v12） ===== -->
<script type="module">
  import { initializeApp }   from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics }    from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import {
    getFirestore, doc, setDoc, updateDoc, getDoc, onSnapshot, serverTimestamp,
    collection, getDocs, query, orderBy, where, runTransaction, deleteDoc
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  /* ===== あなたのプロジェクト設定（peip-with5） ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
    authDomain: "peip-with5.firebaseapp.com",
    projectId: "peip-with5",
    storageBucket: "peip-with5.firebasestorage.app",
    messagingSenderId: "609048243686",
    appId: "1:609048243686:web:a38452d1872d4ec28cba27",
    measurementId: "G-YCB8S47ENW"
  };
  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const db  = getFirestore(app);

  /* ===== ユーティリティ ===== */
  const $ = (id)=>document.getElementById(id);
  const snd = (id)=>{ if(!$('#sndOn').checked) return;
    const el=$(id); try{ el.currentTime=0; el.play(); }catch(_){}
  };
  const uid = ()=>{ const k='peip-uid'; let v=localStorage.getItem(k);
    if(!v){ v='u_'+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v); }
    return v;
  };
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
  const shuffle = (a)=>{ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } };
  const esc = (s)=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;' }[c]));

  /* ===== 問題プール（ここからランダム40問） ===== */
  const pool = [
    { text:"子どもに会いたいと思っているか？", answer:"P" },{ text:"洗濯物にしわはないか？", answer:"E" },
    { text:"トイレで立位をとることができるか？", answer:"I" },{ text:"便秘はないか？", answer:"Ph" },
    { text:"朝食の飲み物にこだわりはあるか？", answer:"P" },{ text:"トイレの手すりにぐらつきはないか？", answer:"E" },
    { text:"歯磨きは一人で行えているか？", answer:"I" },{ text:"むせこみはないか？", answer:"Ph" },
    { text:"デイサービスを楽しみにしているか？", answer:"P" },{ text:"冷蔵庫に消費期限が過ぎた食品はないか？", answer:"E" },
    { text:"歩行器を使えば自立歩行はできるか？", answer:"I" },{ text:"足にむくみはないか？", answer:"Ph" },
    { text:"好きな音楽（曲・歌手）は何か？", answer:"P" },{ text:"洗面所の床は濡れていないか？", answer:"E" },
    { text:"トイレのボタンを操作することはできるか？", answer:"I" },{ text:"肌は乾燥していないか？", answer:"Ph" },
    { text:"暮らしで困っていることはないか？", answer:"P" },{ text:"息苦しさや胸の圧迫感はないか？", answer:"Ph" },
    { text:"着替えは介助なしでできるか？", answer:"I" },{ text:"食欲や水分摂取量はどうか？", answer:"Ph" },
    { text:"昔していた仕事は何か？", answer:"P" },{ text:"使用している福祉用具は何か？", answer:"E" },
    { text:"電話をかけることができるか？", answer:"I" },{ text:"視力はどの程度か？", answer:"Ph" },
    { text:"食べたいものはあるか？", answer:"P" },{ text:"自宅で10ミリ以上の段差はないか？", answer:"E" },
    { text:"お茶を入れて飲むことはできるか？", answer:"I" },{ text:"夜間の睡眠状況はどうか？", answer:"Ph" },
    { text:"習慣となっていることは何か？", answer:"P" },{ text:"利用している介護サービスは何か？", answer:"E" },
    { text:"体操で体を動かせているか？", answer:"I" },{ text:"ふらつきはないか？", answer:"Ph" },
    { text:"趣味を再開したい思いはあるか？", answer:"P" },{ text:"居室の温度・室温は？", answer:"E" },
    { text:"食事の準備は一人でできるか？", answer:"I" },{ text:"腰痛など体の痛みはないか？", answer:"Ph" },
    { text:"調味料にこだわりはあるか？", answer:"P" },{ text:"薬の管理で手伝ってほしいことはあるか？", answer:"P" },
    { text:"薬の管理は一人で行えているか？", answer:"I" },{ text:"まぶたに目やにはついていないか？", answer:"Ph" },
    { text:"どのような環境で寝たい思っているか？", answer:"P" },{ text:"コールのボタンは鳴るか？", answer:"E" },
    { text:"座位をとることはできているか？", answer:"I" },{ text:"巻き爪はないか？", answer:"Ph" },
    { text:"何をしている時が幸せを感じる時か？", answer:"P" },{ text:"現在、交流のある人は誰か？", answer:"E" },
    { text:"買い物リストを書くことはできるか？", answer:"I" },{ text:"夜間に不眠はないか？", answer:"Ph" },
    { text:"お気に入りの服はあるか？", answer:"P" },{ text:"居室の換気状況は？", answer:"E" }
  ];

  /* ===== アプリ状態 ===== */
  let selectedRoom = null;
  let me = { id:uid(), name:"", host:false, spectator:false };
  let roomUnsub = null, playersUnsub = null;
  let answerDeadline = 0, answerTicker = null;
  const MAX_PLAYERS = 5, ENTRY_MS = 60000, ANSWER_MS = 8000, TOTAL_QUESTIONS = 40;
  const SCORE_OK = +2, SCORE_NG = -3;

  /* ===== 画面切替 ===== */
  function showHome(){
    $('#home').classList.remove('hidden');
    $('#room').classList.add('hidden');
    $('#leaveBtn').textContent = "退出する";
    selectedRoom = null;
    if(roomUnsub) roomUnsub(); if(playersUnsub) playersUnsub();
    listRooms(); // 最新の状態に更新
  }
  function showRoom(){
    $('#home').classList.add('hidden');
    $('#room').classList.remove('hidden');
  }

  /* ===== ルーム一覧を表示（空室/募集中/試合中） ===== */
  async function listRooms(){
    const box = $('#roomList'); box.textContent = '読み込み中…';
    const items = [];
    for(let i=1;i<=15;i++){
      const id = `room-${String(i).padStart(2,'0')}`;
      const rdoc = await getDoc(doc(db,'rooms',id));
      const r = rdoc.exists()? rdoc.data() : {};
      const state = r.state || 'empty';  // empty | entry | play | finished
      const players = r.playersCount || 0;
      const statusLabel = state==='entry' ? '募集中'
                        : state==='play'  ? '試合中（観戦のみ可）'
                        : '空室';
      const cls = state==='entry'?'status-entry':state==='play'?'status-play':'status-empty';
      const el = document.createElement('div');
      el.className = 'room';
      el.innerHTML = `
        <h4>${id}</h4>
        <small class="${cls}">${statusLabel}</small>
        <button class="choose" data-room="${id}">この部屋を選ぶ</button>`;
      items.push(el);
    }
    box.innerHTML = ''; items.forEach(x=>box.appendChild(x));
    // クリックで選択
    box.querySelectorAll('.choose').forEach(btn=>{
      btn.onclick = ()=>{
        selectedRoom = btn.dataset.room;
        box.querySelectorAll('.choose').forEach(b=>b.disabled=false);
        btn.disabled = true;
      };
    });
  }

  /* ===== 参加/観戦（ホーム → ルーム） ===== */
  async function enterRoom(spectator){
    const name = ($('#nameInput').value || '').trim();
    if(!name){ snd('seAlert'); alert('名前を入力してください'); return; }
    if(!selectedRoom){ snd('seAlert'); alert('ルームを選んでください'); return; }

    me = { id:uid(), name, host: !!$('#hostCheck').checked, spectator: !!spectator };

    // ルームドキュメント初期化
    const rRef = doc(db,'rooms',selectedRoom);
    const rSnap = await getDoc(rRef);
    if(!rSnap.exists()){
      await setDoc(rRef, {
        state:'empty', entryEndsAt:0, deck:[], currentIndex:0, questionEndsAt:0,
        playersCount:0, createdAt:serverTimestamp()
      }, { merge:true });
    }

    // 参加人数チェック（観戦は無制限）
    if(!spectator){
      const pSnap = await getDocs(collection(db,'rooms',selectedRoom,'players'));
      let joiners = 0; pSnap.forEach(d=>{ if(!d.data().spectator) joiners++; });
      if(joiners >= MAX_PLAYERS){ alert('この部屋は満員です'); return; }
    }

    // 参加登録
    const pRef = doc(db,'rooms',selectedRoom,'players', me.id);
    await setDoc(pRef, {
      name: me.name, host: !!me.host, spectator: !!spectator,
      score:0, correct:0, wrong:0, timeMs:0,
      joinedAt: serverTimestamp(), lastSeen: serverTimestamp()
    }, { merge:true });

    // 参加人数のカウントを更新（ざっくり）
    await updateDoc(rRef, { playersCount: (rSnap.data()?.playersCount || 0) + (spectator?0:1) });

    // 監視開始
    watchRoom(selectedRoom);
    watchPlayers(selectedRoom);
    showRoom();
    $('#roomId').textContent = selectedRoom;
    $('#myRank').textContent = '-位';
    $('#remainQ').textContent = '--';
    $('#qTitle').classList.add('hidden'); $('#qMeta').classList.add('hidden'); $('#ansGrid').classList.add('hidden');
    $('#qCaption').classList.remove('hidden');
  }

  $('#joinBtn').onclick  = ()=>{ snd('seBosyu'); enterRoom(false); };
  $('#watchBtn').onclick = ()=>{ enterRoom(true); };
  $('#leaveBtn').onclick = async ()=>{
    // ルームに居れば退室処理してホームへ
    if(selectedRoom){
      try{
        await deleteDoc(doc(db,'rooms',selectedRoom,'players', uid()));
      }catch(_){}
      showHome();
    }else{
      location.reload();
    }
  };

  /* ===== ルーム監視 ===== */
  function watchRoom(id){
    if(roomUnsub) roomUnsub();
    const rRef = doc(db,'rooms',id);
    roomUnsub = onSnapshot(rRef, async snap=>{
      if(!snap.exists()) return;
      const r = snap.data();
      // 状態表示
      const label = r.state==='entry'?'募集中' : r.state==='play'?'試合中' : r.state==='finished'?'終了':'空室';
      $('#statePill').textContent = label;
      $('#hostTools').classList.toggle('hidden', !me.host || me.spectator);

      // 募集カウントダウン
      if(r.state==='entry'){
        const tick = ()=>{
          const left = Math.max(0, (r.entryEndsAt||0) - Date.now());
          $('#entryLeft').textContent = (left/1000).toFixed(1)+'s';
          if(left<=0) $('#entryLeft').textContent='0.0s';
        };
        tick(); // 1回
        const t = setInterval(tick,200);
        setTimeout(()=>clearInterval(t), 3000); // 軽く更新（無限に回し続けない）
      }else{
        $('#entryLeft').textContent='--';
      }

      // デッキ準備（ホストだけが作る）
      if(me.host && !me.spectator && r.state!=='play' && (!Array.isArray(r.deck) || r.deck.length===0)){
        const idxs=[...Array(pool.length).keys()]; shuffle(idxs);
        await updateDoc(rRef,{ deck: idxs.slice(0, TOTAL_QUESTIONS), currentIndex:0 });
      }

      // 進行に応じてUI
      if(r.state==='play'){
        $('#qCaption').classList.add('hidden');
        $('#qTitle').classList.remove('hidden'); $('#qMeta').classList.remove('hidden'); $('#ansGrid').classList.remove('hidden');
        const deck = r.deck||[]; const i = r.currentIndex||0;
        if(deck.length){
          const q = pool[ deck[i] ];
          $('#qTitle').textContent = '「'+q.text+'」';
          $('#qIndex').textContent = `問題 ${i+1}`;
          $('#remainQ').textContent = (TOTAL_QUESTIONS - i);
        }
        // 回答締切のカウント
        if(r.questionEndsAt){
          answerDeadline = r.questionEndsAt;
          if(answerTicker) clearInterval(answerTicker);
          answerTicker = setInterval(()=>{
            const left = Math.max(0, answerDeadline - Date.now());
            $('#leftSec').textContent = (left/1000).toFixed(1)+'s';
            if(left<=0){ clearInterval(answerTicker); $('#leftSec').textContent='0.0s'; }
          }, 100);
        }
      }
      if(r.state==='finished'){
        $('#qCaption').classList.remove('hidden');
        $('#qCaption').innerHTML = `<span class="big">全問終了！</span> あなたの順位は <b id="finalRank">--</b> でした。お疲れさまでした。`;
        $('#qTitle').classList.add('hidden'); $('#qMeta').classList.add('hidden'); $('#ansGrid').classList.add('hidden');
        snd('seGong');
      }
    });
  }

  /* ===== プレイヤー監視（順位計算） ===== */
  function watchPlayers(id){
    if(playersUnsub) playersUnsub();
    const pRef = collection(db,'rooms',id,'players');
    playersUnsub = onSnapshot(query(pRef, orderBy('joinedAt','asc')), snap=>{
      const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
      // 表示
      const box = $('#players'); box.innerHTML='';
      arr.filter(p=>!p.spectator).forEach(p=>{
        const you = p.id===me.id ? '<span class="you">（あなた）</span>' : '';
        const host= p.host?'<span class="host">（ホスト）</span>':'';
        const tag = document.createElement('span');
        tag.className='tag';
        tag.innerHTML = `${esc(p.name)}${you}${host}：<b>${Number(p.score||0)}pt</b>`;
        box.appendChild(tag);
      });
      const rest = Math.max(0, MAX_PLAYERS - arr.filter(p=>!p.spectator).length);
      // 順位（得点→正解多→不正解少→時間短）
      const rankList = [...arr.filter(p=>!p.spectator)].sort((a,b)=>{
        if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
        if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
        if((a.wrong||0)!==(b.wrong||0)) return (a.wrong||0)-(b.wrong||0);
        return (a.timeMs||0)-(b.timeMs||0);
      });
      const myIndex = rankList.findIndex(p=>p.id===me.id);
      $('#myRank').textContent = myIndex>=0 ? `${myIndex+1}位` : (me.spectator? "観戦" : "-位");
      const finalRankEl = $('#finalRank'); if(finalRankEl && myIndex>=0) finalRankEl.textContent = `${myIndex+1}位`;
    });
  }

  /* ===== ホスト操作 ===== */
  $('#entryBtn').onclick = async ()=>{
    if(!me.host || me.spectator) return;
    const rRef = doc(db,'rooms',selectedRoom);
    await updateDoc(rRef,{ state:'entry', entryEndsAt: Date.now()+ENTRY_MS });
    snd('seBosyu');
  };
  $('#startBtn').onclick = async ()=>{
    if(!me.host || me.spectator) return;
    // 3・2・1
    snd('seCount');
    $('#qCaption').textContent = '3…'; await sleep(900);
    $('#qCaption').textContent = '2…'; await sleep(900);
    $('#qCaption').textContent = '1…'; await sleep(900);
    $('#qCaption').textContent = 'スタート！'; await sleep(500);
    // 出題スタート
    const rRef = doc(db,'rooms',selectedRoom);
    const snap = await getDoc(rRef); const r = snap.data()||{};
    if(!Array.isArray(r.deck) || r.deck.length===0){
      const idxs=[...Array(pool.length).keys()]; shuffle(idxs);
      await updateDoc(rRef,{ deck: idxs.slice(0, TOTAL_QUESTIONS), currentIndex:0 });
    }
    await updateDoc(rRef,{ state:'play', questionEndsAt: Date.now()+ANSWER_MS });
  };
  $('#stopBtn').onclick = async ()=>{
    if(!me.host || me.spectator) return;
    await updateDoc(doc(db,'rooms',selectedRoom), { state:'finished' });
  };

  /* ===== 解答（全員回答可 / 8秒） ===== */
  document.querySelectorAll('#ansGrid .circle').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const choice = btn.dataset.choice;
      // 問題と正解を取得
      const rRef = doc(db,'rooms',selectedRoom); const snap = await getDoc(rRef); const r = snap.data()||{};
      if(r.state!=='play') return;
      const deck = r.deck||[]; const i = r.currentIndex||0;
      if(!deck.length) return;
      const q = pool[ deck[i] ];
      const ok = (choice===q.answer);
      // スコア反映（重ね押しOK：その回の合計時間短い人が有利に）
      const dt = Math.max(0, ANSWER_MS - Math.max(0, (r.questionEndsAt||0) - Date.now()));
      const pRef = doc(db,'rooms',selectedRoom,'players', me.id);
      await updateDoc(pRef, {
        score: (ok? SCORE_OK : SCORE_NG) + (Number((await getDoc(pRef)).data()?.score)||0),
        correct: (ok? 1:0) + (Number((await getDoc(pRef)).data()?.correct)||0),
        wrong: (!ok? 1:0) + (Number((await getDoc(pRef)).data()?.wrong)||0),
        timeMs: dt + (Number((await getDoc(pRef)).data()?.timeMs)||0),
        lastSeen: serverTimestamp()
      }).catch(()=>{});
      snd(ok?'seCorrect':'seWrong');
      // 判定表示（各自ローカル）
      $('#judge').classList.remove('hidden');
      $('#judge').textContent = ok ? '⭕ 正解！ +2' : '❌ 不正解 −3';
      setTimeout(()=>$('#judge').classList.add('hidden'), 1200);
    });
  });

  /* ===== 自動進行：8秒→次へ、最終で終了 ===== */
  setInterval(async ()=>{
    if(!selectedRoom) return;
    const rRef = doc(db,'rooms',selectedRoom); const snap = await getDoc(rRef); if(!snap.exists()) return;
    const r = snap.data();
    if(r.state!=='play') return;
    if((r.questionEndsAt||0) > Date.now()) return; // まだ時間内

    const next = (r.currentIndex||0) + 1;
    if(next >= TOTAL_QUESTIONS){
      await updateDoc(rRef, { state:'finished', questionEndsAt: 0 });
      return;
    }
    await updateDoc(rRef, { currentIndex: next, questionEndsAt: Date.now()+ANSWER_MS });
  }, 300);

  /* ===== 応援 ===== */
  $('#cheerBtn').onclick = ()=> snd('seKansei');

  /* 初期表示 */
  showHome();
</script>
</body>
</html>
