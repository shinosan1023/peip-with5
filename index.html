<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P. æ—©æŠ¼ã—ã‚¯ã‚¤ã‚ºï¼ˆæœ€å¤§5äººãƒ»15ãƒ«ãƒ¼ãƒ ï¼‰</title>
<style>
  :root{
    --bg:#f6f9f7; --card:#fff; --text:#223; --muted:#667;
    --brand:#ff7f50; --ring:#00b89455;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee;padding:12px}
  h1{margin:0;font-size:18px}
  main{max-width:1100px;margin:18px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin:0 0 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input{padding:10px;border:1px solid #ddd;border-radius:10px;font:inherit}
  button{padding:10px 14px;border:none;border-radius:10px;background:#007bff;color:#fff;cursor:pointer;font:inherit}
  button.pink{background:#ff5aaa}
  button.secondary{background:#6c757d}
  button.warn{background:#ff9800}
  button.danger{background:#dc3545}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f2f2f2;color:#333}
  .muted{color:var(--muted);font-size:12px}
  .big{font-size:22px;font-weight:800;text-align:center;margin:10px 0}
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
  .ans{padding:16px;border-radius:12px;color:#fff;font-weight:800;text-align:center;cursor:pointer;user-select:none}
  .ans.disabled{opacity:.45;pointer-events:none}
  .P{background:#e53935}.E{background:#1e88e5}.I{background:#f1c40f;color:#222}.Ph{background:#2ecc71}
  .room-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
  .room{border:1px solid #eee;border-radius:12px;background:#fff;padding:10px;display:flex;flex-direction:column;gap:8px}
  .room h4{margin:0;font-size:16px}
  .right{margin-left:auto}
  .you{color:#007bff;font-weight:700}
  .host{color:#d35400;font-weight:700}
  .timer{font-weight:900;color:#d32f2f}
  .rank{font-weight:900}
  .resultLine{font-size:22px;font-weight:900;text-align:center;margin:6px 0}
  .c-red{background:#e74c3c;color:#fff}.c-blue{background:#3498db;color:#fff}.c-yellow{background:#ffca28;color:#222}.c-green{background:#2ecc71;color:#fff}.c-orange{background:#ff7f50;color:#222}
  /* 3,2,1 ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #countOverlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.45));display:none;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:120px;z-index:9999;user-select:none}
  #countText{display:block;text-shadow:0 10px 40px rgba(0,0,0,.6)}
  @keyframes pop{0%{transform:scale(.7)}60%{transform:scale(1.18)}100%{transform:scale(1)}}
  .pop{animation:pop .35s ease-out}
  /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ */
  button:focus-visible,input:focus-visible{outline:3px solid var(--ring)}
</style>
</head>
<body>
<header class="row">
  <h1>P.E.I.P. æ—©æŠ¼ã—ã‚¯ã‚¤ã‚º</h1>
  <div class="right row">
    <span class="muted">æœ€å¤§5äººï½œ40å•é€£ç¶šï½œå…ˆç€1åï¼ˆå—ä»˜8ç§’ï¼‰ï½œå‹Ÿé›†60ç§’</span>
    <button id="leaveBtn" class="secondary">é€€å‡º</button>
  </div>
</header>

<main>

  <!-- â‘  å…¥å®¤ï¼šåå‰ï¼‹ä¸€è¨€ï¼‹ãƒ›ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ & ãƒ«ãƒ¼ãƒ ã‚’é¸ã‚“ã§å…¥å®¤ -->
  <section id="joinArea" class="card">
    <h3 style="margin:0 0 10px">â‘  åå‰ã‚’å…¥åŠ›ã—ã¦ã€å…¥ã‚‹ãƒ«ãƒ¼ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
    <div class="row" style="gap:8px">
      <input id="nameInput" placeholder="åå‰ï¼ˆå¿…é ˆï¼‰" />
      <input id="commentInput" placeholder="ä¸€è¨€ï¼ˆ15æ–‡å­—ã¾ã§ãƒ»ä»»æ„ï¼‰" maxlength="15" />
      <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck" />ãƒ›ã‚¹ãƒˆã«ãªã‚‹</label>
      <button id="refreshBtn" class="secondary">æœ€æ–°è¡¨ç¤º</button>
    </div>
    <div class="muted" style="margin:6px 0 10px">â€» ã¾ãšä¸Šã§åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚ä¸‹ã®15ãƒ«ãƒ¼ãƒ ã‹ã‚‰1ã¤ã‚’é¸ã‚“ã§ã€Œå…¥å®¤ã€ã—ã¾ã™ï¼ˆ<b>å‚åŠ ã™ã‚‹ï¼æº–å‚™OK</b>ï¼‰ã€‚</div>

    <div id="roomsGrid" class="room-grid"></div>
  </section>

  <!-- â‘¡ ãƒ«ãƒ¼ãƒ å†…ï¼šå‚åŠ è€…ãƒ»å‹Ÿé›†æ®‹ã‚Šãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰ -->
  <section id="roomArea" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <span>ãƒ«ãƒ¼ãƒ ï¼š</span><span id="roomId" class="pill"></span>
        <span class="muted">çŠ¶æ…‹ï¼š</span><span id="statePill" class="pill">-</span>
        <span class="muted">å‹Ÿé›†æ®‹ã‚Šï¼š</span><span id="entryLeft" class="timer">--</span>
        <span class="muted">ã‚ãªãŸã®é †ä½ï¼š</span><span id="myRank" class="pill">-ä½</span>
      </div>
      <div id="hostTools" class="row" style="display:none">
        <button id="startBtn" class="pink">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <strong>å‚åŠ è€…ï¼ˆæœ€å¤§5äººï¼‰</strong>
      <div id="playersList" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
    </div>
  </section>

  <!-- â‘¢ å•é¡Œã‚¨ãƒªã‚¢ï¼ˆã‚²ãƒ¼ãƒ ä¸­ã®ã¿è¡¨ç¤ºï¼‰ -->
  <section id="qArea" class="card" style="display:none">
    <div id="qIdx" class="muted">å•é¡Œ 0 / 40</div>
    <div id="qText" class="big">-</div>
    <div id="resultLine" class="resultLine"></div>
    <div id="answers" class="answer-grid">
      <div class="ans P"  data-choice="P">ãã‚‚ã¡ï¼ˆPï¼‰</div>
      <div class="ans E"  data-choice="E">ã¾ã‚ã‚Šï¼ˆEï¼‰</div>
      <div class="ans I"  data-choice="I">ã§ãã‚‹ã“ã¨ï¼ˆIï¼‰</div>
      <div class="ans Ph" data-choice="Ph">ã‹ã‚‰ã ï¼†ç—…æ°—ï¼ˆPhï¼‰</div>
    </div>
    <div class="muted" style="margin-top:6px">å—ä»˜æ®‹ã‚Šï¼š<span id="timeLeft" class="timer">--</span></div>
  </section>

  <!-- æ³¨æ„ -->
  <section class="card">
    <div class="muted">
      â€»P.E.I.P.ã¯è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼å¤§å­¦ã®ç¯ ï¨‘è‰¯å‹æ°ãŒä»‹è­·éç¨‹æ•™è‚²ã®è³ªå‘ä¸Šã®ãŸã‚ã«ä½œæˆã—ãŸæ•™æã§ã€è‘—ä½œæ¨©ã¯ç¯ ï¨‘è‰¯å‹æ°ã«ã‚ã‚Šã¾ã™ã€‚P.E.I.P.ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§åˆ†é¡ã™ã‚‹å ´åˆã¯ã€å¿…ãšP.E.I.P.ã‚’å­¦ç¿’ã—ãŸä¸Šã§è¡Œã£ã¦ãã ã•ã„ã€‚
    </div>
  </section>

</main>

<!-- åŠ¹æœéŸ³ï¼ˆindex.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ï¼‰ -->
<audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
<audio id="sndCorrect"   src="se_correct.mp3"  preload="auto"></audio>
<audio id="sndWrong"     src="se_wrong.mp3"    preload="auto"></audio>
<audio id="sndStart"     src="start.mp3"       preload="auto"></audio>

<!-- 3,2,1 ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="countOverlay"><span id="countText">3</span></div>

<!-- Firebaseï¼ˆcompatç‰ˆï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ========== Firebase è¨­å®šï¼ˆpeip-with5ï¼‰ ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== å®šæ•°/ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
const ROOMS = Array.from({length:15}, (_,i)=>`room${i+1}`);
const COLORS = ["c-red","c-blue","c-yellow","c-green","c-orange"];
const labelMap = { P:"ãã‚‚ã¡", E:"ã¾ã‚ã‚Š", I:"ã§ãã‚‹ã“ã¨", Ph:"ã‹ã‚‰ã ï¼†ç—…æ°—" };
const esc = s=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]));
const crown = i => i===1?'ğŸ¥‡':i===2?'ğŸ¥ˆ':i===3?'ğŸ¥‰':i+'ä½';
const now = ()=>Date.now();

/* 40å•ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒƒã‚­ä½œæˆ */
const questionsPool = [
  { text: "å­ã©ã‚‚ã«ä¼šã„ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "æ´—æ¿¯ç‰©ã«ã—ã‚ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
  { text: "ãƒˆã‚¤ãƒ¬ã§ç«‹ä½ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ä¾¿ç§˜ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "æœé£Ÿã®é£²ã¿ç‰©ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "ãƒˆã‚¤ãƒ¬ã®æ‰‹ã™ã‚Šã«ãã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
  { text: "æ­¯ç£¨ãã¯ä¸€äººã§è¡Œãˆã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ã‚€ã›ã“ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å†·è”µåº«ã«æ¶ˆè²»æœŸé™ãŒéããŸé£Ÿå“ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
  { text: "æ­©è¡Œå™¨ã‚’ä½¿ãˆã°è‡ªç«‹æ­©è¡Œã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è¶³ã«ã‚€ãã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "å¥½ããªéŸ³æ¥½ï¼ˆæ›²ãƒ»æ­Œæ‰‹ï¼‰ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "æ´—é¢æ‰€ã®åºŠã¯æ¿¡ã‚Œã¦ã„ãªã„ã‹ï¼Ÿ", answer: "E" },
  { text: "ãƒˆã‚¤ãƒ¬ã®ãƒœã‚¿ãƒ³ã‚’æ“ä½œã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è‚Œã¯ä¹¾ç‡¥ã—ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "æš®ã‚‰ã—ã§å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ãªã„ã‹ï¼Ÿ", answer: "P" },{ text: "æ¯è‹¦ã—ã•ã‚„èƒ¸ã®åœ§è¿«æ„Ÿã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "ç€æ›¿ãˆã¯ä»‹åŠ©ãªã—ã§ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "é£Ÿæ¬²ã‚„æ°´åˆ†æ‘‚å–é‡ã¯ã©ã†ã‹ï¼Ÿ", answer: "Ph" },
  { text: "æ˜”ã—ã¦ã„ãŸä»•äº‹ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "ä½¿ç”¨ã—ã¦ã„ã‚‹ç¦ç¥‰ç”¨å…·ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
  { text: "é›»è©±ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è¦–åŠ›ã¯ã©ã®ç¨‹åº¦ã‹ï¼Ÿ", answer: "Ph" },
  { text: "é£Ÿã¹ãŸã„ã‚‚ã®ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "è‡ªå®…ã§10ãƒŸãƒªä»¥ä¸Šã®æ®µå·®ã¯ãªã„ã‹ï¼Ÿ", answer: "E" },
  { text: "ãŠèŒ¶ã‚’å…¥ã‚Œã¦é£²ã‚€ã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å¤œé–“ã®ç¡çœ çŠ¶æ³ã¯ã©ã†ã‹ï¼Ÿ", answer: "Ph" },
  { text: "ç¿’æ…£ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ", answer: "P" },{ text: "åˆ©ç”¨ã—ã¦ã„ã‚‹ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹ã¯ä½•ã‹ï¼Ÿ", answer: "E" },
  { text: "ä½“æ“ã§ä½“ã‚’å‹•ã‹ã›ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ãµã‚‰ã¤ãã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "è¶£å‘³ã‚’å†é–‹ã—ãŸã„æ€ã„ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å±…å®¤ã®æ¸©åº¦ãƒ»å®¤æ¸©ã¯ï¼Ÿ", answer: "E" },
  { text: "é£Ÿäº‹ã®æº–å‚™ã¯ä¸€äººã§ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "è…°ç—›ãªã©ä½“ã®ç—›ã¿ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "èª¿å‘³æ–™ã«ã“ã ã‚ã‚Šã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "è–¬ã®ç®¡ç†ã§æ‰‹ä¼ã£ã¦ã»ã—ã„ã“ã¨ã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },
  { text: "è–¬ã®ç®¡ç†ã¯ä¸€äººã§è¡Œãˆã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "ã¾ã¶ãŸã«ç›®ã‚„ã«ã¯ã¤ã„ã¦ã„ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "ã©ã®ã‚ˆã†ãªç’°å¢ƒã§å¯ãŸã„æ€ã£ã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "ã‚³ãƒ¼ãƒ«ã®ãƒœã‚¿ãƒ³ã¯é³´ã‚‹ã‹ï¼Ÿ", answer: "E" },
  { text: "åº§ä½ã‚’ã¨ã‚‹ã“ã¨ã¯ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å·»ãçˆªã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "ä½•ã‚’ã—ã¦ã„ã‚‹æ™‚ãŒå¹¸ã›ã‚’æ„Ÿã˜ã‚‹æ™‚ã‹ï¼Ÿ", answer: "P" },{ text: "ç¾åœ¨ã€äº¤æµã®ã‚ã‚‹äººã¯èª°ã‹ï¼Ÿ", answer: "E" },
  { text: "è²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã¯ã§ãã‚‹ã‹ï¼Ÿ", answer: "I" },{ text: "å¤œé–“ã«ä¸çœ ã¯ãªã„ã‹ï¼Ÿ", answer: "Ph" },
  { text: "ãŠæ°—ã«å…¥ã‚Šã®æœã¯ã‚ã‚‹ã‹ï¼Ÿ", answer: "P" },{ text: "å±…å®¤ã®æ›æ°—çŠ¶æ³ã¯ï¼Ÿ", answer: "E" }
];
function makeDeck(){ const idxs=[...Array(questionsPool.length).keys()]; idxs.sort(()=>Math.random()-0.5); return idxs.slice(0,40); }

/* ========== ç”»é¢è¦ç´  ========== */
const joinArea = document.getElementById('joinArea');
const roomsGrid = document.getElementById('roomsGrid');
const roomArea = document.getElementById('roomArea');
const qArea = document.getElementById('qArea');

const nameInput = document.getElementById('nameInput');
const commentInput = document.getElementById('commentInput');
const hostCheck = document.getElementById('hostCheck');
const refreshBtn = document.getElementById('refreshBtn');

const roomIdEl = document.getElementById('roomId');
const statePill = document.getElementById('statePill');
const entryLeft = document.getElementById('entryLeft');
const playersList = document.getElementById('playersList');
const myRankEl = document.getElementById('myRank');
const hostTools = document.getElementById('hostTools');
const startBtn = document.getElementById('startBtn');

const qIdxEl = document.getElementById('qIdx');
const qTextEl = document.getElementById('qText');
const resultLine = document.getElementById('resultLine');
const ansButtons = Array.from(document.querySelectorAll('.ans'));
const timeLeftEl = document.getElementById('timeLeft');
const leaveBtn = document.getElementById('leaveBtn');

const sndCountdown = document.getElementById('sndCountdown');
const sndCorrect   = document.getElementById('sndCorrect');
const sndWrong     = document.getElementById('sndWrong');
const sndStart     = document.getElementById('sndStart');

const countOverlay = document.getElementById('countOverlay');
const countText = document.getElementById('countText');

/* ========== è‡ªåˆ†æƒ…å ± ========== */
function uid(){ const k="peip5-uid"; let v=localStorage.getItem(k); if(!v){ v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
let me = { id: uid(), name:"", comment:"", isHost:false, roomId:null, color:"", joined:false };

/* ========== ãƒ«ãƒ¼ãƒ ä¸€è¦§ï¼šåˆæœŸåŒ– & è¡¨ç¤º ========== */
async function ensureRooms(){
  const batch = db.batch();
  const snaps = await db.collection('rooms').get();
  const have = new Set(snaps.docs.map(d=>d.id));
  ROOMS.forEach(r=>{
    if(!have.has(r)){
      const ref = db.collection('rooms').doc(r);
      batch.set(ref, {
        state: 'lobby', // lobby | entry | countdown | playing | finished
        hostId: null,
        currentIndex: 0,
        deck: [],
        entryDeadline: 0,
        buzzedBy: null,
        answerChoice: null,
        lastResult: null,
        resultKey: "",
        openUntilMs: 0,
        qOpenedAt: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
  });
  if(!snaps.empty) await batch.commit().catch(()=>{});
}
function roomStateEmoji(state){
  return state==='playing'?'ğŸŸ¢é€²è¡Œä¸­'
      : state==='entry'  ?'ğŸŸ¡å‹Ÿé›†ä¸­'
      : state==='countdown'?'ğŸŸ é–‹å§‹ç›´å‰'
      : state==='finished'?'âšªçµ‚äº†'
      :'âš«å¾…æ©Ÿä¸­';
}
async function renderRooms(){
  const snaps = await db.collection('rooms').get();
  let html = '';
  snaps.forEach(d=>{
    const r = d.data()||{};
    const playersCnt = r.playersCount || 0;
    const left = Math.max(0, Math.ceil(((r.entryDeadline||0)-now())/1000));
    html += `<div class="room">
      <h4>${d.id}</h4>
      <div class="muted">${roomStateEmoji(r.state)}ã€€å‚åŠ  ${playersCnt}/5</div>
      ${ r.state==='entry' && left>0 ? `<div class="muted">å‹Ÿé›†æ®‹ã‚Š <b>${left}s</b></div>` : '' }
      <button onclick="joinRoom('${d.id}')" class="pink">å…¥å®¤</button>
    </div>`;
  });
  roomsGrid.innerHTML = html;
}
refreshBtn.onclick = renderRooms;

/* ========== å…¥å®¤ ========== */
async function joinRoom(roomId){
  const name = (nameInput.value||'').trim();
  if(!name){ alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); nameInput.focus(); return; }
  const comment = (commentInput.value||'').trim().slice(0,15);
  const wantHost = !!hostCheck.checked;

  // ãƒ«ãƒ¼ãƒ å‚ç…§
  const roomRef = db.collection('rooms').doc(roomId);
  const playersRef = roomRef.collection('players');

  // å‚åŠ äººæ•°ãƒ»è‰²ã®å‰²å½“
  const snap = await playersRef.get();
  if(snap.size>=5){ alert('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å“¡ã§ã™'); return; }
  const usedColors = []; snap.forEach(d=>{ if(d.data().color) usedColors.push(d.data().color); });
  const color = COLORS.find(c=>!usedColors.includes(c)) || 'c-orange';

  // ãƒ›ã‚¹ãƒˆå‰²å½“ï¼ˆæœªè¨­å®šãªã‚‰å¸Œæœ›è€…ã‚’ãƒ›ã‚¹ãƒˆã«ï¼‰
  const roomDoc = await roomRef.get();
  const r = roomDoc.data()||{};
  const hostId = r.hostId || (wantHost ? me.id : null);
  const state = (r.state==='lobby') ? 'entry' : r.state;
  const entryDeadline = (state==='entry' && !r.entryDeadline) ? (now()+60000) : (r.entryDeadline||0);

  // æ›¸ãè¾¼ã¿
  await Promise.all([
    playersRef.doc(me.id).set({
      name, comment, isHost:(hostId===me.id), color,
      score:0, correct:0, wrong:0, totalAnswerMs:0,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true}),
    roomRef.set({
      state, hostId, entryDeadline
    }, {merge:true})
  ]);

  me = { id: me.id, name, comment, isHost:(hostId===me.id), roomId, color, joined:true };
  try{ sndStart.currentTime=0; sndStart.play(); }catch(_){}

  // ç”»é¢åˆ‡æ›¿
  joinArea.style.display = "none";
  roomArea.style.display = "block";
  qArea.style.display = "none";
  roomIdEl.textContent = roomId;

  subscribeRoom(roomId);
  subscribePlayers(roomId);
}
window.joinRoom = joinRoom;

/* ========== é€€å‡º ========== */
leaveBtn.onclick = async ()=>{
  if(!me.roomId){ location.reload(); return; }
  if(!confirm('ã“ã®ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) return;
  const roomRef = db.collection('rooms').doc(me.roomId);
  const playersRef = roomRef.collection('players');

  try{ await playersRef.doc(me.id).delete(); }catch(_){}
  // ãƒ›ã‚¹ãƒˆãŒã„ãªããªã£ãŸã‚‰æ¬¡ã®äººã‚’ãƒ›ã‚¹ãƒˆã«
  try{
    const roomSnap = await roomRef.get(); const r=roomSnap.data()||{};
    if(r.hostId===me.id){
      const ps = await playersRef.orderBy('joinedAt','asc').get();
      const next = ps.docs.find(d=>d.id!==me.id);
      await roomRef.set({ hostId: next ? next.id : null }, {merge:true});
    }
    // äººæ•°ã‚¼ãƒ­ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
    const left = await playersRef.get();
    if(left.size===0){
      await roomRef.set({
        state:'lobby', hostId:null, currentIndex:0, deck:[],
        entryDeadline:0, buzzedBy:null, answerChoice:null,
        lastResult:null, resultKey:'', openUntilMs:0, qOpenedAt:0
      }, {merge:true});
    }
  }catch(_){}
  location.reload();
};

/* ========== å‚åŠ è€…è³¼èª­ï¼ˆé †ä½è¡¨ç¤ºãƒ»è‰²ä»˜ããƒãƒƒã‚¸ï¼‰ ========== */
let playersCache = [];
function rankCompare(a,b){
  if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
  if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
  if((a.wrong||0)!==(b.wrong||0))   return (a.wrong||0)-(b.wrong||0);
  return (a.totalAnswerMs||0)-(b.totalAnswerMs||0);
}
function renderRank(){
  const sorted = [...playersCache].sort(rankCompare);
  const myIndex = sorted.findIndex(p=>p.id===me.id);
  myRankEl.textContent = (me.roomId && (myIndex>=0)) ? crown(myIndex+1) : '-ä½';
}
function subscribePlayers(roomId){
  const roomRef = db.collection('rooms').doc(roomId);
  const playersRef = roomRef.collection('players');
  playersRef.orderBy('joinedAt','asc').onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
    playersCache = arr;
    // è¡¨ç¤º
    playersList.innerHTML = arr.map(p=>{
      const you = p.id===me.id? '<span class="you">ã‚ãªãŸ</span>' : '';
      const host = p.isHost? '<span class="host">ãƒ›ã‚¹ãƒˆ</span>' : '';
      return `<div class="pill ${esc(p.color||'')}">${esc(p.name)} ${you} ${host} <b>${Number(p.score||0)}pt</b></div>`;
    }).join('');

    // ãƒ«ãƒ¼ãƒ å´ã«äººæ•°ã‚’æ›¸ã„ã¦ãŠãï¼ˆä¸€è¦§ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
    db.collection('rooms').doc(roomId).set({ playersCount: arr.length }, {merge:true}).catch(()=>{});
    renderRank();
    // è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆãªã‚‰ãƒ„ãƒ¼ãƒ«è¡¨ç¤º
    hostTools.style.display = (me.isHost ? "flex" : "none");
  });
}

/* ========== ãƒ«ãƒ¼ãƒ è³¼èª­ï¼ˆçŠ¶æ…‹ãƒ»ã‚¿ã‚¤ãƒãƒ»å•é¡Œã®æµã‚Œï¼‰ ========== */
let roomUnsub = null;
let qTimer = null, entryTimer = null;
function setAnswersEnabled(flag){
  ansButtons.forEach(b=>{ if(flag) b.classList.remove('disabled'); else b.classList.add('disabled'); });
}
function subscribeRoom(roomId){
  if(roomUnsub) roomUnsub();
  const roomRef = db.collection('rooms').doc(roomId);
  roomUnsub = roomRef.onSnapshot(snap=>{
    if(!snap.exists) return;
    const r = snap.data()||{};

    statePill.textContent = r.state || '-';
    // å‹Ÿé›†ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    if(entryTimer) clearInterval(entryTimer);
    entryTimer = setInterval(()=>{
      const left = Math.max(0, Math.ceil(((r.entryDeadline||0)-now())/1000));
      entryLeft.textContent = left>0 ? `${left}s` : "â€”";
    }, 250);

    // ã‚²ãƒ¼ãƒ é–‹å§‹ç›´å‰ï¼š3,2,1
    if(r.state==='countdown' && r.countdownAt){
      runCountdownOverlay(r.countdownAt);
    }

    // é€²è¡Œä¸­ï¼ˆplayingï¼‰ â†’ å•é¡Œè¡¨ç¤º & 8ç§’ã‚¿ã‚¤ãƒ
    if(r.state==='playing'){
      qArea.style.display = "block";
      const deck = r.deck || [];
      const idx  = Math.max(0, Math.min(deck.length-1, r.currentIndex||0));
      const q = questionsPool[ deck[idx] ];
      qIdxEl.textContent = `å•é¡Œ ${idx+1} / ${deck.length||40}`;
      qTextEl.textContent = "ã€Œ" + q.text + "ã€";
      resultLine.textContent = ""; // ã‚¯ãƒªã‚¢

      // å—ä»˜ã‚¿ã‚¤ãƒ
      if(qTimer) clearInterval(qTimer);
      qTimer = setInterval(()=>{
        const ms = Math.max(0, (r.openUntilMs||0) - now());
        timeLeftEl.textContent = (ms/1000).toFixed(1)+"s";
        if(ms<=0) clearInterval(qTimer);
      }, 100);

      // å›ç­”å¯å¦
      setAnswersEnabled( !r.buzzedBy && (now() < (r.openUntilMs||0)) );

      // åˆ¤å®šçµæœãŒå±Šã„ãŸã‚‰éŸ³ï¼†è¡¨ç¤º
      if(r.resultKey){
        if(r.lastResult==='correct'){ try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch(_){ } resultLine.textContent='â­• æ­£è§£ï¼'; }
        else if(r.lastResult==='wrong'){ try{ sndWrong.currentTime=0; sndWrong.play(); }catch(_){ } resultLine.textContent='âŒ ä¸æ­£è§£'; }
        else if(r.lastResult==='timeout'){ resultLine.textContent='â° æ™‚é–“åˆ‡ã‚Œ'; }
      }
    }else{
      // ã‚²ãƒ¼ãƒ å¤–
      qArea.style.display = "none";
    }
  });
}

/* ========== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆ3,2,1ï¼‰ ========== */
function runCountdownOverlay(atMs){
  const startAt = atMs; // ã‚µãƒ¼ãƒå€¤ç›¸å½“ï¼ˆmsï¼‰
  const marks = [
    {t:0.00, v:"3"},{t:0.90, v:"2"},{t:1.80, v:"1"},{t:2.65, v:"ã‚¹ã‚¿ãƒ¼ãƒˆï¼"}
  ];
  const hold = 1.6; // ã‚¹ã‚¿ãƒ¼ãƒˆè¡¨ç¤ºã®ä¿æŒ
  const end  = marks.at(-1).t + hold;

  countOverlay.style.display = 'flex';
  let idx = 0;
  try{ sndCountdown.currentTime=0; sndCountdown.play(); }catch(_){}
  const tick = ()=>{
    const elapsed = (now()-startAt)/1000;
    while(idx<marks.length && elapsed >= marks[idx].t){
      countText.textContent = marks[idx].v; countText.classList.remove('pop'); void countText.offsetWidth; countText.classList.add('pop'); idx++;
    }
    if(elapsed < end){ requestAnimationFrame(tick); }
    else{ countOverlay.style.display='none'; }
  };
  requestAnimationFrame(tick);
}

/* ========== ãƒ›ã‚¹ãƒˆæ“ä½œï¼šã‚¹ã‚¿ãƒ¼ãƒˆ & å•é¡Œã‚ªãƒ¼ãƒ—ãƒ³/è‡ªå‹•é€²è¡Œ ========== */
startBtn.onclick = async ()=>{
  if(!me.isHost || !me.roomId) return;
  const roomRef = db.collection('rooms').doc(me.roomId);
  const doc = await roomRef.get(); const r=doc.data()||{};
  // ãƒ‡ãƒƒã‚­ãŒç„¡ã‘ã‚Œã°ä½œæˆ
  const deck = (r.deck && r.deck.length) ? r.deck : makeDeck();
  const countdownAt = now()+600; // 0.6ç§’å¾Œã«3,2,1é–‹å§‹ï¼ˆé…ä¿¡ã®ãƒ©ã‚°å¸åç”¨ï¼‰
  await roomRef.set({
    deck, currentIndex:0, countdownAt, state:'countdown',
    lastResult:null, resultKey:"", buzzedBy:null, answerChoice:null
  }, {merge:true});

  // 3,2,1 çµ‚äº†å¾Œã« 1å•ç›®ã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆãƒ›ã‚¹ãƒˆå´ãŒä¸»å°ï¼‰
  setTimeout(async ()=>{
    await openQuestion(0);
  }, 3000 + 400); // éŸ³ï¼‹å°‘ã—ä½™è£•
};

async function openQuestion(index){
  if(!me.isHost || !me.roomId) return;
  const roomRef = db.collection('rooms').doc(me.roomId);
  const ms = now();
  await roomRef.set({
    state:'playing',
    currentIndex:index,
    buzzedBy:null,
    answerChoice:null,
    lastResult:null,
    resultKey:"",
    qOpenedAt: ms,
    openUntilMs: ms + 8000 // å—ä»˜8ç§’
  }, {merge:true});

  // è‡ªå‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ†’æ¬¡ã¸
  setTimeout(async ()=>{
    const doc = await roomRef.get(); const r=doc.data()||{};
    if(r.state==='playing' && !r.buzzedBy && (now() >= (r.openUntilMs||0))){
      await roomRef.set({ lastResult:'timeout', resultKey:String(now()) }, {merge:true});
      // 2ç§’å¾Œã«æ¬¡ã¸
      setTimeout(()=>advanceNext(), 2000);
    }
  }, 8200);
}

async function advanceNext(){
  if(!me.isHost || !me.roomId) return;
  const roomRef = db.collection('rooms').doc(me.roomId);
  const doc = await roomRef.get(); const r=doc.data()||{};
  const deck = r.deck || [];
  const next = (r.currentIndex||0) + 1;
  if(next >= deck.length){ // çµ‚äº†
    await roomRef.set({ state:'finished', openUntilMs:0 }, {merge:true});
    alert('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚');
    return;
  }
  openQuestion(next);
}

/* ========== å›ç­”ï¼šå…ˆç€1åï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ ========== */
ansButtons.forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    if(!me.roomId) return;
    const choice = btn.dataset.choice;
    const roomRef = db.collection('rooms').doc(me.roomId);

    let winner=false;
    await db.runTransaction(async tx=>{
      const doc = await tx.get(roomRef); if(!doc.exists) return;
      const r = doc.data()||{};
      if(r.state!=='playing') return;                          // çŠ¶æ…‹ç¢ºèª
      if((r.openUntilMs||0) < now()) return;                   // å—ä»˜çµ‚äº†
      if(r.buzzedBy) return;                                   // å…ˆç€æ¸ˆã¿
      winner = true;
      tx.update(roomRef, { buzzedBy: me.id, answerChoice: choice });
    });

    // å…ˆç€ã‚’å–ã£ãŸå´ï¼ˆã¾ãŸã¯ãƒ›ã‚¹ãƒˆå´ï¼‰ã§åˆ¤å®šã—ã¦ã‚¹ã‚³ã‚¢æ›´æ–°
    if(winner){
      const doc = await roomRef.get(); const r=doc.data()||{};
      const deck = r.deck || [];
      const idx  = Math.max(0, Math.min(deck.length-1, r.currentIndex||0));
      const q    = questionsPool[ deck[idx] ];
      const ok   = (r.answerChoice === q.answer);
      const delta= ok ? +2 : -2;

      const playersRef = roomRef.collection('players');
      // å›ç­”æ™‚é–“ï¼ˆmsï¼‰
      const elapsedMs = Math.max(0, now() - (r.qOpenedAt||now()));
      await Promise.all([
        playersRef.doc(me.id).set({
          score: firebase.firestore.FieldValue.increment(delta),
          correct: firebase.firestore.FieldValue.increment(ok?1:0),
          wrong: firebase.firestore.FieldValue.increment(ok?0:1),
          totalAnswerMs: firebase.firestore.FieldValue.increment(elapsedMs)
        }, {merge:true}),
        roomRef.set({
          lastResult: ok?'correct':'wrong',
          resultKey: String(now())
        }, {merge:true})
      ]);
      // 2ç§’å¾Œã«æ¬¡ã®å•é¡Œï¼ˆãƒ›ã‚¹ãƒˆãŒé€²è¡Œï¼‰
      setTimeout(()=>advanceNext(), 2000);
    }
  });
});

/* ========== åˆæœŸèµ·å‹•ï¼šãƒ«ãƒ¼ãƒ ç”Ÿæˆï¼†ä¸€è¦§æç”» ========== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await ensureRooms();
  await renderRooms();
});
</script>
</body>
</html>
