<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P.E.I.P. 早押しクイズ（最大5人・観戦可）</title>

<!-- ====== 見た目 ====== -->
<style>
  :root{
    --text:#222; --muted:#666; --card:#fff;
    --pill:#f3f4f6; --accent:#0d6efd; --ok:#2e7d32; --ng:#d32f2f;
    --ring:#00b89455; --danger:#dc3545; --warn:#ff9800;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;background:#f7faf9;color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid #eee;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:18px}
  main{max-width:980px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid #eee;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.04);padding:14px;margin:0 0 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);border-radius:999px;padding:4px 10px}
  .muted{color:var(--muted);font-size:12px}
  input,button,select,textarea{font:inherit}
  input,select,textarea{border:1px solid #ddd;border-radius:8px;padding:8px}
  button{border:none;border-radius:10px;padding:10px 14px;background:var(--accent);color:#fff;cursor:pointer}
  button.secondary{background:#6c757d;color:#fff}
  button.warn{background:var(--warn);color:#fff}
  button.danger{background:var(--danger);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .right{margin-left:auto}
  .big{font-size:22px;font-weight:800;text-align:center;margin:6px 0 0}
  .center{display:flex;align-items:center;justify-content:center}
  .grid-rooms{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
  .roomBtn{background:#fff;border:1px solid #eee;border-radius:12px;padding:10px;box-shadow:0 6px 14px rgba(0,0,0,.04);display:flex;flex-direction:column;gap:6px;cursor:pointer}
  .roomBtn.active{outline:3px solid #a5d6ff}
  .tag{font-weight:700}
  .tag-you{color:#000} .tag-host{color:#000}
  .timer{font-weight:800;color:#d32f2f}
  .rank{font-weight:800}
  .qno{font-weight:700}
  .question{font-size:22px;font-weight:800;text-align:center;margin:10px 0}
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;max-width:520px;margin:8px auto}
  .ans{width:140px;height:140px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;margin:auto;box-shadow:0 10px 26px rgba(0,0,0,.12);cursor:pointer;border:4px solid #fff}
  .ans.P{background:#e53935}.ans.E{background:#1e88e5}.ans.I{background:#ffca28;color:#222}.ans.Ph{background:#43a047}
  .ans.disabled{opacity:.45;pointer-events:none}
  .resultOK{color:var(--ok);font-size:26px;font-weight:900;text-align:center}
  .resultNG{color:var(--ng);font-size:26px;font-weight:900;text-align:center}
  .list{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border:1px solid #eee;background:#fff;border-radius:999px;padding:6px 10px}
  .players{display:flex;gap:8px;flex-wrap:wrap}
  .c-red{background:#e74c3c;color:#fff}.c-blue{background:#3498db;color:#fff}.c-yellow{background:#ffca28;color:#222}.c-green{background:#2ecc71;color:#fff}.c-orange{background:#ff7f50;color:#222}
  .name{font-weight:800}
  .score{font-weight:800}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:120px;z-index:50}
  .pop{animation:pop .35s ease-out}
  @keyframes pop{0%{transform:scale(.7)}60%{transform:scale(1.15)}100%{transform:scale(1)}}
</style>
</head>
<body>

<header>
  <h1>P.E.I.P. 早押しクイズ</h1>
  <div class="row right">
    <label class="pill"><input type="checkbox" id="soundToggle" checked /> 音声: <b id="soundState">ON</b></label>
    <button class="secondary" id="leaveBtn">退出する</button>
  </div>
</header>

<main>
  <!-- ① 名前 -->
  <section id="step1" class="card">
    <h3 style="margin:0 0 8px;">① 名前を入力</h3>
    <div class="row">
      <input id="nameInput" placeholder="表示名" />
      <label class="row" style="gap:6px"><input type="checkbox" id="hostCheck" /> ホストになる</label>
      <span class="muted">※「参加」はゲーム参加者／「観戦」は見るだけ（無制限）</span>
    </div>
  </section>

  <!-- ② ルーム選択 -->
  <section id="step2" class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">② ルームを選ぶ（全15室）</h3>
      <div class="row">
        <button id="joinBtn"   disabled>参加</button>
        <button id="watchBtn"  class="secondary" disabled>観戦</button>
      </div>
    </div>
    <div id="rooms" class="grid-rooms"></div>
    <div class="muted" style="margin-top:8px">※ ルームを選んでから「参加」または「観戦」を押してください</div>
  </section>

  <!-- ルーム内 -->
  <section id="roomCard" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:10px">
        <span class="pill">ルーム：<b id="roomIdView"></b></span>
        <span class="pill">状態：<b id="statePill">-</b></span>
        <span class="pill">募集終了まで：<b id="entryLeft">--:--</b></span>
        <span class="pill">残り問題：<b id="remainQ">40</b></span>
        <span class="pill">あなたの順位：<b id="myRank">-位</b></span>
      </div>
      <div id="hostTools" class="row" style="display:none">
        <button id="entryBtn" class="warn">募集開始（60秒）</button>
        <button id="startBtn">ゲーム開始</button>
        <button id="endBtn" class="danger">中止</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <strong>参加者（最大5人）</strong>
      <div id="players" class="players" style="margin-top:8px"></div>
      <div class="muted" style="margin-top:4px">残り：<b id="seatsLeft">--</b> 名</div>
    </div>
  </section>

  <!-- 出題 -->
  <section id="playCard" class="card" style="display:none">
    <div class="center">
      <div class="chip">問題 <span id="qIdx" class="qno">0</span> / 40</div>
      <div class="chip">回答残り <span id="answerLeft" class="timer">-.-s</span></div>
    </div>
    <div id="qText" class="question">（問題は「3,2,1」のあとに表示）</div>
    <div id="resultLine" class="big"></div>
    <div class="answer-grid">
      <div class="ans P"  data-choice="P">きもち</div>
      <div class="ans E"  data-choice="E">まわり</div>
      <div class="ans I"  data-choice="I">できること</div>
      <div class="ans Ph" data-choice="Ph">からだ＆病気</div>
    </div>
  </section>

  <!-- 観戦・応援 -->
  <section id="watchCard" class="card" style="display:none">
    <h3 style="margin:0 0 8px">観戦・応援</h3>
    <div class="row">
      <input id="cheerName" placeholder="名無し" style="width:200px">
      <textarea id="cheerText" placeholder="応援コメント（誰でも送信可）" rows="2" style="flex:1;min-width:260px"></textarea>
      <button id="sendCheer" class="secondary">送信</button>
      <button id="playCheer" class="warn">応援</button>
    </div>
    <div id="cheerLog" class="list" style="margin-top:8px"></div>
    <div class="muted">※「応援」は何度でも鳴らせます（kansei.mp3）</div>
  </section>

  <!-- 使い方 -->
  <section class="card">
    <ul style="margin:0 0 0 18px">
      <li>URLアクセス → 名前入力 → ルームを選ぶ →「<b>参加</b>」または「<b>観戦</b>」→（<b>ホストがゲーム開始</b>）→ 40問が連続で出題。</li>
      <li>開始前に <b>募集開始（60秒）</b> を押すと、エントリー受付の残り時間が表示されます。</li>
      <li>各問は <b>3,2,1（countdown.mp3）</b> の直後に表示。<b>回答8秒</b>。正解は<b>+2点</b>、不正解は<b>-3点</b>。終了まで自動進行（各問の結果を2秒表示）。</li>
      <li>順位の同点は <b>正解数が多い → 誤答が少ない → 回答までの総時間が短い</b> の順で決定。</li>
      <li>終了時に <b>gongu.mp3</b> が鳴り、あなたの順位を表示します。</li>
    </ul>
  </section>

  <section class="card muted">
    ※P.E.I.P.は聖隷クリストファー大学の篠﨑良勝氏が介護過程教育の質向上のために作成した教材で、著作権は篠﨑良勝氏にあります。
    P.E.I.P.フレームワークで分類する場合は、必ずP.E.I.P.を学習した上で行ってください。
  </section>
</main>

<!-- 3,2,1 オーバーレイ -->
<div id="overlay" class="overlay"><span id="ovText">3</span></div>

<!-- ====== 効果音（同フォルダ） ====== -->
<audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
<audio id="sndOK"        src="se_correct.mp3" preload="auto"></audio>
<audio id="sndNG"        src="se_wrong.mp3"   preload="auto"></audio>
<audio id="sndEnd"       src="gongu.mp3"      preload="auto"></audio>
<audio id="sndKansei"    src="kansei.mp3"     preload="auto"></audio>

<!-- ====== Firebase（compat でコピペ可） ====== -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ========== Firebase 設定（peip-with5） ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== 共通ユーティリティ ========== */
const $ = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const esc = (s)=>String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]));
const colors = ["c-red","c-blue","c-yellow","c-green","c-orange"];
function uid(){ const k="peip-uid"; let v=localStorage.getItem(k); if(!v){v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
function now(){ return Date.now(); }
function fmtMMSS(ms){ if(!ms||ms<0) return "--:--"; const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,"0"); return `${m}:${ss}`; }

/* ========== サウンド ON/OFF ========== */
let soundOn = true;
$("soundToggle").addEventListener("change",()=>{
  soundOn = $("soundToggle").checked;
  $("soundState").textContent = soundOn ? "ON":"OFF";
  for(const id of ["sndCountdown","sndOK","sndNG","sndEnd","sndKansei"]){
    const el=$(id); el.muted = !soundOn;
    if(!soundOn){ try{ el.pause(); el.currentTime=0; }catch(_){ } }
  }
});
function play(id){ if(!soundOn) return; try{ $(id).currentTime=0; $(id).play(); }catch(_){} }

/* ========== 質問プール（ここから40問ランダム） ========== */
const pool = [
  { text: "子どもに会いたいと思っているか？", answer: "P" },{ text: "洗濯物にしわはないか？", answer: "E" },
  { text: "トイレで立位をとることができるか？", answer: "I" },{ text: "便秘はないか？", answer: "Ph" },
  { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },{ text: "トイレの手すりにぐらつきはないか？", answer: "E" },
  { text: "歯磨きは一人で行えているか？", answer: "I" },{ text: "むせこみはないか？", answer: "Ph" },
  { text: "デイサービスを楽しみにしているか？", answer: "P" },{ text: "冷蔵庫に消費期限が過ぎた食品はないか？", answer: "E" },
  { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },{ text: "足にむくみはないか？", answer: "Ph" },
  { text: "好きな音楽（曲・歌手）は何か？", answer: "P" },{ text: "洗面所の床は濡れていないか？", answer: "E" },
  { text: "トイレのボタンを操作することはできるか？", answer: "I" },{ text: "肌は乾燥していないか？", answer: "Ph" },
  { text: "暮らしで困っていることはないか？", answer: "P" },{ text: "息苦しさや胸の圧迫感はないか？", answer: "Ph" },
  { text: "着替えは介助なしでできるか？", answer: "I" },{ text: "食欲や水分摂取量はどうか？", answer: "Ph" },
  { text: "昔していた仕事は何か？", answer: "P" },{ text: "使用している福祉用具は何か？", answer: "E" },
  { text: "電話をかけることができるか？", answer: "I" },{ text: "視力はどの程度か？", answer: "Ph" },
  { text: "食べたいものはあるか？", answer: "P" },{ text: "自宅で10ミリ以上の段差はないか？", answer: "E" },
  { text: "お茶を入れて飲むことはできるか？", answer: "I" },{ text: "夜間の睡眠状況はどうか？", answer: "Ph" },
  { text: "習慣となっていることは何か？", answer: "P" },{ text: "利用している介護サービスは何か？", answer: "E" },
  { text: "体操で体を動かせているか？", answer: "I" },{ text: "ふらつきはないか？", answer: "Ph" },
  { text: "趣味を再開したい思いはあるか？", answer: "P" },{ text: "居室の温度・室温は？", answer: "E" },
  { text: "食事の準備は一人でできるか？", answer: "I" },{ text: "腰痛など体の痛みはないか？", answer: "Ph" },
  { text: "調味料にこだわりはあるか？", answer: "P" },{ text: "薬の管理で手伝ってほしいことはあるか？", answer: "P" },
  { text: "薬の管理は一人で行えているか？", answer: "I" },{ text: "まぶたに目やにはついていないか？", answer: "Ph" },
  { text: "どのような環境で寝たい思っているか？", answer: "P" },{ text: "コールのボタンは鳴るか？", answer: "E" },
  { text: "座位をとることはできているか？", answer: "I" },{ text: "巻き爪はないか？", answer: "Ph" },
  { text: "何をしている時が幸せを感じる時か？", answer: "P" },{ text: "現在、交流のある人は誰か？", answer: "E" },
  { text: "買い物リストを書くことはできるか？", answer: "I" },{ text: "夜間に不眠はないか？", answer: "Ph" },
  { text: "お気に入りの服はあるか？", answer: "P" },{ text: "居室の換気状況は？", answer: "E" }
];

/* ========== アプリ状態 ========== */
const me = { id: uid(), name:"", isHost:false, spectator:false, roomId:"", color:"", joined:false };
let roomRef = null, playersRef = null, msgsRef = null;
let unsubRoom = null, unsubPlayers = null, unsubMsgs = null;
let playersCache = [];
let answerDeadline = 0;
let entryTimer = null, ansTimer = null;
const NQ = 40; const ANSWER_MS = 8000; const REVEAL_MS = 2000;

/* ========== ルーム一覧（15室） ========== */
const allRooms = Array.from({length:15},(_,i)=>`room-${String(i+1).padStart(2,"0")}`);
const roomTiles = {};
async function renderRooms(){
  const wrap = $("rooms"); wrap.innerHTML = "";
  const snap = await db.collection("rooms").get();
  const occ = {}; snap.forEach(d=>occ[d.id]=d.data());
  allRooms.forEach(r=>{
    const d = occ[r] || {};
    const cap = 5;
    const seats = Math.max(0, cap - (d.memberCount||0));
    const el = document.createElement("button");
    el.className="roomBtn"; el.id=`tile-${r}`;
    el.innerHTML = `<div><b>${r}</b></div>
      <div class="muted">状態：${esc(d.state||"lobby")}</div>
      <div class="muted">残り：<b>${seats}</b> 名</div>`;
    el.onclick = ()=>{
      for(const k in roomTiles){ roomTiles[k].classList.remove("active"); }
      el.classList.add("active");
      me.roomId = r;
      $("joinBtn").disabled = !$("nameInput").value.trim();
      $("watchBtn").disabled= !$("nameInput").value.trim();
    };
    roomTiles[r]=el; wrap.appendChild(el);
  });
}
renderRooms();

/* ========== 入力ガード ========= */
$("nameInput").addEventListener("input", ()=>{
  const ok = !!$("nameInput").value.trim() && !!me.roomId;
  $("joinBtn").disabled = !ok; $("watchBtn").disabled = !ok;
});
$("hostCheck").addEventListener("change", ()=>{ /* 表示用だけ（入室時に確定） */ });

/* ========== 参加 / 観戦 ========= */
$("joinBtn").onclick = async ()=>{
  const name = $("nameInput").value.trim(); if(!name){ alert("名前を入力してください。"); return; }
  me.name=name; me.isHost=$("hostCheck").checked; me.spectator=false;
  await enterRoom();
};
$("watchBtn").onclick = async ()=>{
  const name = $("nameInput").value.trim() || "名無し";
  me.name=name; me.isHost=false; me.spectator=true;
  await enterRoom();
};

async function enterRoom(){
  if(!me.roomId){ alert("ルームを選んでください。"); return; }
  roomRef   = db.collection("rooms").doc(me.roomId);
  playersRef= roomRef.collection("players");
  msgsRef   = roomRef.collection("messages");
  // ルーム初期化（なければ）
  await roomRef.set({ state:"lobby", createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });

  // 色の割り当て（参加者のみ）
  let color = ""; 
  if(!me.spectator){
    const snap = await playersRef.get();
    const used=[]; snap.forEach(d=>{ if(d.data().color) used.push(d.data().color); });
    color = colors.find(c=>!used.includes(c)) || "c-orange";
  }
  me.color = color;

  // 参加／観戦を登録
  await playersRef.doc(me.id).set({
    name: me.name, isHost: !!me.isHost, spectator: !!me.spectator, color: me.color,
    score:0, correct:0, wrong:0, timeMs:0,
    lastAnsIdx:-1, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  me.joined = true;
  $("step1").style.display="none"; $("step2").style.display="none";
  $("roomCard").style.display="block"; $("watchCard").style.display="block";
  $("roomIdView").textContent = me.roomId;

  if(unsubRoom) unsubRoom(); if(unsubPlayers) unsubPlayers(); if(unsubMsgs) unsubMsgs();
  subscribeRoom(); subscribePlayers(); subscribeMessages();
}

/* ========== 退出（参加者/観戦者どちらも可） ========= */
$("leaveBtn").onclick = async ()=>{
  if(!me.joined){ location.reload(); return; }
  try{ await playersRef.doc(me.id).delete(); }catch(_){}
  me.joined=false; location.reload();
};

/* ========== ルーム購読・進行（ホストがエンジン） ========= */
function subscribeRoom(){
  unsubRoom = roomRef.onSnapshot(async doc=>{
    if(!doc.exists) return;
    const r = doc.data();
    $("statePill").textContent = r.state||"-";
    $("remainQ").textContent   = String(Math.max(0, NQ - (r.currentIndex||0)));
    // 募集残り
    if(entryTimer) clearInterval(entryTimer);
    if(r.entryDeadline){
      entryTimer = setInterval(()=>{
        const left = r.entryDeadline - now();
        $("entryLeft").textContent = fmtMMSS(left);
        if(left<=0) clearInterval(entryTimer);
      }, 250);
    }else{
      $("entryLeft").textContent = "--:--";
    }

    // ホスト用ボタン表示
    $("hostTools").style.display = me.isHost ? "flex" : "none";
    $("startBtn").disabled = !(me.isHost && (r.state==="lobby"||r.state==="ready") );

    // 状態に応じてUI
    if(r.state==="lobby"||r.state==="ready"){
      $("playCard").style.display="none";
      $("resultLine").textContent="";
      $("qText").textContent="（問題は「3,2,1」のあとに表示）";
      setAnswersDisabled(true);
    }
    if(r.state==="countdown"){
      $("playCard").style.display="block";
      startOverlay321(); play("sndCountdown");
      setAnswersDisabled(true);
    }
    if(r.state==="question"){
      $("playCard").style.display="block";
      const deck = r.deck||[]; const idx=r.currentIndex||0;
      const q = deck.length? pool[ deck[idx] ] : null;
      $("qIdx").textContent = String(idx+1);
      $("qText").textContent = q ? `「${q.text}」` : "（問題）";
      $("resultLine").textContent="";
      setAnswersDisabled(false);
      // 回答残り時間
      if(ansTimer) clearInterval(ansTimer);
      answerDeadline = (r.questionStartMs||now()) + ANSWER_MS;
      ansTimer = setInterval(()=>{
        const left = Math.max(0, answerDeadline - now());
        $("answerLeft").textContent = (left/1000).toFixed(1)+"s";
        if(left<=0) clearInterval(ansTimer);
      }, 100);
    }
    if(r.state==="reveal"){
      setAnswersDisabled(true);
    }
    if(r.state==="ended"){
      $("playCard").style.display="block";
      setAnswersDisabled(true);
      $("qText").textContent = "終了！";
      $("resultLine").innerHTML = "<div class='big'>お疲れさまでした。</div>";
      play("sndEnd");
      // 順位表示（「あなたの順位は○人中○位でした。」）
      showMyRankSummary();
    }

    // ホストはステート遷移をドライブ
    if(me.isHost) hostDrive(r);
  });
}

/* ========== ホストが状態を進める ========== */
let driving = false;
async function hostDrive(r){
  if(driving) return;
  driving = true;
  try{
    if(r.state==="countdown"){
      // 3,2,1 → 出題へ
      await sleep(3300);
      await roomRef.update({ state:"question", questionStartMs: now() });
    }else if(r.state==="question"){
      // 8秒後に採点 → reveal
      const start = r.questionStartMs||now();
      const wait  = Math.max(0, start + ANSWER_MS - now());
      await sleep(wait);
      await scoreCurrentQuestion(r);
      await roomRef.update({ state:"reveal", revealUntil: now()+REVEAL_MS });
    }else if(r.state==="reveal"){
      // 2秒後 次へ or 終了
      const until = r.revealUntil||now();
      const wait  = Math.max(0, until - now());
      await sleep(wait);
      const next = (r.currentIndex||0) + 1;
      if(next >= NQ){
        await roomRef.update({ state:"ended" });
      }else{
        await roomRef.update({ state:"countdown", currentIndex: next });
      }
    }
  }catch(e){ console.error(e); }
  driving = false;
}

/* 採点（各プレイヤーの answers/{idx} を集計して加点） */
async function scoreCurrentQuestion(r){
  const deck = r.deck||[]; const idx=r.currentIndex||0;
  const q = deck.length? pool[ deck[idx] ] : null; if(!q) return;
  const ps = await playersRef.get();
  const batch = db.batch();
  for(const d of ps.docs){
    const p = { id:d.id, ...d.data() }; if(p.spectator) continue;
    const aDoc = await playersRef.doc(p.id).collection("answers").doc(String(idx)).get();
    if(!aDoc.exists){ // 未回答→不正解扱いにせず0点（要望あれば変更可能）
      continue;
    }
    const a = aDoc.data();
    const ok = a.choice===q.answer;
    const delta = ok ? +2 : -3;
    const inc = firebase.firestore.FieldValue.increment(delta);
    const incC= firebase.firestore.FieldValue.increment(ok?1:0);
    const incW= firebase.firestore.FieldValue.increment(ok?0:1);
    const incT= firebase.firestore.FieldValue.increment(Math.max(0,a.timeMs||0));
    batch.set(playersRef.doc(p.id), { score:inc, correct:incC, wrong:incW, timeMs:incT }, { merge:true });
    // 個別結果ヒント（自分の画面で鳴る用）
    if(p.id===me.id){ $("resultLine").innerHTML = ok ? `<div class="resultOK">⭕ 正解！</div>` : `<div class="resultNG">❌ 不正解</div>`; play(ok?"sndOK":"sndNG"); }
  }
  await batch.commit();
}

/* ========== プレイヤー購読（座席/順位） ========== */
function subscribePlayers(){
  unsubPlayers = playersRef.orderBy("joinedAt","asc").onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() })); playersCache = arr;

    // ルームの memberCount（座席残りのため）
    roomRef.set({ memberCount: arr.filter(x=>!x.spectator).length }, { merge:true });

    // 参加者一覧
    const box=$("players"); box.innerHTML="";
    const youId = me.id;
    arr.filter(x=>!x.spectator).forEach(p=>{
      const chip=document.createElement("div");
      chip.className=`pill ${esc(p.color||"")}`;
      const you = p.id===youId ? `<span class="tag tag-you">あなた</span>`:"";
      const host= p.isHost ? `<span class="tag tag-host">ホスト</span>`:"";
      chip.innerHTML = `<span class="name">${esc(p.name)}</span> ${you} ${host} <span class="score">${Number(p.score||0)}pt</span>`;
      box.appendChild(chip);
    });

    // 残り座席
    const cap=5; const seats = Math.max(0, cap - arr.filter(x=>!x.spectator).length);
    $("seatsLeft").textContent = String(seats);

    // 順位（スコア降順 => 正解多 => 誤答少 => 時間短）
    const order=[...arr].filter(x=>!x.spectator).sort((a,b)=>{
      if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
      if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
      if((a.wrong||0)!==(b.wrong||0))     return (a.wrong||0)-(b.wrong||0);
      return (a.timeMs||0)-(b.timeMs||0);
    });
    const myIndex = order.findIndex(x=>x.id===me.id);
    $("myRank").textContent = (myIndex>=0) ? `${myIndex+1}位` : (me.spectator? "観戦" : "-位");
  });
}

/* ========== 観戦コメント ========= */
function subscribeMessages(){
  unsubMsgs = msgsRef.orderBy("createdAt","desc").limit(20).onSnapshot(snap=>{
    const wrap=$("cheerLog"); wrap.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="chip";
      div.textContent=`${m.name||"名無し"}：${m.text||""}`;
      wrap.appendChild(div);
    });
  });
}
$("sendCheer").onclick = async ()=>{
  await msgsRef.add({ name:$("cheerName").value||"名無し", text:$("cheerText").value||"", createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  $("cheerText").value="";
};
$("playCheer").onclick = ()=> play("sndKansei");

/* ========== 回答 ========== */
const ansBtns = Array.from(document.querySelectorAll(".ans"));
function setAnswersDisabled(flag){ ansBtns.forEach(b=>b.classList.toggle("disabled",flag)); }
ansBtns.forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const choice = btn.dataset.choice;
    const doc = await roomRef.get(); const r=doc.data();
    if(r.state!=="question") return;
    const idx = r.currentIndex||0;
    const left = (r.questionStartMs||now()) + ANSWER_MS - now();
    if(left<=0) return; // 時間切れ
    // 1問1回だけ受け取る（上書きしない）
    const aRef = playersRef.doc(me.id).collection("answers").doc(String(idx));
    const exists = await aRef.get(); if(exists.exists) return;
    const t = Math.max(0, now() - (r.questionStartMs||now()));
    await aRef.set({ choice, answeredAt: firebase.firestore.FieldValue.serverTimestamp(), timeMs: t });
  });
});

/* ========== 3,2,1 オーバーレイ ========== */
async function startOverlay321(){
  const ov=$("overlay"), tx=$("ovText");
  ov.style.display="flex";
  const seq=["3","2","1","スタート！"];
  for(const s of seq){ tx.textContent=s; tx.classList.remove("pop"); void tx.offsetWidth; tx.classList.add("pop"); await sleep(800); }
  ov.style.display="none";
}

/* ========== ホスト操作 ========== */
$("entryBtn").onclick = async ()=>{ if(!me.isHost) return; await roomRef.update({ entryDeadline: now()+60000 }); };
$("startBtn").onclick = async ()=>{
  if(!me.isHost) return;
  // デッキ作成（プールから40問ランダム）
  const idxs=[...Array(pool.length).keys()]; idxs.sort(()=>Math.random()-0.5);
  const deck = idxs.slice(0, Math.min(NQ, idxs.length));
  await roomRef.set({ deck, currentIndex:0, state:"countdown", entryDeadline:null }, { merge:true });
};
$("endBtn").onclick = async ()=>{ if(me.isHost) await roomRef.update({ state:"ended" }); };

/* ========== 終了時の要約（あなたの順位は○人中○位でした） ========== */
function showMyRankSummary(){
  const order=[...playersCache].filter(x=>!x.spectator).sort((a,b)=>{
    if((b.score||0)!==(a.score||0)) return (b.score||0)-(a.score||0);
    if((b.correct||0)!==(a.correct||0)) return (b.correct||0)-(a.correct||0);
    if((a.wrong||0)!==(b.wrong||0))     return (a.wrong||0)-(b.wrong||0);
    return (a.timeMs||0)-(b.timeMs||0);
  });
  const rank = Math.max(0, order.findIndex(x=>x.id===me.id))+1;
  const total = order.length||1;
  $("resultLine").innerHTML = `<div class="big">あなたの順位は <b>${rank}</b> / ${total} 位でした。お疲れさまでした。</div>`;
}

/* ========== 初期起動 ========== */
$("joinBtn").disabled = true; $("watchBtn").disabled = true;
</script>
</body>
</html>
