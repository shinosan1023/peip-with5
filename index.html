<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>P.E.I.P. 早押しクイズ（最大5人・オンライン）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f6faf8; --card:#fff; --text:#222;
    --muted:#666; --pill:#f0f0f0;
    --brand:#ff7f9e; /* スタート（ピンク） */
  }
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;margin:0;background:var(--bg);color:var(--text);}
  header{background:#fff;border-bottom:1px solid #eee;padding:12px 16px;position:sticky;top:0;z-index:5}
  main{max-width:980px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin:10px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button{font:inherit}
  input{border:1px solid #ddd;border-radius:8px;padding:8px}
  .pill{display:inline-block;background:var(--pill);border-radius:999px;padding:4px 10px}
  .muted{color:var(--muted);font-size:12px}
  .big{font-size:22px;font-weight:800;text-align:center;margin:10px 0}
  .answer-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .ans{padding:16px;border-radius:12px;color:#fff;font-weight:800;text-align:center;cursor:pointer}
  .ans.disabled{opacity:.5;pointer-events:none}
  .P{background:#e74c3c}.E{background:#3498db}.I{background:#f1c40f;color:#222}.Ph{background:#2ecc71}
  .you{color:#007bff}.host{color:#d35400}.timer{font-weight:900;color:#d32f2f}
  .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;color:#fff}
  .btn-pink{background:var(--brand)} /* スタート（ピンク） */
  .btn-sec{background:#6c757d}.btn-warn{background:#ff9800}.btn-dgr{background:#dc3545}.btn-ok{background:#28a745}.btn-blue{background:#007bff}
  .ready{background:#e9fff5;border:1px solid #b6f2d6;border-radius:8px;padding:6px 10px}
  .c-red{background:#e74c3c;color:#fff}.c-blue{background:#3498db;color:#fff}.c-yellow{background:#ffca28;color:#222}.c-green{background:#2ecc71;color:#fff}.c-orange{background:#ff7f50;color:#222}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong>P.E.I.P. 早押しクイズ</strong>
      <span class="muted">｜最大5人｜先着<strong>1名</strong>のみ有効｜各問題5秒｜問題プールからランダム40問</span>
    </div>
    <div class="row muted">
      <span>状態:</span><span id="statePill" class="pill">-</span>
      <span>残り:</span><span id="timeLeft" class="pill timer">--</span>
      <span>順位:</span><span id="myRank" class="pill">--位</span>
    </div>
  </div>
</header>

<main>

  <!-- 参加 -->
  <section id="joinCard" class="card">
    <h3 style="margin:0 0 8px">① 参加登録</h3>
    <div class="row">
      <input id="nameInput" placeholder="名前（表示名）" style="min-width:180px;">
      <input id="commentInput" placeholder="一言（15文字まで）" maxlength="15" style="min-width:220px;">
      <label class="row" style="gap:6px"><input type="checkbox" id="spectatorCheck">観客として入る（閲覧のみ）</label>
      <button id="joinBtn" class="btn btn-blue">参加する</button>
    </div>
    <div class="muted" style="margin-top:6px">※ 最初に入室している人がホストに自動指名されます（ホストは途中で自動交代）。</div>
  </section>

  <!-- ルーム -->
  <section id="roomCard" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span>ルーム:</span><span id="roomId" class="pill">default</span>
        <span class="muted">受付:</span><span id="lobbyPill" class="pill">-</span>
        <span class="muted">残り枠:</span><span id="seatsLeft" class="pill">-</span>
        <span class="muted">ホスト:</span><span id="hostName" class="pill">-</span>
      </div>
      <!-- ホスト用ツール -->
      <div id="hostTools" class="row" style="display:none">
        <button id="toggleLobbyBtn" class="btn btn-warn">受付を締め切る</button>
        <button id="startRoundBtn" class="btn btn-pink" disabled>ラウンド開始</button>
        <button id="nextBtn" class="btn btn-sec" disabled>次の問題</button>
        <button id="endBtn" class="btn btn-dgr">終了</button>
        <button id="tieBtn" class="btn btn-ok" style="display:none">同点決勝</button>
      </div>
      <!-- 参加者用の簡易ボタン（任意で締切／退室） -->
      <div id="memberTools" class="row" style="display:none">
        <button id="memberCloseBtn" class="btn btn-warn">受付を締め切る</button>
        <button id="leaveBtn" class="btn btn-dgr">退室</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px;justify-content:space-between">
      <div><strong>参加者（最大5人）</strong></div>
      <label class="row ready" style="gap:6px">
        <input type="checkbox" id="readyCheck"> 準備OK
        <span class="muted">（準備OK <span id="readyCount">0</span> 名）</span>
      </label>
    </div>
    <div id="playersList" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
  </section>

  <!-- 問題 -->
  <section id="qCard" class="card" style="display:none">
    <div id="qIdx" class="muted"></div>
    <div id="qText" class="big">問題</div>
    <div id="buzzInfo" class="muted">ホストが「ラウンド開始」を押すと早押し受付が始まります。</div>
    <div class="answer-grid" style="margin-top:8px">
      <div class="ans P"  data-choice="P">きもち（P）</div>
      <div class="ans E"  data-choice="E">まわり（E）</div>
      <div class="ans I"  data-choice="I">できること（I）</div>
      <div class="ans Ph" data-choice="Ph">からだ＆病気（Ph）</div>
    </div>
  </section>

  <section class="card">
    <strong>遊び方：</strong>
    <ol style="margin:8px 0 0 16px">
      <li>全員が「参加する」で入室（最大5人）。参加者は <b>赤・青・黄・緑・オレンジ</b> の色割当。</li>
      <li>ホストが「ラウンド開始」→問題表示→<b>5秒</b>間の早押し受付（カウントダウン音あり）。</li>
      <li>先着<b>1名</b>のみ有効。<b>正解+2点／不正解-2点</b>。ホストが「次の問題」で進行。</li>
      <li>受付はホストが開放／締切を切替できます（参加者も任意で<strong>締切</strong>ボタンあり）。</li>
      <li>同点で終了した場合は「同点決勝」ボタンが出現します（該当者のみ早押し可）。</li>
      <li>ホストが抜けたら、最古参加者に自動でホスト権限が移ります。</li>
    </ol>
  </section>

  <section class="card">
    <div class="muted">
      ※P.E.I.P.は聖隷クリストファー大学の篠﨑良勝氏が介護過程教育の質向上のために作成した教材で、著作権は篠﨑良勝氏にあります。P.E.I.P.フレームワークで分類する場合は、必ずP.E.I.P.を学習した上で行ってください。
    </div>
  </section>
</main>

<!-- 音（同じフォルダに置く） -->
<audio id="sndCountdown" src="countdown.mp3" preload="auto"></audio>
<audio id="sndCorrect"   src="se_correct.mp3" preload="auto"></audio>
<audio id="sndWrong"     src="se_wrong.mp3"   preload="auto"></audio>
<audio id="sndStart"     src="start.mp3"      preload="auto"></audio>
<audio id="sndWarn"      src="keikoku.mp3"    preload="auto"></audio>

<!-- Firebase compat（シンプルに使えるCDN版） -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ==== Firebase 設定（peip-with5） ==== */
const firebaseConfig = {
  apiKey: "AIzaSyAkgy5cwaI-rEfR4L1t7TL2-vrWKGKY9HM",
  authDomain: "peip-with5.firebaseapp.com",
  projectId: "peip-with5",
  storageBucket: "peip-with5.firebasestorage.app",
  messagingSenderId: "609048243686",
  appId: "1:609048243686:web:a38452d1872d4ec28cba27",
  measurementId: "G-YCB8S47ENW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== 定数・要素 ===== */
const MAX_PLAYERS = 5, BUZZ_MS = 5000;
const roomId = "default";
const roomRef = db.collection("rooms").doc(roomId);
const playersRef = roomRef.collection("players");

const joinCard = document.getElementById("joinCard");
const roomCard = document.getElementById("roomCard");
const hostTools = document.getElementById("hostTools");
const memberTools = document.getElementById("memberTools");
const playersList = document.getElementById("playersList");
const startBtn = document.getElementById("startRoundBtn");
const nextBtn  = document.getElementById("nextBtn");
const endBtn   = document.getElementById("endBtn");
const tieBtn   = document.getElementById("tieBtn");
const toggleLobbyBtn = document.getElementById("toggleLobbyBtn");
const memberCloseBtn = document.getElementById("memberCloseBtn");
const readyCheck = document.getElementById("readyCheck");
const readyCountEl = document.getElementById("readyCount");
const lobbyPill = document.getElementById("lobbyPill");
const seatsLeftEl = document.getElementById("seatsLeft");
const hostNameEl = document.getElementById("hostName");
const statePill = document.getElementById("statePill");
const timeLeftEl = document.getElementById("timeLeft");
const myRankEl = document.getElementById("myRank");
const qCard = document.getElementById("qCard");
const qText = document.getElementById("qText");
const qIdxEl= document.getElementById("qIdx");
const buzzInfo = document.getElementById("buzzInfo");
const ansButtons = Array.from(document.querySelectorAll(".ans"));
const sndCountdown = document.getElementById("sndCountdown");
const sndCorrect   = document.getElementById("sndCorrect");
const sndWrong     = document.getElementById("sndWrong");
const sndStart     = document.getElementById("sndStart");
const sndWarn      = document.getElementById("sndWarn");

/* ===== 自分の情報 ===== */
function uid(){ const k="peip-uid"; let v=localStorage.getItem(k); if(!v){ v="u_"+Math.random().toString(36).slice(2,10); localStorage.setItem(k,v);} return v; }
let me = { id:uid(), name:"", comment:"", spectator:false, isHost:false, color:"", ready:false };

/* ===== 参加色 ===== */
const colorOrder=["c-red","c-blue","c-yellow","c-green","c-orange"];
function nextColor(used){ for(const c of colorOrder){ if(!used.includes(c)) return c; } return "c-orange"; }

/* ===== 問題プール（→ ホストがランダム40問に整形して deck として保存） ===== */
const questionsPool = [
  { text: "子どもに会いたいと思っているか？", answer: "P" },{ text: "洗濯物にしわはないか？", answer: "E" },
  { text: "トイレで立位をとることができるか？", answer: "I" },{ text: "便秘はないか？", answer: "Ph" },
  { text: "朝食の飲み物にこだわりはあるか？", answer: "P" },{ text: "トイレの手すりにぐらつきはないか？", answer: "E" },
  { text: "歯磨きは一人で行えているか？", answer: "I" },{ text: "むせこみはないか？", answer: "Ph" },
  { text: "デイサービスを楽しみにしているか？", answer: "P" },{ text: "冷蔵庫に消費期限が過ぎた食品はないか？", answer: "E" },
  { text: "歩行器を使えば自立歩行はできるか？", answer: "I" },{ text: "足にむくみはないか？", answer: "Ph" },
  { text: "好きな音楽（曲・歌手）は何か？", answer: "P" },{ text: "洗面所の床は濡れていないか？", answer: "E" },
  { text: "トイレのボタンを操作することはできるか？", answer: "I" },{ text: "肌は乾燥していないか？", answer: "Ph" },
  { text: "暮らしで困っていることはないか？", answer: "P" },{ text: "息苦しさや胸の圧迫感はないか？", answer: "Ph" },
  { text: "着替えは介助なしでできるか？", answer: "I" },{ text: "食欲や水分摂取量はどうか？", answer: "Ph" },
  { text: "昔していた仕事は何か？", answer: "P" },{ text: "使用している福祉用具は何か？", answer: "E" },
  { text: "電話をかけることができるか？", answer: "I" },{ text: "視力はどの程度か？", answer: "Ph" },
  { text: "食べたいものはあるか？", answer: "P" },{ text: "自宅で10ミリ以上の段差はないか？", answer: "E" },
  { text: "お茶を入れて飲むことはできるか？", answer: "I" },{ text: "夜間の睡眠状況はどうか？", answer: "Ph" },
  { text: "習慣となっていることは何か？", answer: "P" },{ text: "利用している介護サービスは何か？", answer: "E" },
  { text: "体操で体を動かせているか？", answer: "I" },{ text: "ふらつきはないか？", answer: "Ph" },
  { text: "趣味を再開したい思いはあるか？", answer: "P" },{ text: "居室の温度・室温は？", answer: "E" },
  { text: "食事の準備は一人でできるか？", answer: "I" },{ text: "腰痛など体の痛みはないか？", answer: "Ph" },
  { text: "調味料にこだわりはあるか？", answer: "P" },{ text: "薬の管理で手伝ってほしいことはあるか？", answer: "P" },
  { text: "薬の管理は一人で行えているか？", answer: "I" },{ text: "まぶたに目やにはついていないか？", answer: "Ph" },
  { text: "どのような環境で寝たい思っているか？", answer: "P" },{ text: "コールのボタンは鳴るか？", answer: "E" },
  { text: "座位をとることはできているか？", answer: "I" },{ text: "巻き爪はないか？", answer: "Ph" },
  { text: "何をしている時が幸せを感じる時か？", answer: "P" },{ text: "現在、交流のある人は誰か？", answer: "E" },
  { text: "買い物リストを書くことはできるか？", answer: "I" },{ text: "夜間に不眠はないか？", answer: "Ph" },
  { text: "お気に入りの服はあるか？", answer: "P" },{ text: "居室の換気状況は？", answer: "E" }
];

/* ===== ルーム初期化 ===== */
async function ensureRoom(){
  const snap = await roomRef.get();
  if(!snap.exists){
    await roomRef.set({
      hostId: "", lobbyOpen:true, state:"lobby",
      deck:[], currentIndex:0,
      buzzedBy:null, answerChoice:null, openUntilMs:0,
      lastResult:null, resultKey:"",
      mode:"normal", tieIds:[],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}
ensureRoom();

/* ===== 参加／退室 ===== */
document.getElementById("joinBtn").onclick = async ()=>{
  const name = (document.getElementById("nameInput").value||"").trim();
  const comment = (document.getElementById("commentInput").value||"").trim().slice(0,15);
  const spectator = document.getElementById("spectatorCheck").checked;
  if(!name){
    try{ sndWarn.currentTime=0; sndWarn.play(); }catch(_){}
    alert("名前を入力してください");
    return;
  }
  const cur = await playersRef.get();
  if(!spectator && cur.size>=MAX_PLAYERS){ alert("参加可能人数（5人）に達しています"); return; }

  // 色配布
  let color=""; if(!spectator){ const used=[]; cur.forEach(d=>{ const c=d.data().color; if(c) used.push(c); }); color=nextColor(used); }

  me = { ...me, name, comment, spectator, color };
  joinCard.style.display="none"; roomCard.style.display="block";
  try{ sndStart.currentTime=0; sndStart.play(); }catch(_){}

  if(!spectator){
    await playersRef.doc(me.id).set({
      name, comment, score:0, color, ready:false,
      joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
  }
  // ホスト未設定なら自分をホストへ
  const r = (await roomRef.get()).data();
  if(!r.hostId){ await roomRef.update({ hostId: me.id }); }
};

document.getElementById("leaveBtn").onclick = async ()=>{
  if(!confirm("退室しますか？")) return;
  if(!me.spectator){ try{ await playersRef.doc(me.id).delete(); }catch(_){} }
  joinCard.style.display="block"; roomCard.style.display="none"; qCard.style.display="none";
};

/* ===== 心拍（途中退出の自動削除）＆ホスト自動交代 ===== */
let hbTimer=null, cleanTimer=null;
function startHeartbeat(){
  if(me.spectator) return;
  if(hbTimer) clearInterval(hbTimer);
  hbTimer = setInterval(async ()=>{
    try{ await playersRef.doc(me.id).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() },{merge:true}); }catch(_){}
  }, 20000);

  if(cleanTimer) clearInterval(cleanTimer);
  cleanTimer = setInterval(async ()=>{
    const now=Date.now(); const snap=await playersRef.get();
    let ids=[]; snap.forEach(d=>ids.push(d.id));
    snap.forEach(async d=>{
      const ts= d.data().lastSeen?.toMillis?.() || 0;
      if(now-ts>60000){ try{ await playersRef.doc(d.id).delete(); }catch(_){} }
    });
    // ホストがいなければ最古参加者へ
    const room = (await roomRef.get()).data();
    if(!room) return;
    const hostIn = ids.includes(room.hostId);
    if(!hostIn){
      const newer = await playersRef.orderBy("joinedAt","asc").limit(1).get();
      if(!newer.empty){
        const candidate = newer.docs[0].id;
        // 競合を避けるため、候補本人だけが更新
        if(candidate === me.id){ await roomRef.update({ hostId: candidate }); }
      }
    }
  }, 30000);
}
window.addEventListener("beforeunload", async ()=>{
  if(!me.spectator){ try{ await playersRef.doc(me.id).delete(); }catch(_){} }
});

/* ===== プレイヤー購読（順位・準備OK・残り枠） ===== */
let playersCache=[];
playersRef.orderBy("joinedAt","asc").onSnapshot(snap=>{
  const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() })); playersCache=arr;

  // 表示切替
  if(arr.find(p=>p.id===me.id) || me.spectator){ joinCard.style.display="none"; roomCard.style.display="block"; }

  // 残り枠
  seatsLeftEl.textContent = Math.max(0, MAX_PLAYERS - arr.length) + "枠";

  // 順位（スコア降順）
  const sorted = [...arr].sort((a,b)=> (b.score||0)-(a.score||0) );
  const myIndex = sorted.findIndex(p=>p.id===me.id);
  myRankEl.textContent = (myIndex>=0) ? `${myIndex+1}位` : (me.spectator? "観客" : "--位");

  // 準備OK
  const readyCount = arr.filter(p=>p.ready).length;
  readyCountEl.textContent = readyCount;
  // ホストの開始ボタン有効条件（観客除く参加者2名以上がready）
  const participants = arr.length;
  startBtn.disabled = !(readyCount>=Math.min(2, participants));

  // 一覧
  playersList.innerHTML = arr.map(p=>{
    const you = p.id===me.id ? '<span class="you">[you]</span>' : '';
    const host= (p.id===currentRoom.hostId) ? '<span class="host">[host]</span>' : '';
    const rdy = p.ready ? '✅' : '□';
    const tip = (p.comment||"") ? ` title="${esc(p.comment)}"` : "";
    return `<div class="pill ${esc(p.color||'')}"${tip}>${rdy} ${esc(p.name)} ${you} ${host} <b>${Number(p.score||0)}pt</b></div>`;
  }).join("");

  // 自分のready操作
  readyCheck.onchange = async ()=>{
    me.ready = !!readyCheck.checked;
    if(!me.spectator){ await playersRef.doc(me.id).set({ ready: me.ready },{merge:true}); }
  };
  // 自分の現在値を反映
  const meDoc = arr.find(x=>x.id===me.id);
  if(meDoc){ readyCheck.checked = !!meDoc.ready; }

  startHeartbeat();
});

/* ===== ルーム購読（状態/UI/音） ===== */
let currentRoom = {};
let countdownTimer=null, lastCountdownKey="", lastResultKey="";
roomRef.onSnapshot(async snap=>{
  if(!snap.exists) return;
  const r = currentRoom = snap.data();

  // ホストかどうかでツール表示
  me.isHost = (r.hostId === me.id);
  hostTools.style.display = me.isHost ? "flex" : "none";
  memberTools.style.display = (!me.isHost && !me.spectator) ? "flex" : "none";

  // ラベル
  statePill.textContent = r.state;
  lobbyPill.textContent = r.lobbyOpen ? "開放中" : "締切";
  const hostDoc = playersCache.find(p=>p.id===r.hostId);
  hostNameEl.textContent = hostDoc ? hostDoc.name : "(未設定)";

  // デッキが空 → ホストがランダム40問作成
  if(me.isHost && (!r.deck || !Array.isArray(r.deck) || r.deck.length===0)){
    const idxs = [...Array(questionsPool.length).keys()];
    idxs.sort(()=>Math.random()-0.5);
    await roomRef.update({ deck: idxs.slice(0, Math.min(40, idxs.length)), currentIndex:0 });
    return;
  }

  // 同点決勝ボタンの出し分け（state: ended かつ 同点）
  if(me.isHost){
    const scores = playersCache.map(p=>p.score||0);
    const max = Math.max(0,...scores);
    const topers = playersCache.filter(p=> (p.score||0)===max);
    tieBtn.style.display = (r.state==="ended" && topers.length>=2) ? "inline-block" : "none";
  } else {
    tieBtn.style.display = "none";
  }

  // 問題表示
  const deck = r.deck || [];
  const idx  = Math.max(0, Math.min(deck.length>0?deck.length-1:questionsPool.length-1, r.currentIndex||0));
  const q    = deck.length>0 ? questionsPool[ deck[idx] ] : questionsPool[idx];
  qIdxEl.textContent = `問題 ${idx+1} / ${Math.max(40, deck.length||40)}`;
  qText.textContent  = "「" + q.text + "」";

  if(r.state==="lobby" || r.state==="ended"){ qCard.style.display="none"; nextBtn.disabled=true; }
  else{ qCard.style.display="block"; nextBtn.disabled = !me.isHost; }

  if(r.state==="open"){
    const key = `${r.currentIndex}|${r.openUntilMs}`;
    if(key!==lastCountdownKey){ lastCountdownKey=key; try{ sndCountdown.currentTime=0; sndCountdown.play(); }catch(_){} }
    buzzInfo.textContent = r.mode==="tiebreak" ? "【同点決勝】先に押した1名のみ判定（該当者のみ参加可）" : "早押し受付中！（5秒）先に押した1名だけ有効です。";
    setAnswersDisabled( me.spectator || (r.mode==="tiebreak" && r.tieIds && !r.tieIds.includes(me.id)) );
    startCountdown(r.openUntilMs||0);
  }else if(r.state==="locked"){
    setAnswersDisabled(true);
    if(r.resultKey && r.resultKey!==lastResultKey){
      lastResultKey=r.resultKey;
      if(r.lastResult==="correct"){ try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch(_){ } }
      else if(r.lastResult==="wrong"){ try{ sndWrong.currentTime=0; sndWrong.play(); }catch(_){ } }
    }
    if(r.buzzedBy){
      const p = playersCache.find(x=>x.id===r.buzzedBy);
      buzzInfo.textContent = `【${p?p.name:("ID:"+r.buzzedBy)}】が先に押しました。判定済み／次の問題へ`;
    }else{
      buzzInfo.textContent = "時間切れ。次の問題へ。";
    }
  }else{
    buzzInfo.textContent = "ホストが「ラウンド開始」を押すと早押し受付が始まります。";
    setAnswersDisabled(true);
  }
});

function startCountdown(untilMs){
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = setInterval(async ()=>{
    const ms = Math.max(0, untilMs - Date.now());
    timeLeftEl.textContent = (ms/1000).toFixed(1)+"s";
    if(ms<=0){
      clearInterval(countdownTimer); timeLeftEl.textContent="0.0s";
      if(me.isHost){
        const r=(await roomRef.get()).data();
        if(r.state==="open"){ await roomRef.update({ state:"locked" }); }
      }
    }
  },100);
}
function setAnswersDisabled(flag){
  ansButtons.forEach(b=>{ if(flag) b.classList.add("disabled"); else b.classList.remove("disabled"); });
}

/* ===== 回答（先着1名） ===== */
ansButtons.forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    if(me.spectator) return;
    const choice = btn.dataset.choice;
    let winner=false;
    await db.runTransaction(async tx=>{
      const doc = await tx.get(roomRef);
      if(!doc.exists) return;
      const r = doc.data();
      if(r.state!=="open") return;
      if((r.openUntilMs||0) < Date.now()) return;
      if(r.mode==="tiebreak" && r.tieIds && !r.tieIds.includes(me.id)) return; // 同点決勝は該当者のみ
      if(r.buzzedBy) return;
      winner=true;
      tx.update(roomRef,{ state:"locked", buzzedBy: me.id, answerChoice: choice });
    });
    if(me.isHost && winner){
      const r=(await roomRef.get()).data();
      const deck=r.deck||[]; const idx=Math.max(0, Math.min(deck.length>0?deck.length-1:questionsPool.length-1, r.currentIndex||0));
      const q = deck.length>0 ? questionsPool[ deck[idx] ] : questionsPool[idx];
      const ok = (r.answerChoice===q.answer);
      const delta = ok ? +2 : -2;
      const nextKey = `${Date.now()}_${ok?'C':'W'}`;
      await Promise.all([
        playersRef.doc(r.buzzedBy).set({ score: firebase.firestore.FieldValue.increment(delta) },{merge:true}),
        roomRef.update({ lastResult: ok?"correct":"wrong", resultKey: nextKey })
      ]);
      // 同点決勝が解決したら自動終了（単独トップになった時）
      if(r.mode==="tiebreak"){
        const snap = await playersRef.get(); const arr=[]; snap.forEach(d=>arr.push(d.data()));
        const scores = arr.map(p=>p.score||0); const max=Math.max(...scores);
        const topers = arr.filter(p=>(p.score||0)===max);
        if(topers.length===1){ await roomRef.update({ state:"ended", mode:"normal", tieIds:[] }); }
      }
    }
  });
});

/* ===== ホスト操作 ===== */
startBtn.onclick = async ()=>{
  if(!me.isHost) return;
  try{ sndStart.currentTime=0; sndStart.play(); }catch(_){}
  await roomRef.update({
    state:"open", buzzedBy:null, answerChoice:null, lastResult:null, resultKey:"",
    openUntilMs: Date.now()+BUZZ_MS
  });
};
nextBtn.onclick = async ()=>{
  if(!me.isHost) return;
  const r=(await roomRef.get()).data()||{};
  const deck=r.deck||[]; const total= deck.length>0 ? deck.length : 40;
  const next=((r.currentIndex||0)+1)%total;
  await roomRef.update({
    state:"open", buzzedBy:null, answerChoice:null, lastResult:null, resultKey:"",
    currentIndex: next, openUntilMs: Date.now()+BUZZ_MS
  });
};
endBtn.onclick = async ()=>{ if(me.isHost){ await roomRef.update({ state:"ended" }); } };

toggleLobbyBtn.onclick = async ()=>{
  const r=(await roomRef.get()).data(); if(!r) return;
  const v = !r.lobbyOpen;
  try{ if(!v){ sndStart.currentTime=0; sndStart.play(); } }catch(_){}
  await roomRef.update({ lobbyOpen: v });
  toggleLobbyBtn.textContent = v ? "受付を締め切る" : "受付を開放する";
};
memberCloseBtn.onclick = async ()=>{
  const r=(await roomRef.get()).data(); if(!r) return;
  if(r.lobbyOpen){ try{ sndStart.currentTime=0; sndStart.play(); }catch(_){ } await roomRef.update({ lobbyOpen:false }); }
};

tieBtn.onclick = async ()=>{
  if(!me.isHost) return;
  // 同点者を抽出して同点決勝モードへ
  const snap=await playersRef.get(); const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  const max=Math.max(...arr.map(p=>p.score||0));
  const tieIds = arr.filter(p=>(p.score||0)===max).map(p=>p.id);
  if(tieIds.length<2){ alert("同点者が2名以上のときに使います"); return; }
  await roomRef.update({ mode:"tiebreak", tieIds, state:"open", buzzedBy:null, answerChoice:null, lastResult:null, resultKey:"", openUntilMs: Date.now()+BUZZ_MS, currentIndex:0 });
  alert("同点決勝を開始します（該当者のみ早押し可）");
};

/* ===== エスケープ ===== */
function esc(s){return String(s||"").replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','=':'&#x3D;','`':'&#x60;'}[c]))}

/* 初期表示 */
document.getElementById("roomId").textContent = roomId;
</script>
</body>
</html>
